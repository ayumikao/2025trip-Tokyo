<!doctype html>
<html lang="zh-Hant"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>9/20 互動地圖（含車Map Code）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>html,body{height:100%;margin:0}#map{height:100%}.legend{position:fixed;top:10px;left:10px;background:#fff;border-radius:8px;border:1px solid #ccc;padding:8px 10px;line-height:1.6;font-size:13px;box-shadow:0 6px 18px rgba(0,0,0,.15)}</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CSV='timeline-2025-09-20_v5.csv';
function parseCSV(t){const r=[];let row=[],f='',q=false;for(let i=0;i<t.length;i++){const c=t[i],n=t[i+1];if(c=='"'){if(q&&n=='"'){f+='"';i++;}else q=!q;}else if(c==','&&!q){row.push(f);f='';}else if((c=='\n'||c=='\r')&&!q){if(f!==''||row.length){row.push(f);r.push(row);row=[];f='';}if(c=='\r'&&n=='\n')i++;}else f+=c;}if(f!==''||row.length){row.push(f);r.push(row);}const h=r.shift().map(x=>x.replace(/^\uFEFF/,'').trim());return r.map(cols=>{const o={};h.forEach((k,i)=>o[k]=cols[i]||'');return o;});}
function coordFrom(url){try{const u=new URL(url);if(u.searchParams.get('query')){const [la,lo]=u.searchParams.get('query').split(',').map(Number);return [la,lo];}}catch(e){}return null;}
function norm(t){return (t||'').replace(/^[0-9①-⑳\.\s]+/,'').trim();}
fetch(CSV).then(x=>x.text()).then(t=>{
  const rows=parseCSV(t).filter(r=>norm(r['地點 / 活動']));
  const map=L.map('map',{zoomControl:true}).setView([35.318,139.53],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  const base=L.layerGroup().addTo(map), optional=L.layerGroup().addTo(map), toilets=L.layerGroup().addTo(map);
  rows.forEach((r,i)=>{
    const title=norm(r['地點 / 活動']); const link=r['📍 景點連結']; const car=r['🚙車Map Code']||r['🚙車MapCode']||''; const wc=r['🚻 廁所']||''; const type=(r['類別']||'').trim();
    const xy=link?coordFrom(link):null; if(!xy) return;
    const mk=L.marker(xy);
    const html=`<b>${title}</b>${car?'<br>🚙 車Map Code：<code>'+car+'</code>':''}${wc?'<br>🚻 '+wc:''}${type?'<br>類別：'+type:''}${link?'<br><a href="${link}" target="_blank">📍 Google 地圖</a>':''}`;
    mk.bindPopup(html);
    mk.on('click',()=>{try{parent.postMessage({type:'marker-click',place:title},'*');}catch(e){}});
    if(type.includes('可有可無')) mk.addTo(optional); else mk.addTo(base);
    if(wc){ L.circleMarker(xy,{radius:5,color:'#2ecc71'}).addTo(toilets); }
  });
  L.control.layers(null,{"主行程/推薦":base,"可有可無":optional,"🚻 廁所":toilets}).addTo(map);
});
</script>
</body></html>
