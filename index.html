<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>2025 東京近郊旅遊｜9/20 鎌倉</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0f1a22; --panel:#121f29; --muted:#9fb3c5; --txt:#e7f0f7;
    --pill:#1a2733; --accent:#7aa7ff; --orange:#ffc36e;
    --brand:#a3d3ff;
  }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,"Apple Color Emoji","Segoe UI Emoji";}
  .wrap{max-width:1080px;margin:0 auto;padding:12px 14px 32px;}
  h1{margin:8px 2px 10px;font-size:28px;letter-spacing:.05em}
  .sub{color:var(--muted);margin:4px 2px 12px;font-size:14px}
  /* date tabs (保持簡單、不大改你的原樣式) */
  .tabs{display:flex;gap:14px;overflow-x:auto;padding:4px 2px 8px}
  .tab{flex:0 0 auto;border:2px solid rgba(122,167,255,.4);border-radius:28px;padding:10px 18px;text-align:center}
  .tab .d{font-weight:700;font-size:18px}
  .tab .p{font-size:12px;opacity:.9;margin-top:2px}
  .tab.active{box-shadow:0 0 0 3px rgba(122,167,255,.25) inset}
  .sticky-head{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,26,34,.7));backdrop-filter:saturate(130%) blur(6px)}
  /* map box */
  .card{background:var(--panel);border-radius:14px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.25);margin:10px 0 18px}
  #map{height:420px;border-radius:10px}
  /* layer panel inside map (top-right) */
  .layerCtl{position:absolute;right:14px;top:14px;z-index:400;background:rgba(18,31,41,.92);border-radius:12px;padding:10px 12px}
  .layerCtl label{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:14px}
  /* vertical locate/follow buttons inside map (right side, vertical) */
  .vBtns{position:absolute;right:14px;top:170px;z-index:401;display:flex;flex-direction:column;gap:10px}
  .vBtn{background:rgba(18,31,41,.95);border-radius:14px;padding:8px 6px;text-align:center;line-height:1.05;border:1px solid rgba(255,255,255,.1);cursor:pointer}
  .vBtn span{display:block;white-space:pre;font-weight:700;letter-spacing:.25em}
  .vBtn:active{transform:scale(.98)}
  /* photo wall */
  .photos{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .ph{aspect-ratio:16/10;background:#09131a;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#6b8297;border:1px dashed #243746}
  .ph img{width:100%;height:100%;object-fit:cover;border-radius:10px}
  /* timeline */
  .tl{width:100%;border-collapse:separate;border-spacing:0 10px}
  .tl thead th{position:sticky;top:62px;background:var(--bg);z-index:3;padding:10px 8px;color:#c8d9e6;border-bottom:1px solid #264056}
  .row{background:var(--panel);border-radius:12px;overflow:hidden}
  .cell{padding:12px 14px;vertical-align:top}
  .time{width:90px;white-space:nowrap}
  .place{}
  .cat{width:70px}
  .code{width:150px}
  .noteBar{grid-column:1/-1;background:#0b1620;border-top:1px solid #1d3345;padding:10px 14px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#172635;border-radius:28px;padding:6px 12px}
  .pill.orange{background:#2a2318;color:#ffd59b;border:1px solid #7b5b22}
  .gmap{color:#7ab6ff;text-decoration:none;border-bottom:2px solid #2b4c6b}
  .muted{color:#8ea3b5}
  /* Leaflet z-fix so map never covers tabs */
  .leaflet-container{z-index:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="sticky-head">
    <h1>2025 東京近郊旅遊｜9/20 鎌倉</h1>
    <div class="sub">澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</div>
    <div class="tabs">
      <div class="tab active"><div class="d">09/20</div><div class="p">鎌倉</div></div>
      <div class="tab"><div class="d">09/21</div><div class="p">箱根</div></div>
      <div class="tab"><div class="d">09/22</div><div class="p">熱海</div></div>
      <div class="tab"><div class="d">09/23</div><div class="p">河口湖</div></div>
    </div>
  </div>

  <div class="card" style="position:relative;">
    <div id="map"></div>
    <div class="layerCtl" id="layerCtl">
      <label><input type="checkbox" id="chkMain" checked> 主行程/精華或近似</label>
      <label><input type="checkbox" id="chkOpt" checked> 可有可無</label>
      <label><input type="checkbox" id="chkToilet" checked> 廁所</label>
    </div>
    <div class="vBtns">
      <div class="vBtn" id="btnLocate"><span>我\n在\n這</span></div>
      <div class="vBtn" id="btnFollow"><span>跟\n隨\n我</span></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:6px 4px 10px;">照片牆（點任一標記顯示相簿）</h3>
    <div id="photoWall" class="photos">
      <div class="ph" id="phEmpty">暫無照片</div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:6px 4px 4px;">時間軸（9/20 +15 分鐘緩衝版）</h3>
    <div class="muted" style="margin:2px 4px 10px;font-size:12px">
      本頁讀取：timeline-2025-09-20_v6.csv、photos-2025-09-20-mapped.csv、coords-override-2025-09-20.json
    </div>
    <table class="tl" id="tl">
      <thead>
        <tr>
          <th class="time">時間</th>
          <th>地點 / 活動</th>
          <th class="cat">類別</th>
          <th class="code">車Map Code</th>
        </tr>
      </thead>
      <tbody id="tlBody"></tbody>
    </table>
  </div>
</div>

<script>
const FILES = {
  timeline: 'timeline-2025-09-20_v6.csv',
  photos: 'photos-2025-09-20-mapped.csv',
  coords: 'coords-override-2025-09-20.json'
};
let followUser = false, userMarker=null, userWatchId=null;

const map = L.map('map',{ zoomControl:true }).setView([35.31,139.54], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 19, attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

const gMain = L.layerGroup().addTo(map);
const gOpt = L.layerGroup().addTo(map);
const gToilet = L.layerGroup().addTo(map);
let mainLine = null;

// checkbox show/hide
document.getElementById('chkMain').addEventListener('change',e=>{ if(e.target.checked){map.addLayer(gMain);}else{map.removeLayer(gMain);} if(mainLine){ e.target.checked? map.addLayer(mainLine): map.removeLayer(mainLine);} });
document.getElementById('chkOpt').addEventListener('change',e=>{ e.target.checked? map.addLayer(gOpt): map.removeLayer(gOpt); });
document.getElementById('chkToilet').addEventListener('change',e=>{ e.target.checked? map.addLayer(gToilet): map.removeLayer(gToilet); });

// locate buttons
document.getElementById('btnLocate').onclick = ()=>{
  if(!navigator.geolocation){ alert('此裝置不支援定位'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const latlng = [pos.coords.latitude, pos.coords.longitude];
    if(!userMarker){
      userMarker = L.marker(latlng,{title:'我在這'}).addTo(map);
    }else{
      userMarker.setLatLng(latlng);
    }
    map.setView(latlng, 15);
  }, err=>alert('定位失敗'));
};
document.getElementById('btnFollow').onclick = ()=>{
  if(!navigator.geolocation){ alert('此裝置不支援定位'); return; }
  followUser = !followUser;
  // visual feedback
  document.getElementById('btnFollow').style.outline = followUser? '2px solid #7aa7ff' : 'none';
  if(followUser){
    userWatchId = navigator.geolocation.watchPosition(pos=>{
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      if(!userMarker){ userMarker = L.marker(latlng,{title:'我在這'}).addTo(map); }
      else userMarker.setLatLng(latlng);
      map.setView(latlng, 16);
    });
  }else if(userWatchId){
    navigator.geolocation.clearWatch(userWatchId);
    userWatchId=null;
  }
};

// utilities
function hEscape(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function createMapCodePill(code){ if(!code) return ''; return `<span class="pill orange">🚗&nbsp;${hEscape(code)}</span>`; }

// load coords then csvs
let COORDS={}, PHOTOS_MAP={}; // name -> [ [url,caption], ... ]
fetch(FILES.coords).then(r=>r.json()).then(json=>{ COORDS=json; loadPhotos(); }).catch(()=>{ COORDS={}; loadPhotos(); });

function loadPhotos(){
  Papa.parse(FILES.photos,{
    download:true, header:true, skipEmptyLines:true,
    complete: res => {
      // expect columns: place/name, url, caption(optional)
      res.data.forEach(row=>{
        const name = (row.place||row.name||row['地點']||row['地點/活動']||'').trim();
        const url = row.url || row.URL || row['url'];
        if(!name || !url) return;
        if(!PHOTOS_MAP[name]) PHOTOS_MAP[name]=[];
        PHOTOS_MAP[name].push([url, row.caption||'']);
      });
      loadTimeline();
    },
    error: _ => loadTimeline()
  });
}

function loadTimeline(){
  Papa.parse(FILES.timeline,{
    download:true, header:true, skipEmptyLines:true,
    complete: res => {
      const rows = res.data;
      // detect header keys
      function keyLike(keys){ for(const k of keys){ if(k in rows[0]) return k; } return null; }
      const kTime = keyLike(['時間','time','Time']);
      const kPlace= keyLike(['地點/活動','地點','活動','place','name']);
      const kNote = keyLike(['備註','備註 ','note','Note']);
      const kCat  = keyLike(['類別','分類','category']);
      const kCode = keyLike(['車Map Code','車MapCode','Map Code','mapcode','map code']);
      const kGmap = keyLike(['Google地圖','Google 地圖','Google Map','Google map','google','地圖']);

      const mainPoints=[];
      let bounds = [];
      rows.forEach((r,idx)=>{
        const place = (r[kPlace]||'').trim();
        if(!place) return;
        const cat = (r[kCat]||'').trim();
        const ll = COORDS[place];
        // timeline
        const tr = document.createElement('tr'); tr.className='row';
        function td(cls, html){ const td=document.createElement('td'); td.className='cell '+(cls||''); td.innerHTML=html; return td; }
        const timeTxt = hEscape(r[kTime]||'');
        const timeHtml = timeTxt.replace(/-/,'<br>').replace('：',':').replace('：',' : ');
        tr.appendChild(td('time', timeHtml));
        let gmapLink=''; if(r[kGmap]) gmapLink = `<div style="margin-top:6px;"><a class="gmap" href="${hEscape(r[kGmap])}" target="_blank">📍 Google 地圖</a></div>`;
        tr.appendChild(td('place', `<div style="font-weight:700">${hEscape(place)}</div>${gmapLink}`));
        tr.appendChild(td('cat', hEscape(cat)));
        tr.appendChild(td('code', createMapCodePill(r[kCode])));
        document.getElementById('tlBody').appendChild(tr);
        // note bar
        if(r[kNote]){
          const nr = document.createElement('tr');
          const nd = document.createElement('td'); nd.className='noteBar'; nd.colSpan=4; nd.textContent='備註： '+(r[kNote]);
          nr.appendChild(nd); document.getElementById('tlBody').appendChild(nr);
        }
        // map
        if(ll && Array.isArray(ll)){
          const m = L.marker(ll,{ title:place});
          let group = gMain;
          if(cat.includes('廁所')) group=gToilet; else if(cat.includes('可有可無')) group=gOpt;
          m.addTo(group);
          const codeHtml = createMapCodePill(r[kCode]);
          const note = r[kNote]? `<div class="muted" style="margin-top:6px">${hEscape(r[kNote])}</div>`:'';
          const gLink = r[kGmap]? `<div style="margin-top:8px"><a class="gmap" href="${hEscape(r[kGmap])}" target="_blank">📍 Google 地圖</a></div>`:'';
          m.bindPopup(`<div style="font-size:16px;font-weight:800;margin-bottom:6px">${hEscape(place)}</div>${codeHtml}${note}${gLink}`,{autoPan:true});
          // photo wall hook
          m.on('click',()=>showPhotos(place));
          bounds.push(ll);
          if(group===gMain) mainPoints.push(ll);
        }
      });
      if(bounds.length){ map.fitBounds(bounds,{ padding:[20,20]}); }
      if(mainPoints.length>1){
        mainLine = L.polyline(mainPoints,{ color:'#4aa3ff', weight:4, opacity:0.8 }).addTo(map);
      }
    }
  });
}

function showPhotos(place){
  const wall = document.getElementById('photoWall');
  wall.innerHTML='';
  const arr = PHOTOS_MAP[place]||[];
  if(!arr.length){
    wall.innerHTML = '<div class="ph">暫無照片</div>';
    return;
  }
  arr.forEach(([url,cap])=>{
    const div = document.createElement('div'); div.className='ph';
    const img = new Image(); img.src=url; img.alt=cap||place;
    img.onload=()=>{ div.innerHTML=''; div.appendChild(img); };
    img.onerror=()=>{ div.textContent='載入失敗'; };
    wall.appendChild(div);
  });
}
</script>
</body>
</html>
