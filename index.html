<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 æ±äº¬è¿‘éƒŠæ—…</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0b1520; --panel:#111b26; --muted:#8aa0b8; --text:#e9f0f8;
  --brand:#1e68ff; --pill:#2b3c4f; --accent:#ffbf69; --border:#203042;
  --success:#1fa38d;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",PingFangTC,"Noto Sans TC",sans-serif;line-height:1.55}
a{color:#7ab7ff;text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:16px}

#topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(11,21,32,.96),rgba(11,21,32,.88) 80%,rgba(11,21,32,0));backdrop-filter:blur(6px);padding:10px 0 6px;border-bottom:1px solid var(--border)}
h1{margin:0 0 8px;font-size:28px;letter-spacing:.04em}
.route{color:var(--muted);font-size:15px;margin-bottom:10px}

.tabs{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:6px}
.tab{display:flex;flex-direction:column;align-items:center;justify-content:center;
  width:108px;height:64px;border-radius:30px;border:2px solid #2f3f53;background:#0e1a26;
  color:#dfe9f5;box-shadow:inset 0 0 0 2px rgba(255,255,255,.03)}
.tab small{opacity:.8;font-size:12px;margin-top:2px}
.tab.active{background:#122335;border-color:#39506b;box-shadow:0 4px 18px rgba(0,0,0,.28), inset 0 0 0 2px rgba(71,130,255,.15)}

.section{background:var(--panel);border:1px solid var(--border);border-radius:14px;margin:14px 0;overflow:hidden}
.section h2{font-size:16px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border);color:#dbe7f4}
.section .sub{color:var(--muted);font-size:12px;margin-left:8px}

#mapWrap{position:relative}
#map{height:60vh;min-height:360px}
.fullscreen-btn{position:absolute;top:12px;left:12px;z-index:12;background:#0f2238;color:#d8e6f7;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.layerbox{position:absolute;top:12px;right:12px;z-index:12;background:#0d1a27cc;border:1px solid var(--border);border-radius:14px;padding:12px 14px;min-width:190px}
.layerbox label{display:flex;align-items:center;gap:8px;margin:6px 0}
.layerbox input{width:18px;height:18px}

.locateStack{position:absolute;right:12px;bottom:12px;z-index:12;display:flex;flex-direction:column;gap:8px}
.btn-ghost{border:1px solid var(--border);background:#0f1e2b;color:#eaf4ff;border-radius:14px;padding:10px 14px;display:flex;flex-direction:column;align-items:center;line-height:1}
.btn-ghost span{display:block}
.btn-ghost .em{font-size:18px;margin-bottom:4px}
.following{outline:2px solid var(--brand)}

.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #3d4f63;background:#192634;padding:6px 12px;border-radius:24px;font-weight:600}
.pill .car{filter:grayscale(.1)}
.pill .code{color:#1e1e1e;background:linear-gradient(180deg,#ffd7a1,#ffbb6a);padding:2px 6px;border-radius:10px}

.popup-title{font-weight:800;font-size:18px;margin-bottom:6px}
.popup-note{color:#c8d6e6;margin-top:8px}
.popup-note .muted{color:#9ab0c6}
.leaflet-popup-content{margin:10px 12px;}

#photos{padding:12px}
#photoWall{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px}
.card{aspect-ratio:4/3;background:#0c1824;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.card img{width:100%;height:100%;object-fit:cover}

#timeline .src{color:var(--muted);font-size:12px;padding:10px 14px 0}
.table{width:100%;border-collapse:separate;border-spacing:0 12px;padding:12px}
.tr{display:grid;grid-template-columns:84px 1.4fr 1fr 140px;gap:12px;background:#0e1a27;border:1px solid var(--border);border-radius:14px;padding:12px}
.thead{position:sticky;top:64px;z-index:10;background:linear-gradient(180deg,#0b1520,#0b1520);padding:10px 14px;border-bottom:1px solid var(--border)}
.thead .grid{display:grid;grid-template-columns:84px 1.4fr 1fr 140px;gap:12px;color:#cfe0f4}
.cell{white-space:pre-line}
.timeblock{white-space:pre-line;font-variant-numeric:tabular-nums}
.place{font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;margin-top:6px}
.badge .pin{font-size:14px}
.note{background:#0a1926;border:1px dashed #2a3a4e;border-radius:12px;padding:10px;margin-top:8px}

@media (min-width:820px){
  #layout{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  #photoWall{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>
<div id="topbar">
  <div class="container">
    <h1>2025 æ±äº¬è¿‘éƒŠæ—…</h1>
    <div class="route">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>
    <div class="tabs">
      <button class="tab active" aria-current="page"><div>09/20</div><small>éŒå€‰</small></button>
      <button class="tab"><div>09/21</div><small>ç®±æ ¹</small></button>
      <button class="tab"><div>09/22</div><small>ç†±æµ·</small></button>
      <button class="tab"><div>09/23</div><small>æ²³å£æ¹–</small></button>
    </div>
  </div>
</div>

<div class="container" id="layout">
  <div class="section" id="mapSection">
    <h2>äº’å‹•åœ°åœ– <span class="sub">ï¼ˆé»åœ–æ¨™çœ‹è³‡è¨Šï¼é»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</span>
      <button id="btnFull" class="fullscreen-btn">å…¨è¢å¹•</button>
    </h2>
    <div id="mapWrap">
      <div id="map"></div>
      <div class="layerbox">
        <label><input type="checkbox" id="chkMain" checked> ä¸»è¡Œç¨‹</label>
        <label><input type="checkbox" id="chkOpt" checked> å¯æœ‰å¯ç„¡</label>
        <label><input type="checkbox" id="chkToilet" checked> å»æ‰€</label>
      </div>
      <div class="locateStack">
        <button id="btnLocate" class="btn-ghost" title="æˆ‘åœ¨é€™">
          <span class="em">ğŸ“</span><span>æˆ‘</span><span>åœ¨</span><span>é€™</span>
        </button>
        <button id="btnFollow" class="btn-ghost" title="è·Ÿéš¨æˆ‘">
          <span class="em">ğŸ§­</span><span>è·Ÿ</span><span>éš¨</span><span>æˆ‘</span>
        </button>
      </div>
    </div>
    <div id="photos">
      <h2 style="border-top:1px solid var(--border)">ç…§ç‰‡ç‰† <span class="sub">ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</span></h2>
      <div id="photoWall"><div class="card"><span class="muted">æš«ç„¡ç…§ç‰‡</span></div></div>
    </div>
  </div>

  <div class="section" id="timeline">
    <h2>æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</h2>
    <div class="src">æœ¬é è®€å–ï¼š<code>timeline-2025-09-20_v6.csv</code>ã€<code>photos-2025-09-20-mapped.csv</code>ã€<code>coords-override-2025-09-20.json</code></div>
    <div class="thead">
      <div class="grid">
        <div>æ™‚é–“</div><div>åœ°é»ï¼æ´»å‹•</div><div>å‚™è¨»</div><div>è»ŠMap Code</div>
      </div>
    </div>
    <div id="rows" class="table"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CSV_TIMELINE = 'timeline-2025-09-20_v6.csv';
const CSV_PHOTOS   = 'photos-2025-09-20-mapped.csv';
const JSON_COORDS  = 'coords-override-2025-09-20.json';

// --- helpers ---
async function fetchText(p){ const r = await fetch(p); if(!r.ok) throw new Error(p); return r.text(); }
async function fetchJSON(p){ const r = await fetch(p); if(!r.ok) throw new Error(p); return r.json(); }

function parseCSV(txt){
  // simple CSV parser (handles quoted commas)
  const lines = txt.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
  const head = lines.shift().split(',').map(s=>s.trim());
  const rows = lines.map(line=>{
    const out=[], re=/("([^"]|"")*"|[^,]*)/g; let m, idx=0, last=0;
    const parts=[]; let cur='', inQ=false;
    for (let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"'){ inQ=!inQ; cur+=c; }
      else if(c==',' && !inQ){ parts.push(cur); cur=''; }
      else cur+=c;
    }
    parts.push(cur);
    const obj={};
    head.forEach((h,i)=>obj[h]= (parts[i]||'').replace(/^"(.*)"$/,'$1').replace(/""/g,'"'));
    return obj;
  });
  return {head,rows};
}

function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }

// --- map ---
let map, mainLayer = L.layerGroup(), optLayer=L.layerGroup(), toiletLayer=L.layerGroup(), routeLine;
let photoIndex = {}; // name => [urls]

function initMap(center=[35.33,139.53], zoom=11){
  map = L.map('map',{scrollWheelZoom:true}).setView(center, zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);
  mainLayer.addTo(map); optLayer.addTo(map); toiletLayer.addTo(map);

  document.getElementById('btnFull').onclick = ()=>{
    const m = document.getElementById('map');
    const isFull = m.style.height==='86vh';
    m.style.height = isFull ? '60vh':'86vh';
    setTimeout(()=>map.invalidateSize(), 220);
  };

  document.getElementById('chkMain').onchange = e => e.target.checked ? map.addLayer(mainLayer) : map.removeLayer(mainLayer);
  document.getElementById('chkOpt').onchange  = e => e.target.checked ? map.addLayer(optLayer)  : map.removeLayer(optLayer);
  document.getElementById('chkToilet').onchange= e => e.target.checked ? map.addLayer(toiletLayer): map.removeLayer(toiletLayer);

  // locate / follow
  let watchId=null;
  document.getElementById('btnLocate').onclick = ()=>{
    if(!navigator.geolocation) return alert('æ­¤è£ç½®ä¸æ”¯æ´å®šä½');
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude} = pos.coords;
      L.marker([latitude,longitude],{title:'æˆ‘åœ¨é€™',icon:L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconAnchor:[12,41]})}).addTo(map);
      map.setView([latitude,longitude], 14, {animate:true});
    }, err=> alert('å®šä½å¤±æ•—ï¼š'+err.message));
  };
  document.getElementById('btnFollow').onclick = (ev)=>{
    const btn=ev.currentTarget;
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; btn.classList.remove('following'); return; }
    if(!navigator.geolocation) return alert('æ­¤è£ç½®ä¸æ”¯æ´å®šä½');
    btn.classList.add('following');
    watchId = navigator.geolocation.watchPosition(pos=>{
      const {latitude,longitude} = pos.coords;
      map.setView([latitude,longitude], 15);
    }, err=>{ alert('å®šä½å¤±æ•—ï¼š'+err.message); btn.classList.remove('following'); watchId=null; });
  };
}

function pillHTML(code){
  const safe = (code||'').trim();
  if(!safe) return '';
  return `<span class="pill"><span class="car">ğŸš—</span><span class="code">${safe}</span></span>`;
}

function setPhotoWall(name){
  const wall = document.getElementById('photoWall'); wall.innerHTML='';
  const list = photoIndex[name] || [];
  if(!list.length){ wall.innerHTML = '<div class="card"><span class="muted">æš«ç„¡ç…§ç‰‡</span></div>'; return; }
  list.slice(0,12).forEach(url=>{
    const c=el('div','card'); const img=new Image(); img.loading='lazy'; img.src=url; c.appendChild(img); wall.appendChild(c);
  });
}

// --- load data and render ---
(async function(){
  try{
    const [csvText, photoText, coordsMap] = await Promise.all([
      fetchText(CSV_TIMELINE), fetchText(CSV_PHOTOS), fetchJSON(JSON_COORDS)
    ]);

    // photos
    const p = parseCSV(photoText).rows;
    p.forEach(r=>{
      const name = r.place || r.name || r['åœ°é»'] || r['label'] || r['spot'] || '';
      const url  = r.url || r.image || r['img'] || r['photo'] || '';
      if(!name || !url) return;
      (photoIndex[name] ||= []).push(url);
    });

    const parsed = parseCSV(csvText); const rows = parsed.rows;

    // map init
    initMap();

    // timeline rows & markers
    const container = document.getElementById('rows');
    const pointsCoords=[];

    for(const r of rows){
      const timeStart = (r['æ™‚é–“èµ·']||r['æ™‚é–“']||'').trim();
      const timeEnd   = (r['æ™‚é–“è¿„']||'').trim();
      const place     = (r['åœ°é» / æ´»å‹•']||r['åœ°é»/æ´»å‹•']||r['åœ°é»']||'').trim();
      const note      = (r['å‚™è¨»']||'').trim();
      const cat       = (r['é¡åˆ¥']||'').trim();
      const link      = (r['ğŸ“ æ™¯é»é€£çµ']||r['åœ°åœ–']||'').trim();
      const toilet    = (r['ğŸš» å»æ‰€']||'').trim();
      const carcode   = (r['ğŸš™è»ŠMap Code']||r['è»ŠMap Code']||'').trim();

      const tr = el('div','tr');
      const timeCell = el('div','cell timeblock', (timeStart && timeEnd)? `${timeStart}\n${timeEnd}` : timeStart);
      const placeCell= el('div','cell place', `${place}${link?`\n<span class="badge"><span class="pin">ğŸ“</span><a href="${link}" target="_blank">Google åœ°åœ–</a></span>`:''}`);
      const noteCell = el('div','cell', note? `<div class="note">${note.replace(/\\n/g,'\n')}</div>`:'&nbsp;');
      const codeCell = el('div','cell', pillHTML(carcode));
      tr.append(timeCell, placeCell, noteCell, codeCell);
      container.appendChild(tr);

      // marker/route
      if(place){
        let latlng = null;
        if(coordsMap[place]) latlng = coordsMap[place];
        if(latlng){
          const popup = `
            <div class="popup-title">${place}</div>
            ${pillHTML(carcode)}
            ${note? `<div class="popup-note">${note.replace(/\\n/g,'<br>')}</div>`:''}
            ${link? `<div class="popup-note"><span class="muted">ğŸ”—</span> <a href="${link}" target="_blank">Google åœ°åœ–</a></div>`:''}
          `;
          const mk = L.marker(latlng).bindPopup(popup);
          mk.on('click', ()=> setPhotoWall(place));
          const which = (cat==='å¯æœ‰å¯ç„¡')? optLayer : mainLayer;
          mk.addTo(which);
          pointsCoords.push(latlng);
          if(toilet){ L.circleMarker(latlng,{radius:5,color:'#00d4a4'}).addTo(toiletLayer); }
        }
      }
    }

    if(pointsCoords.length){
      routeLine = L.polyline(pointsCoords,{color:'#58a6ff',weight:3,opacity:.8}).addTo(mainLayer);
      map.fitBounds(routeLine.getBounds().pad(0.2));
    }

  }catch(err){
    console.error(err);
    alert('è®€å–è³‡æ–™å¤±æ•—ï¼š'+err.message);
  }
})();
</script>
</body>
</html>