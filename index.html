<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 東京近郊旅遊 | 9/20 鎌倉</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0f1720;         /* 主背景 深藍灰 */
  --panel:#121a24;      /* 卡片 */
  --panel-2:#0c131b;    /* 更深 */
  --text:#e8f0ff;       /* 主要字 */
  --muted:#9bb3cf;      /* 次要字 */
  --accent:#2b6fff;     /* 高亮藍 */
  --accent-2:#173867;   /* 藍框 */
  --chip:#1a2430;       /* 膠囊底 */
  --chip-border:#2a3a4d;
  --pill:#232a35;       /* MAPCODE 膠囊底 */
  --pill-border:#2d3a49;
  --yellow:#ffd24a;     /* MAPCODE 黃字 */
  --card-shadow:0 8px 24px rgba(0,0,0,.35);
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1200px 600px at 50% -250px, #1a2740 0%, var(--bg) 60%);
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
.container{max-width:980px;margin:0 auto;padding:20px 16px 64px}
header h1{font-size:34px;letter-spacing:.08em;margin:0 0 6px}
.breadcrumb{color:var(--muted);font-size:16px;letter-spacing:.2em;margin-bottom:14px;white-space: nowrap;            /* ← 不換行 */ 
            overflow-x: auto;               /* 超出就可左右滑 */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;}
  .breadcrumb::-webkit-scrollbar{ display:none; }
.date-row{display:flex;gap:16px;align-items:center;margin-bottom:12px;position:sticky;top:0;z-index:20;padding:8px 0 10px;background:linear-gradient(180deg, rgba(15,23,32,.96) 60%, rgba(15,23,32,0));backdrop-filter:saturate(140%) blur(2px)}
.date-btn{
  border-radius:28px;
  border:2px solid var(--accent-2);
  background:linear-gradient(180deg,#141d29,#0e1621);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 3px 10px rgba(0,0,0,.36);
  color:var(--text);
  padding:10px 18px;
  min-width:120px;
  display:flex;flex-direction:column;align-items:center;gap:6px;
  text-decoration:none;
}
.date-btn .d{font-size:22px;font-weight:700;letter-spacing:.08em}
.date-btn .l{font-size:14px;color:#b9c7db;letter-spacing:.25em}
.date-btn.active{
  border-color:#3d65ff; outline:3px solid rgba(61,101,255,.35);
  background:linear-gradient(180deg,#122645,#0f1d33);
}
/* Map Card */
.card{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:12px;margin:0 0 18px}
#map{height:430px;border-radius:14px;overflow:hidden}
.leaflet-container{background:#0b131c}
/* map inner overlay elements */
.map-overlay{position:absolute;inset:12px 12px auto auto;z-index:450;pointer-events:auto}
.layers-card{
  background:rgba(12,19,27,.95);
  border:1px solid #223246;border-radius:14px;padding:10px 14px;min-width:180px;
  box-shadow:0 10px 26px rgba(0,0,0,.45);
}
.layers-card label{display:flex;align-items:center;gap:10px;margin:8px 0;color:#d7e4ff}
.layers-card input{width:18px;height:18px}
/* vertical buttons in map */
.vbtns{position:absolute;top:95px;right:12px;display:flex;flex-direction:column;gap:10px;z-index:450}
.vbtn{background:rgba(13,20,28,.95);color:#fff;border:1px solid #213040;border-radius:12px;padding:10px 8px;line-height:1.2;writing-mode:vertical-rl;text-orientation:mixed;letter-spacing:.3em;cursor:pointer}
.vbtn:active{transform:translateY(1px)}
/* Photo wall */
.section-title{font-weight:700;letter-spacing:.2em;font-size:18px;margin:2px 0 10px;color:#dce9ff}
.photo-wall{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);min-height:120px;padding:16px;margin-bottom:18px}
.photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.photos img{width:100%;height:100px;object-fit:cover;border-radius:10px;border:1px solid #233246}
.empty{color:#9cb1c9}
/* Timeline */
.table{width:100%;border-collapse:separate;border-spacing:0 12px}
.th-row th{color:#d7e6ff;text-align:left;font-weight:800;letter-spacing:.25em;padding:8px 12px}
.tr{background:var(--panel);border:1px solid #1f2b3a;border-radius:14px;box-shadow:var(--card-shadow)}
.td{padding:14px 14px;vertical-align:top}
.time{font-size:22px;font-weight:700;letter-spacing:.15em;white-space:pre-line}
.place{font-size:20px;font-weight:700;letter-spacing:.03em}
.note{margin-top:8px;color:#c9d8ef}
.cat{font-size:20px;font-weight:800;letter-spacing:.4em}
.mapcode{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:22px;
  background:var(--pill);border:1px solid var(--pill-border);}
.mapcode .car{font-size:20px} .mapcode .code{color:var(--yellow);font-weight:800;font-size:20px;letter-spacing:.05em}
.badge{display:inline-block;margin-top:6px;color:#8fb6ff}
/* util */
hr.sep{border:none;border-top:1px dashed #213141;margin:10px 0}
a, a:visited{color:#2ea0ff}
/* position wrappers */
.map-wrap{position:relative}
/* keep leaflet controls inside without overlapping header */
.leaflet-top.leaflet-left{top:12px;left:12px}
.leaflet-control-zoom a{border-radius:10px;background:#0e1722;color:#fff;border:1px solid #203146}
@media (max-width:520px){
  #map{height:380px}
  .date-btn{min-width:112px}
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1 style="text-align: center;">2025 東京近郊旅遊</h1>
      <div class="breadcrumb">澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</div>
      <div class="date-row" id="dateRow">
        <a class="date-btn active" href="#"><span class="d">09/20</span><span class="l">鎌倉</span></a>
        <a class="date-btn" href="#"><span class="d">09/21</span><span class="l">箱根</span></a>
        <a class="date-btn" href="#"><span class="d">09/22</span><span class="l">熱海</span></a>
        <a class="date-btn" href="#"><span class="d">09/23</span><span class="l">伊豆半島</span></a>
      </div>
    </header>

    <div class="card map-wrap">
      <div id="map"></div>
      <!-- Layers card (inside map, top-right) -->
      <div class="map-overlay">
        <div class="layers-card" id="layersCard">
          <label><input type="checkbox" id="layer-main" checked> 主行程</label>
          <label><input type="checkbox" id="layer-optional" checked> 可有可無</label>
          <label><input type="checkbox" id="layer-restroom" checked> 廁所</label>
        </div>
      </div>
      <!-- Vertical buttons (inside map, right) -->
      <div class="vbtns">
        <button id="btnHere" class="vbtn">我在這</button>
        <button id="btnFollow" class="vbtn">跟隨我</button>
      </div>
    </div>

    <div>
      <div class="section-title">照片牆（點任一標記顯示相簿）</div>
      <div class="photo-wall">
        <div id="photos" class="photos"></div>
        <div id="emptyPhotos" class="empty">暫無照片</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">時間軸（9/20 +15 分鐘緩衝版）</div>
      <div class="badge" id="srcInfo"></div>
      <table class="table" id="timelineTable">
        <thead class="th-row">
          <tr>
            <th style="width:110px">時間</th>
            <th>地點 / 活動</th>
            <th style="width:72px">類別</th>
            <th style="width:180px">車Map Code</th>
          </tr>
        </thead>
        <tbody id="timelineBody"></tbody>
      </table>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- Utilities ----------------
function parseCSV(text){
  // simple csv parser (handles quoted commas/newlines)
  const rows=[];let i=0, cur='', inQ=false; const push=()=>{rows.push(cur);cur=''};
  const out=[]; let row=[];
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){cur+='"'; i+=2; continue;}
      if(c==='"' ){inQ=false;i++; continue;}
      cur+=c; i++; continue;
    }else{
      if(c==='"'){inQ=true;i++; continue;}
      if(c===','){ row.push(cur); cur=''; i++; continue;}
      if(c==='\n'){ row.push(cur); cur=''; out.push(row); row=[]; i++; continue;}
      if(c==='\r'){ i++; continue;}
      cur+=c; i++; continue;
    }
  }
  if(cur.length || row.length){ row.push(cur); out.push(row); }
  // first row as header
  const header=out.shift().map(s=>s.trim());
  return out.filter(r=>r.some(x=>x&&x.trim()!=='')).map(r=>{
    const obj={}; header.forEach((h,idx)=>obj[h]= (r[idx]??'').trim()); return obj;
  });
}
function byKeys(obj,keys){ for(const k of keys){ if(k in obj && obj[k]!=='' ) return obj[k]; } return ''; }
function toTimeBlock(s,e){
  const fmt=t=>t.replace(':','：'); // fullwidth colon feel
  return fmt(s)+'\n'+fmt(e);
}
function el(tag,cls,html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }
// ---------------- Data files ----------------
const FILE_TIMELINE = "timeline-2025-09-20_v6.csv";
const FILE_PHOTOS   = "photos-2025-09-20-mapped.csv";
const FILE_COORDS   = "coords-override-2025-09-20.json";
const srcBadge = document.getElementById('srcInfo');
srcBadge.textContent = `本頁讀取： ${FILE_TIMELINE}、${FILE_PHOTOS}、${FILE_COORDS}`;

// ---------------- Map init ----------------
const map = L.map('map',{ zoomControl:true, attributionControl:true }).setView([35.319,139.55], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// Layer groups
const gMain = L.layerGroup().addTo(map);
const gOptional = L.layerGroup().addTo(map);
const gRest = L.layerGroup().addTo(map);
const layers = { "主行程":gMain, "可有可無":gOptional, "廁所":gRest };

// UI layer toggles
const cMain = document.getElementById('layer-main');
const cOpt  = document.getElementById('layer-optional');
const cRes  = document.getElementById('layer-restroom');
cMain.onchange = () => { cMain.checked ? map.addLayer(gMain) : map.removeLayer(gMain); };
cOpt.onchange  = () => { cOpt.checked ? map.addLayer(gOptional) : map.removeLayer(gOptional); };
cRes.onchange  = () => { cRes.checked ? map.addLayer(gRest) : map.removeLayer(gRest); };

// Here / Follow
let watchId=null;
document.getElementById('btnHere').onclick = ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      const latlng=[p.coords.latitude,p.coords.longitude];
      L.marker(latlng,{title:"我在這",riseOnHover:true}).addTo(map);
      map.flyTo(latlng, 14, {duration:0.8});
    });
  }
};
document.getElementById('btnFollow').onclick = ()=>{
  if(!navigator.geolocation){ return; }
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; alert('已停止跟隨'); return; }
  watchId = navigator.geolocation.watchPosition(p=>{
    const latlng=[p.coords.latitude,p.coords.longitude];
    L.circleMarker(latlng,{radius:6,color:'#77b2ff',fill:true,fillOpacity:.8}).addTo(map);
    map.panTo(latlng);
  },err=>console.warn(err),{enableHighAccuracy:true,maximumAge:10000,timeout:20000});
  alert('開始跟隨');
};

// Photos mapping
let photoMap = {}; // key => [urls]
function setPhotosForKey(key){
  const wrap = document.getElementById('photos'); const empty = document.getElementById('emptyPhotos');
  wrap.innerHTML='';
  const arr = photoMap[key]||[];
  if(arr.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  arr.forEach(u=>{
    const img = new Image(); img.src=u; wrap.appendChild(img);
  });
}
// ---------------- Load data ----------------
Promise.all([
  fetch(FILE_TIMELINE).then(r=>r.text()),
  fetch(FILE_PHOTOS).then(r=>r.ok?r.text():""),
  fetch(FILE_COORDS).then(r=>r.ok?r.json():{})
]).then(([csvTimeline,csvPhotos,coordOverride])=>{
   // photos
   if(csvPhotos){
     const rows = parseCSV(csvPhotos);
     rows.forEach(r=>{
       const k = byKeys(r, ['key','Key','名稱','地點','place','title']);
       const url = byKeys(r,['url','URL','link']);
       if(!k || !url) return;
       (photoMap[k] = photoMap[k] || []).push(url);
     });
   }

   const rows = parseCSV(csvTimeline);
   // Build timeline & markers
   const tb = document.getElementById('timelineBody');
   rows.forEach(r=>{
     const start = byKeys(r,['start','開始','start_time','開始時間']);
     const end   = byKeys(r,['end','結束','end_time','結束時間']);
     const title = byKeys(r,['地點 / 活動','地點','活動','place','title','名稱']);
     const note  = byKeys(r,['備註','備註說明','note','desc','說明']);
     const cat   = byKeys(r,['類別','分類','category','cat']); // 包車/休息/拍照…
     const code  = byKeys(r,['mapcode','Map Code','MapCode','MAPCODE','車Map Code','Map Code (Car)']);
     const lat   = byKeys(r,['lat','緯度']);
     const lng   = byKeys(r,['lng','經度']);
     let groupName = byKeys(r,['圖層','layer','圖層分類']); // 主行程/可有可無/廁所

     // timeline row
     const tr = el('tr','tr');
     const td1 = el('td','td'); td1.style.width='110px'; td1.innerHTML = '<div class="time">'+toTimeBlock(start,end)+'</div>';
     const td2 = el('td','td');
     td2.innerHTML = `<div class="place">${title||''}</div><div class="badge">📍 <a href="${byKeys(r,['google','gmap','map','link'])||'#'}" target="_blank">Google 地圖</a></div>` + (note? `<div class="note">備註：${note}</div>`:'');
     const td3 = el('td','td'); td3.innerHTML = `<div class="cat">${(cat||'').replace(/\s/g,'')}</div>`;
     const td4 = el('td','td'); td4.innerHTML = `<div class="mapcode"><span class="car">🚗</span><span class="code">${code||''}</span></div>`;
     tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
     tb.appendChild(tr);

     // marker
     // coord by override > row lat/lng > null
     let latlng=null;
     if(coordOverride && title && coordOverride[title]){
       latlng = coordOverride[title];
     }else if(lat && lng){
       latlng = [parseFloat(lat), parseFloat(lng)];
     }
     if(!latlng) return;

     const m = L.marker(latlng,{title}).on('click', ()=> setPhotosForKey(title));
     const pop = `<div style="font-weight:800;font-size:18px;margin-bottom:6px">${title}</div>
                  ${code? `<div class="mapcode"><span class="car">🚗</span><span class="code">${code}</span></div>`:''}
                  ${note? `<div style="margin-top:8px;color:#c9d8ef">${note}</div>`:''}
                  <div style="margin-top:6px"><a href="${byKeys(r,['google','gmap','map','link'])||'#'}" target="_blank">📍 Google 地圖</a></div>`;
     m.bindPopup(pop,{closeButton:true,autoPan:true});

     // decide group
     let g = gMain;
     if(/可有可無/i.test(groupName)) g = gOptional;
     else if(/廁所/i.test(groupName)) g = gRest;
     g.addLayer(m);
   });

}).catch(err=>{
   console.error(err);
   document.getElementById('timelineBody').innerHTML = '<tr><td colspan="4" class="td">讀取資料失敗，請確認 CSV / JSON 檔案是否與 index 同層。</td></tr>';
});
</script>
</body>
</html>
