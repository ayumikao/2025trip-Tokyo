<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 東京近郊旅遊 | 9/20 鎌倉</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0f1720; --panel:#121a24; --panel-2:#0c131b; --text:#e8f0ff; --muted:#9bb3cf;
  --accent:#2b6fff; --accent-2:#173867; --chip:#1a2430; --chip-border:#2a3a4d;
  --pill:#232a35; --pill-border:#2d3a49; --yellow:#ffd24a; --card-shadow:0 8px 24px rgba(0,0,0,.35); --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 600px at 50% -250px, #1a2740 0%, var(--bg) 60%);
  color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
.container{max-width:980px;margin:0 auto;padding:20px 16px 64px}
header h1{font-size:34px;letter-spacing:.08em;margin:0 0 6px}
.breadcrumb{
  color:var(--muted); font-size:16px; letter-spacing:.2em; margin-bottom:14px; white-space:nowrap; text-align:center; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
}
.breadcrumb::-webkit-scrollbar{display:none}
.date-row{
  display:flex; align-items:center; justify-content:center; flex-wrap:nowrap; gap:8px; margin-bottom:12px;
  position:sticky; top:0; z-index:20; padding:8px 0 10px;
  background:linear-gradient(180deg, rgba(15,23,32,.96) 60%, rgba(15,23,32,0)); backdrop-filter:saturate(140%) blur(2px);
}
.date-row::-webkit-scrollbar{display:none}
.date-btn{
  border-radius:20px; border:2px solid var(--accent-2);
  background:linear-gradient(180deg,#141d29,#0e1621);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 2px 6px rgba(0,0,0,.25);
  color:var(--text); padding:6px 9px; min-width:80px; display:flex; flex-direction:column; align-items:center; gap:4px; text-decoration:none;
}
.date-btn .d{font-size:16px;font-weight:700;letter-spacing:.05em}
.date-btn .l{font-size:12px;color:#b9c7db;letter-spacing:.15em}
.date-btn.active{border-color:#3d65ff; outline:3px solid rgba(61,101,255,.35); background:linear-gradient(180deg,#122645,#0f1d33)}
@media (max-width:520px){ .date-btn{min-width:80px;padding:6px 10px} .date-btn .d{font-size:14px} .date-btn .l{font-size:12px} #map{height:380px} }

.card{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:12px;margin:0 0 18px}
#map{height:430px;border-radius:14px;overflow:hidden}
.leaflet-container{background:#0b131c}

/* 圖層卡片 */
.map-overlay{position:absolute; top:12px; right:12px; z-index:450;}
.layers-card{
  background:rgba(12,19,27,0.5); border-radius:14px; padding:4px 6px; min-width:90px;
  box-shadow:0 10px 26px rgba(0,0,0,.45);
}
.layers-card label{display:flex; align-items:center; gap:6px; margin:2px 0; line-height:1.2; color:#d7e4ff; font-size:14px}
.layers-card input{width:16px;height:16px}

/* 垂直按鈕 */
.vbtns{position:absolute; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:450}
.vbtn{background:rgba(13,20,28,0.5); color:var(--text); border-radius:12px; padding:10px 8px; line-height:1.2; writing-mode:vertical-rl; text-orientation:mixed; letter-spacing:.3em; cursor:pointer}
.vbtn:active{transform:translateY(1px)}
@supports (padding: max(0px)) { .vbtns{bottom:max(12px, env(safe-area-inset-bottom)); right:max(12px, env(safe-area-inset-right));} }

/* 照片牆縮圖（縮小版） */
.photo-wall{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);min-height:120px;padding:16px;margin-bottom:18px}
.photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
.photos img{width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid #233246;cursor:pointer}
.empty{color:#9cb1c9}

/* 表格 */
.table{width:100%;border-collapse:separate;border-spacing:0 12px}
.th-row th{color:#d7e6ff;text-align:left;font-weight:800;letter-spacing:.25em;padding:8px 12px}
.tr{background:var(--panel);border:1px solid #1f2b3a;border-radius:14px;box-shadow:var(--card-shadow)}
.td{padding:14px 14px;vertical-align:top}
.time{font-size:22px;font-weight:700;letter-spacing:.15em;white-space:pre-line}
.place{font-size:20px;font-weight:700;letter-spacing:.03em}
.note{margin-top:8px;color:#c9d8ef}
.cat{font-size:20px;font-weight:800;letter-spacing:.4em}
.mapcode{
  display:inline-flex; align-items:center; gap:10px;
  padding:12px 16px; border-radius:22px;
  background: rgba(0,0,0,0.30); /* 黑色半透明 */
  /* border:1px solid #d0d8e0;  想要邊框就打開 */
}
.mapcode .car{font-size:20px}
.mapcode .code{color:#ffd24a;font-weight:800;font-size:20px;letter-spacing:.05em}
.mapcode .copy{background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.28); color:#fff; font-size:12px; padding:4px 8px; border-radius:10px; cursor:pointer}
.badge{display:inline-block;margin-top:6px;color:#8fb6ff}
a, a:visited{color:#2ea0ff}
.map-wrap{position:relative}
.leaflet-top.leaflet-left{top:12px;left:12px}
.leaflet-control-zoom a:hover{border-radius:10px;background:rgba(14,23,34,0.8);color:#fff;border:1px solid #203146}
.leaflet-top.leaflet-left{top:1px;left:1px}
.card.map-wrap{border:none}

/* Lightbox（大圖） */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
#lightbox img{max-width:90%;max-height:80%;border-radius:12px;box-shadow:0 18px 60px rgba(0,0,0,0.6)}
#lightbox .controls{margin-top:12px;display:flex;gap:14px}
#lightbox button{background:rgba(255,255,255,0.16);border:1px solid rgba(255,255,255,0.22);padding:8px 14px;font-size:16px;color:#fff;border-radius:10px;cursor:pointer}
#lightbox button:hover{background:rgba(255,255,255,0.28)}

/* Popup：白色 0.72 + 深色字 */
.leaflet-popup-content-wrapper{
  background: rgba(255,255,255,0.72) !important;
  border: 1px solid #d0d8e0;
  border-radius: 14px;
  box-shadow: 0 16px 40px rgba(0,0,0,.25);
}
.leaflet-popup-tip{
  background: rgba(255,255,255,0.72) !important;
  border: 1px solid #d0d8e0;
}
.leaflet-popup-content{ margin:8px 10px; color:#25324a; line-height:1.6; }
.popup-title{font-weight:800;font-size:18px;color:#0b1220;margin:0 0 6px}
.popup-note{margin-top:6px;color:#42526e}
.popup-link{margin-top:6px}
.popup-link a{color:#2b6fff;text-decoration:underline}

/* 手機：只縮小框與 chip，字體不變 */
@media (max-width:520px){
  .photos{grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:6px}
  .photos img{height:65px}
  .leaflet-popup-content-wrapper{padding:6px;border-radius:10px}
  .leaflet-popup-content{margin:6px 8px}
  .mapcode{padding:6px 10px;border-radius:12px}
  .mapcode .code,.mapcode .car{font-size:18px}
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1 style="text-align:center;">2025 東京近郊旅遊</h1>
      <div class="breadcrumb">澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</div>
      <div class="date-row" id="dateRow">
        <a class="date-btn active" href="#"><span class="d">09/20</span><span class="l">鎌倉</span></a>
        <a class="date-btn" href="#"><span class="d">09/21</span><span class="l">箱根</span></a>
        <a class="date-btn" href="#"><span class="d">09/22</span><span class="l">熱海</span></a>
        <a class="date-btn" href="#"><span class="d">09/23</span><span class="l">伊豆半島</span></a>
      </div>
    </header>

    <div class="card map-wrap">
      <div id="map"></div>
      <div class="map-overlay">
        <div class="layers-card" id="layersCard">
          <label><input type="checkbox" id="layer-main" checked> 主行程</label>
          <label><input type="checkbox" id="layer-optional" checked> 可有可無</label>
          <label><input type="checkbox" id="layer-restroom" checked> 廁所</label>
        </div>
      </div>
      <div class="vbtns">
        <button id="btnHere" class="vbtn">我在這</button>
        <button id="btnFollow" class="vbtn">跟隨我</button>
      </div>
    </div>

    <div>
      <div class="section-title">照片牆（點地圖或時間軸地點 → 看縮圖；點縮圖 → 大圖可左右滑）</div>
      <div class="photo-wall">
        <div id="photos" class="photos"></div>
        <div id="emptyPhotos" class="empty">暫無照片</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">時間軸（9/20 +15 分鐘緩衝版）</div>
      <div class="badge" id="srcInfo"></div>
      <table class="table" id="timelineTable">
        <thead class="th-row">
          <tr>
            <th style="width:110px">時間</th>
            <th>地點 / 活動</th>
            <th style="width:72px">類別</th>
            <th style="width:220px">車Map Code</th>
          </tr>
        </thead>
        <tbody id="timelineBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Lightbox（大圖檢視） -->
  <div id="lightbox" aria-hidden="true">
    <img id="lightbox-img" src="" alt="photo view">
    <div class="controls">
      <button id="prev" type="button">← 上一張</button>
      <button id="next" type="button">下一張 →</button>
      <button id="close" type="button">✕ 關閉</button>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- Utilities ----------------
function parseCSV(text){
  const out=[]; let row=[]; let cur='', inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){cur+='"'; i++; continue;}
      if(c==='"'){inQ=false; continue;}
      cur+=c; continue;
    }else{
      if(c==='"'){inQ=true; continue;}
      if(c===','){row.push(cur); cur=''; continue;}
      if(c==='\n'){row.push(cur); out.push(row); row=[]; cur=''; continue;}
      if(c==='\r'){continue;}
      cur+=c; continue;
    }
  }
  if(cur.length||row.length){row.push(cur); out.push(row);}
  const header=(out.shift()||[]).map(s=>s.trim().replace(/^\ufeff/,'')); // 去 BOM
  return out.filter(r=>r.some(x=>x&&x.trim()!=='')).map(r=>{
    const obj={}; header.forEach((h,idx)=>obj[h]=(r[idx]??'').trim()); return obj;
  });
}
function byKeys(obj,keys){ for(const k of keys){ if(k in obj && obj[k]!=='' ) return obj[k]; } return ''; }
function norm(s){ return String(s||'').toLowerCase().replace(/\s|　/g,''); }
function toTimeBlock(s,e){ const fmt=t=>(t||'').replace(':','：'); return fmt(s)+'\n'+fmt(e); }
function el(tag,cls,html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }

// 從 Google 地圖連結抽緯經
function extractLatLngFromLink(link){
  if(!link) return null;
  try{
    const dec = decodeURIComponent(link);
    let m = dec.match(/query=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    m = dec.match(/<\s*([-0-9.]+)\s*>\s*,\s*<\s*([-0-9.]+)\s*>/i);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    m = dec.match(/@\s*([-0-9.]+)\s*,\s*([-0-9.]+)/i);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
  }catch(e){}
  return null;
}

// ======= Column 別名 =======
const COL = {
  start:  ['start','開始','start_time','開始時間','時間起'],
  end:    ['end','結束','end_time','結束時間','時間迄'],
  title:  ['地點 / 活動','地點','活動','名稱','place','title'],
  note:   ['備註','備註說明','note','desc','說明'],
  category: ['類別','分類','category','cat'],
  mapcode:  ['mapcode','Map Code','MapCode','MAPCODE','車Map Code','Map Code (Car)','🚙車Map Code'],
  lat:    ['lat','緯度'],
  lng:    ['lng','經度'],
  link:   ['google','gmap','map','link','Google 地圖','GoogleMap','📍 景點連結'],
  seq:    ['順序','order','seq','序'],
  restroomCol: ['🚻 廁所','廁所']
};
function get(r, key){
  const keys = COL[key] || [];
  for(const k of keys){ if(k in r && r[k] !== '') return (r[k]||'').trim(); }
  return '';
}

/* 關鍵字（看備註、類別兩欄） */
const OPTIONAL_RE = /(可有可無|可選|雨備|備援|optional|option|opt)/i;
const RESTROOM_RE = /(🚻|廁|公廁|洗手間|化妝室|トイレ|toilet|rest\s*room|wc)/i;

// ---------------- Data files ----------------
const FILE_TIMELINE = "timeline-2025-09-20_v6.csv";
const FILE_PHOTOS   = "photos-2025-09-20-mapped.csv";
const FILE_COORDS   = "coords-override-2025-09-20.json";
const srcBadge = document.getElementById('srcInfo');
if (srcBadge) srcBadge.textContent = `本頁讀取： ${FILE_TIMELINE}、${FILE_PHOTOS}、${FILE_COORDS}`;

// ---------------- Map init ----------------
const map = L.map('map',{ zoomControl:true, attributionControl:true }).setView([35.319,139.55], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

// Layer groups
const gMain = L.layerGroup().addTo(map);
const gOptional = L.layerGroup().addTo(map);
const gRest = L.layerGroup().addTo(map);

// 收集主行程節點用來畫線（只收主行程）
let routeNodes = [];
let routeLine = null;

// marker 索引（讓表格/照片牆互相定位）
const markerIndex = {}; // norm(title) -> 代表 marker

// UI layer toggles
const cMain = document.getElementById('layer-main');
const cOpt  = document.getElementById('layer-optional');
const cRes  = document.getElementById('layer-restroom');
if (cMain) cMain.onchange = () => {
  if (cMain.checked) { map.addLayer(gMain); if (routeLine) map.addLayer(routeLine); }
  else { map.removeLayer(gMain); if (routeLine) map.removeLayer(routeLine); }
};
if (cOpt) cOpt.onchange  = () => { cOpt.checked ? map.addLayer(gOptional) : map.removeLayer(gOptional); };
if (cRes) cRes.onchange  = () => { cRes.checked ? map.addLayer(gRest) : map.removeLayer(gRest); };

// Here / Follow
let watchId=null;
const btnHere = document.getElementById('btnHere');
const btnFollow = document.getElementById('btnFollow');
if (btnHere) btnHere.onclick = ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      const latlng=[p.coords.latitude,p.coords.longitude];
      L.marker(latlng,{title:"我在這",riseOnHover:true}).addTo(map);
      map.flyTo(latlng, 14, {duration:0.8});
    });
  }
};
if (btnFollow) btnFollow.onclick = ()=>{
  if(!navigator.geolocation){ return; }
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; alert('已停止跟隨'); return; }
  watchId = navigator.geolocation.watchPosition(p=>{
    const latlng=[p.coords.latitude,p.coords.longitude];
    L.circleMarker(latlng,{radius:6,color:'#77b2ff',fill:true,fillOpacity:.8}).addTo(map);
    map.panTo(latlng);
  },err=>console.warn(err),{enableHighAccuracy:true,maximumAge:10000,timeout:20000});
  alert('開始跟隨');
};

// 照片 & Lightbox
let photoMap = {}; // key(norm title) => [urls]
let currentPhotos = []; let currentIndex = 0;
function setPhotosForKey(key){
  const wrap = document.getElementById('photos'); 
  const empty = document.getElementById('emptyPhotos');
  if (!wrap || !empty) return;
  wrap.innerHTML='';
  const arr = photoMap[norm(key)] || [];
  currentPhotos = arr;
  if(arr.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  arr.forEach((u,i)=>{ 
    const img = new Image(); img.loading="lazy"; img.decoding="async"; img.src=u; img.onclick=()=>openLightbox(i); 
    wrap.appendChild(img); 
  });
}
function openLightbox(index){
  currentIndex = index;
  const lb = document.getElementById('lightbox');
  const img = document.getElementById('lightbox-img');
  img.src = currentPhotos[currentIndex];
  lb.style.display = 'flex';
}
function closeLightbox(){ document.getElementById('lightbox').style.display = 'none'; }
function showPrev(){ if(currentPhotos.length===0) return; currentIndex = (currentIndex-1+currentPhotos.length)%currentPhotos.length; document.getElementById('lightbox-img').src = currentPhotos[currentIndex]; }
function showNext(){ if(currentPhotos.length===0) return; currentIndex = (currentIndex+1)%currentPhotos.length; document.getElementById('lightbox-img').src = currentPhotos[currentIndex]; }
document.getElementById('close').onclick = closeLightbox;
document.getElementById('prev').onclick = showPrev;
document.getElementById('next').onclick = showNext;
document.getElementById('lightbox').onclick = e=>{ if(e.target.id==='lightbox') closeLightbox(); };

// 聚焦到地圖 + 照片
function focusTo(title){
  const mk = markerIndex[norm(title)];
  if(mk){
    const ll = mk.getLatLng();
    mk.openPopup();
    map.flyTo(ll, Math.max(map.getZoom(), 14), {duration:0.6});
  }
  setPhotosForKey(title);
}

// 文字複製（雙保險）
function copyText(text){
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(()=> alert('已複製：\n' + text)).catch(()=>{
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('已複製：\n' + text);
    });
  } else {
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    alert('已複製：\n' + text);
  }
}

// ---------------- Load data ----------------
Promise.all([
  fetch(FILE_TIMELINE).then(r=>r.text()),
  fetch(FILE_PHOTOS).then(r=>r.ok?r.text():""),
  fetch(FILE_COORDS).then(r=>r.ok?r.json():{})
]).then(([csvTimeline,csvPhotos,coordOverride])=>{
  // coords override 索引（名稱容錯 + 別名）
  const coordIndex = {};
  if (coordOverride && typeof coordOverride === 'object') {
    Object.keys(coordOverride).forEach(k => { coordIndex[norm(k)] = coordOverride[k]; });
    // 別名：雨備(西友大船店) -> 西友 大船店
    if (coordOverride['西友 大船店']) {
      coordIndex[norm('雨備(西友大船店)')] = coordOverride['西友 大船店'];
    }
  }

  // 讀照片 CSV（支援 image/對應地點 與 url/place）
  if(csvPhotos){
    const rows = parseCSV(csvPhotos);
    rows.forEach(r=>{
      Object.keys(r).forEach(k=>{ const ck = k.replace(/^\ufeff/,''); if(ck!==k){ r[ck]=r[k]; delete r[k]; }});
      const kRaw = byKeys(r, ['key','Key','名稱','地點','place','title','對應地點']);
      const url  = byKeys(r, ['url','URL','link','image']);
      if(!kRaw || !url) return;
      const key = norm(kRaw);
      (photoMap[key] = photoMap[key] || []).push(url);
    });
  }

  // 讀行程 CSV
  const rows = parseCSV(csvTimeline);
  const tb = document.getElementById('timelineBody');
  if (tb) tb.innerHTML = '';

  rows.forEach(r=>{
    const start = get(r,'start');
    const end   = get(r,'end');
    const title = get(r,'title');
    const note  = get(r,'note');
    const cat   = get(r,'category');
    const code  = get(r,'mapcode');
    const link  = get(r,'link') || '#';
    const seqStr = get(r,'seq');
    const seq = seqStr ? parseFloat(seqStr) : NaN;

    // 判斷圖層（可同時多個）
    const textForFlag = `${cat||''} ${note||''}`;
    const isOptional = OPTIONAL_RE.test(textForFlag);
    const isRest = RESTROOM_RE.test(textForFlag) || !!get(r,'restroomCol');

    // 時間軸列（可點進地圖/照片；含複製）
    if (tb){
      const tr = el('tr','tr'); tr.style.cursor='pointer'; tr.onclick = ()=> focusTo(title);
      const td1 = el('td','td'); td1.style.width='110px'; td1.innerHTML = '<div class="time">'+toTimeBlock(start,end)+'</div>';
      const td2 = el('td','td');
      td2.innerHTML = `<div class="place">${title||''}</div><div class="badge">📍 <a href="${link}" target="_blank">Google 地圖</a></div>` + (note? `<div class="note">備註：${note}</div>`:'');
      const td3 = el('td','td'); td3.innerHTML = `<div class="cat">${(cat||'').replace(/\s/g,'')}</div>`;
      const td4 = el('td','td');
      const copyLabel = `${title||''}：${code||''}`;
      td4.innerHTML = `<div class="mapcode"><span class="car">🚗</span><span class="code">${code||''}</span><button class="copy" type="button" onclick="event.stopPropagation(); copyText('${copyLabel.replace(/'/g,"\\'")}')">複製</button></div>`;
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tb.appendChild(tr);
    }

    // 取得座標：coords-override > CSV lat/lng > Google 連結
    let latlng = null;
    if (title && coordIndex[norm(title)]) { latlng = coordIndex[norm(title)]; }
    else {
      const lat = get(r,'lat'); const lng = get(r,'lng');
      if (lat && lng) latlng = [parseFloat(lat), parseFloat(lng)];
      if (!latlng) {
        const byLink = extractLatLngFromLink(link);
        if (byLink) latlng = byLink;
      }
    }
    if (!latlng) return; // 沒座標就不畫

    // 產生 popup 內容（含複製鈕）
    const popupCopy = `${title||''}：${code||''}`.replace(/'/g,"\\'");
    const popHtml = `
      <div class="popup-title">${title||''}</div>
      ${code? `<div class="mapcode"><span class="car">🚗</span><span class="code">${code}</span><button class="copy" type="button" onclick="copyText('${popupCopy}')">複製</button></div>`:''}
      ${note? `<div class="popup-note">${note}</div>`:''}
      <div class="popup-link"><a href="${link}" target="_blank">📍 Google 地圖</a></div>
    `;

    // 建 marker 的小工廠（讓同一點可以出現在多個圖層）
    const makeMarker = ()=>{
      const m = L.marker(latlng, { title }).on('click', ()=> setPhotosForKey(title));
      m.bindPopup(popHtml,{ closeButton:true, autoPan:true, autoPanPaddingTopLeft:[16,16], autoPanPaddingBottomRight:[16,16] });
      return m;
    };

    // 主行程(預設)
    let assignedToAny = false;
    if (!isOptional && !isRest) {
      const m = makeMarker(); gMain.addLayer(m); assignedToAny = true; routeNodes.push({ seq, latlng });
      if (!markerIndex[norm(title)]) markerIndex[norm(title)] = m;
    }
    // 可有可無
    if (isOptional) {
      const m = makeMarker(); gOptional.addLayer(m); assignedToAny = true;
      if (!markerIndex[norm(title)]) markerIndex[norm(title)] = m;
    }
    // 廁所
    if (isRest) {
      const m = makeMarker(); gRest.addLayer(m); assignedToAny = true;
      if (!markerIndex[norm(title)]) markerIndex[norm(title)] = m;
    }
    // 若三者都不是（真的純主行程），上面第一段已加到主行程
    if (!assignedToAny) {
      // 已加到主行程
    }
  });

  // 畫主行程連線（只連主行程）
  routeNodes.sort((a,b)=>{
    const A = isNaN(a.seq) ? Number.POSITIVE_INFINITY : a.seq;
    const B = isNaN(b.seq) ? Number.POSITIVE_INFINITY : b.seq;
    return A - B;
  });
  const routePoints = routeNodes.map(n => n.latlng);
  if (routePoints.length > 1) {
    routeLine = L.polyline(routePoints, { color:'#5ea0ff', weight:3, opacity:0.85 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [20,20] });
    if (cMain && !cMain.checked) { map.removeLayer(routeLine); }
  }
}).catch(err=>{
  console.error(err);
  const tb = document.getElementById('timelineBody');
  if (tb) tb.innerHTML = '<tr><td colspan="4" class="td">讀取資料失敗，請確認 CSV / JSON 檔案是否與 index 同層。</td></tr>';
});
</script>
</body>
</html>
