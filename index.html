<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025 行程 9/20 鎌倉</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; background: #0d1117; color: #e6edf3; }
    #map { height: 60vh; }
    .layer-control { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 6px; }
    .photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 6px; padding: 10px; }
    .photos img { width: 100%; border-radius: 6px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #444; padding: 6px; font-size: 14px; }
    th { background: #222; }
  </style>
</head>
<body>
  <h2>2025 行程｜澀谷→鎌倉</h2>
  <div id="map"></div>
  <h3>照片牆（點任一標記顯示相簿）</h3>
  <div id="photos" class="photos"></div>
  <h3>時間軸（9/20 +15 分鐘緩衝版）</h3>
  <div style="overflow-x:auto;">
    <table id="timeline"></table>
  </div>

  <script>
    const map = L.map('map').setView([35.32, 139.55], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layers
    const mainLayer = L.layerGroup().addTo(map);
    const optionalLayer = L.layerGroup().addTo(map);
    const toiletLayer = L.layerGroup().addTo(map);

    const layerControl = {
      "主行程/精華或近似": mainLayer,
      "可有可無": optionalLayer,
      "廁所": toiletLayer
    };
    L.control.layers(null, layerControl, { collapsed:false, position:'topright' }).addTo(map);

    // Load JSON for coords
    async function loadCoords() {
      const res = await fetch('coords-override-2025-09-20.json');
      return await res.json();
    }

    // Load CSVs
    async function loadCSV(file) {
      return new Promise((resolve) => {
        Papa.parse(file, {
          download: true,
          header: true,
          complete: (results) => resolve(results.data)
        });
      });
    }

    async function init() {
      const coords = await loadCoords();
      const timeline = await loadCSV('timeline-2025-09-20_v6.csv');
      const photos = await loadCSV('photos-2025-09-20-mapped.csv');

      const photoMap = {};
      photos.forEach(p => {
        if (!photoMap[p["地點"]]) photoMap[p["地點"]] = [];
        photoMap[p["地點"]].push(p["檔名"]);
      });

      const route = [];
      timeline.forEach(row => {
        if (!row["地點 / 活動"]) return;
        const name = row["地點 / 活動"].trim();
        const latlng = coords[name];
        if (!latlng) return;

        let marker = L.marker(latlng);
        marker.bindPopup(`<b>${name}</b><br/>${row["備註"]||""}`);
        marker.on('click', () => {
          document.getElementById("photos").innerHTML =
            (photoMap[name]||[]).map(f=>`<img src="assets/img/${f}" alt="${name}">`).join("");
        });

        if (row["類別"]==="可有可無") optionalLayer.addLayer(marker);
        else if (row["類別"]==="廁所") toiletLayer.addLayer(marker);
        else { mainLayer.addLayer(marker); route.push(latlng); }
      });

      if(route.length>0) L.polyline(route, { color:"blue" }).addTo(mainLayer);

      // Timeline Table
      const table = document.getElementById("timeline");
      table.innerHTML = "<tr><th>時間</th><th>地點 / 活動</th><th>備註</th><th>類別</th><th>車Map Code</th></tr>";
      timeline.forEach(row=>{
        table.innerHTML += `<tr>
          <td>${row["時間起"]||""}-${row["時間迄"]||""}</td>
          <td>${row["地點 / 活動"]||""}</td>
          <td>${row["備註"]||""}</td>
          <td>${row["類別"]||""}</td>
          <td>${row["🚙車Map Code"]||""}</td>
        </tr>`;
      });
    }
    init();
  </script>
</body>
</html>
