<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>2025 行程｜澀谷→鎌倉→箱根→熱海→伊豆半島</title>
<style>
  :root{--bg:#0b1020;--fg:#eef1f7;--muted:#a6b0c2;--card:#131a2b;--acc:#6ea8fe}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#0b1020;color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
  header{padding:12px;border-bottom:1px solid #1f2a44;position:sticky;top:0;background:rgba(11,16,32,.95);z-index:10}
  h1{margin:0;font-size:15px}
  .tabs{margin-top:8px;display:flex;gap:8px;overflow-x:auto}
  .tab{flex:0 0 auto;padding:8px 12px;border-radius:999px;border:1px solid #28406d;color:#cfe1ff}
  .tab.active{background:linear-gradient(135deg,#244a8b,#6ea8fe);color:#081126;border-color:transparent;font-weight:700}
  .container{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
  .card{background:rgba(19,26,43,.7);border:1px solid #1f2a44;border-radius:14px;overflow:hidden}
  iframe{width:100%;height:60vh;border:0;display:block;background:#0b0f1d}
  .right{padding:12px}
  .section-title{font-size:15px;margin:0 0 8px;color:#cfe1ff}
  .gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .gallery.hidden{display:none}
  .ph{border-radius:10px;overflow:hidden;background:#0f1527;border:1px solid #26325a}
  .ph button{all:unset;display:block}
  .ph img{width:100%;display:block;aspect-ratio:4/3;object-fit:cover}
  .timeline{padding:10px}
  table{width:100%;border-collapse: collapse;font-size:14px}
  th,td{border-bottom:1px solid #1f2a44;padding:8px 6px;text-align:left;vertical-align:top}
  .poi-link{color:#b7d2ff;text-decoration:none;border-bottom:1px dotted #517bd9}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>2025 東京近郊旅｜澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</h1>
  <div class="tabs">
    <div class="tab active" data-day="2025-09-20">9/20 鎌倉</div>
    <div class="tab" data-day="2025-09-21">9/21</div>
    <div class="tab" data-day="2025-09-22">9/22</div>
    <div class="tab" data-day="2025-09-23">9/23</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <iframe id="mapFrame" src="map-2025-09-20-from-csv-v7b.html"></iframe>
  </section>
  <aside class="card right">
    <div class="section-title">照片牆</div>
    <div class="hint" id="hint">在左邊地圖點選任一景點標記，我會顯示該景點的相簿。</div>
    <div id="gallery" class="gallery hidden"></div>
  </aside>
</main>

<section class="card timeline" style="margin:0 12px 12px">
  <div class="section-title">時間軸（9/20 +15分鐘緩衝版）</div>
  <div class="hint">資料來自：<code>timeline-2025-09-20_v6.csv</code></div>
  <div id="timeline"></div>
</section>
<p id="err" style="color:#ffaeae;padding:0 12px 12px;"></p>
<footer style="padding:12px;color:#8ea2c8;text-align:center">© 2025 Ayumi 行程地圖</footer>

<script>
const DAY_CFG={"2025-09-20":{photosCSV:"photos-2025-09-20-mapped.csv",timelineCSV:"timeline-2025-09-20_v6.csv"}};
function parseCSV(text){
  const rows=[]; let row=[],field='',inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"'){ if(inQ&&n=='"'){ field+='"'; i++; } else inQ=!inQ; }
    else if(c==',' && !inQ){ row.push(field); field=''; }
    else if((c=='\n'||c=='\r') && !inQ){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } if(c=='\r'&&n=='\n') i++; }
    else field+=c;
  } if(field!==''||row.length){ row.push(field); rows.push(row); }
  let header = rows.shift()||[]; header = header.map(h=>(h||'').replace(/^\uFEFF/,'').trim());
  return rows.filter(r=>r.length && r.some(x=>x && x.trim()!='')).map(cols=>{ const o={}; header.forEach((h,i)=>o[h]=(cols[i]||'').trim()); return o; });
}
function normalizeTitle(t){ return (t||"").replace(/^[0-9①-⑳\.\s]+/g,'').trim(); }
function pick(row,names){
  const keys=Object.keys(row).map(k=>k.replace(/\s/g,'').replace(/\uFEFF/g,''));
  for(const n of names){ const want=n.replace(/\s/g,''); for(let i=0;i<keys.length;i++){ if(keys[i]===want) return row[Object.keys(row)[i]]; } } return "";
}
/* 相片牆（最小實作：只做你現有 CSV 的對應） */
let photosData=[];
async function loadPhotos(csvPath){ try{ const r=await fetch(csvPath); if(!r.ok) return; const t=await r.text(); photosData=parseCSV(t);}catch(e){} }
function renderPhotos(place){
  const g=document.getElementById('gallery'); const hint=document.getElementById('hint'); g.innerHTML='';
  const title=normalizeTitle(place); const rows=photosData.filter(r=>normalizeTitle(r["對應地點"])===title);
  if(!rows.length){ hint.textContent=`這個景點暫無相片：${title}`; g.classList.add('hidden'); return; }
  hint.textContent=`${title} 的相片：`; g.classList.remove('hidden');
  rows.forEach(r=>{ const div=document.createElement('div'); div.className='ph'; div.innerHTML=`<button><img loading="lazy" alt="${r.title||title}" src="${r.image}"></button>`; g.appendChild(div); });
}
/* 時間軸包含車Map Code欄位 */
async function loadTimeline(csvPath){
  const r=await fetch(csvPath); if(!r.ok){document.getElementById('err').textContent='時間軸CSV載入失敗：'+r.status; return;}
  const t=await r.text(); const rows=parseCSV(t);
  const wrap=document.getElementById('timeline'); const tbl=document.createElement('table');
  tbl.innerHTML='<thead><tr><th>時間</th><th>地點 / 活動</th><th>備註</th><th>類別</th><th>🚙車Map Code</th></tr></thead>'; const tb=document.createElement('tbody');
  for(const row of rows){
    const time=(pick(row,["時間起"])||"") + ((pick(row,["時間迄"])||"")?`–${pick(row,["時間迄"])}`:"");
    const place=pick(row,["地點/活動"])||row["地點 / 活動"]||""; const link=pick(row,["📍景點連結"])||row["📍 景點連結"]||"";
    const note=(pick(row,["備註"])||"").replace(/\n/g,'<br>');
    const car=pick(row,["🚙車MapCode","🚙車Map Code"])||"";
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${time}</td><td>${place} ${link?`<a class="poi-link" target="_blank" href="${link}">📍</a>`:""}</td><td class="muted">${note}</td><td class="muted">${pick(row,["類別"])||""}</td><td class="muted">${car}</td>`;
    tb.appendChild(tr);
  } tbl.appendChild(tb); wrap.innerHTML=''; wrap.appendChild(tbl);
}
/* Listeners */
window.addEventListener('message',(ev)=>{ const d=ev.data||{}; if(d.type==='marker-click' && d.place){ renderPhotos(d.place); } });
(async()=>{ const cfg=DAY_CFG["2025-09-20"]; await loadPhotos(cfg.photosCSV); await loadTimeline(cfg.timelineCSV); })();
</script>
</body></html>
