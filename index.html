<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è¡Œç¨‹ç¸½è¦½ï½œå·¦ï¼šåœ°åœ–ï½œå³ï¼šç…§ç‰‡ï½œä¸‹ï¼šCSV æ™‚é–“è»¸ï¼ˆv3 with è»ŠMap Codeï¼‰</title>
  <style>
    :root{ --primary:#2563eb; --accent:#22c55e; --text:#e5e7eb; --muted:#9ca3af; --ring: rgba(37,99,235,.35); }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;color:var(--text);background: radial-gradient(1200px 600px at 80% -10%, #1f2937 0%, #0b1022 50%, #010409 100%);}
    header{position:sticky;top:0;z-index:50;backdrop-filter: blur(8px);background: rgba(2,6,23,.6);border-bottom:1px solid rgba(255,255,255,.06);}
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    nav{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent)); box-shadow:0 0 12px var(--ring)}
    .brand h1{font-size:18px;margin:0}
    main .section{padding:28px 16px}
    .hero{text-align:center;padding:56px 16px 12px;}
    .hero h2{margin:0 0 8px 0;font-size:clamp(22px,3.2vw,34px)}
    .hero p{margin:0;color:var(--muted)}
    .datebar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0 0}
    .datebtn{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);color:#c7d2fe;padding:10px 14px;border-radius:12px;cursor:pointer;transition: all .18s ease;}
    .datebtn:hover{transform:translateY(-1px); box-shadow:0 8px 18px var(--ring)}
    .datebtn.active{background:linear-gradient(135deg,var(--primary),var(--accent)); color:white; border-color:transparent}
    .grid{display:grid;gap:16px}
    @media(min-width:960px){ .grid2col{grid-template-columns: 1.25fr .75fr}}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px; padding:16px;box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    #mapframe{width:100%;height:520px;border:0;border-radius:12px;background:#0b1022}
    .photogrid{display:grid;grid-template-columns: repeat(2, 1fr); gap:10px}
    @media(min-width:1200px){ .photogrid{grid-template-columns: repeat(3, 1fr);} }
    .photo{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#0b1022}
    .photo img{width:100%;height:140px;object-fit:cover;display:block}
    .photo .cap{padding:8px;font-size:13px;color:#cbd5e1}
    .photo a{color:#93c5fd;text-decoration:none}
    .timeline{position:relative;padding:8px 0 8px 18px}
    .timeline::before{content:""; position:absolute; left:6px; top:0; bottom:0; width:4px;background: linear-gradient(var(--primary), var(--accent));border-radius:4px;}
    .titem{position:relative; margin:14px 0; padding:12px 12px 12px 16px;background: rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;}
    .titem::before{content:""; position:absolute; left:-2px; top:18px; width:10px; height:10px; border-radius:50%;background: white; box-shadow:0 0 0 6px var(--ring);}
    time{color:#c7d2fe; font-weight:600}
    .muted{color:#9ca3af}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.2);padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    footer{padding:32px 16px; text-align:center; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <nav>
        <div class="brand">
          <span class="dot"></span>
          <h1>Ayumi Trip 2025</h1>
        </div>
        <div style="color:#cbd5e1">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <h2>é»ä¸‹æ–¹æ—¥æœŸï¼šå·¦ã€Œäº’å‹•åœ°åœ–ã€ï½œå³ã€Œç…§ç‰‡ã€ï½œä¸‹ã€ŒCSV æ™‚é–“è»¸ã€</h2>
      <div class="datebar" id="datebar">
        <button class="datebtn" data-day="2025-09-20">9/20</button>
        <button class="datebtn" data-day="2025-09-21">9/21</button>
        <button class="datebtn" data-day="2025-09-22">9/22</button>
        <button class="datebtn" data-day="2025-09-23">9/23</button>
      </div>
    </section>

    <section id="upper" class="section">
      <div class="wrap grid grid2col">
        <div class="card">
          <iframe id="mapframe" title="äº’å‹•åœ°åœ–"></iframe>
        </div>
        <div class="card">
          <h3 style="margin-top:0">ç…§ç‰‡</h3>
          <div id="photos" class="photogrid"></div>
          <div id="photoHint" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <section id="lower" class="section">
      <div class="wrap">
        <div class="card">
          <h3 style="margin-top:0">æ™‚é–“è»¸ï¼ˆå« ğŸš™ è»Š Map Codeï¼‰</h3>
          <div id="timeline" class="timeline"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">Â© 2025 Ayumi</div>
  </footer>

  <script>
    const CONFIG = {
      "2025-09-20": {
        label: "9/20 æ¾€è°· â†’ éŒå€‰",
        iframe: "map-2025-09-20-v2.html",
        photosCsv: "photos-2025-09-20.csv",
        timelineCsv: "timeline-2025-09-20_v3.csv"
      },
      "2025-09-21": { label: "9/21 ç®±æ ¹ï¼ˆå¾…è£œï¼‰", iframe:"", photosCsv:"", timelineCsv:"" },
      "2025-09-22": { label: "9/22 ç†±æµ· â†’ ä¼Šè±†ï¼ˆå¾…è£œï¼‰", iframe:"", photosCsv:"", timelineCsv:"" },
      "2025-09-23": { label: "9/23ï¼ˆå¾…è£œï¼‰", iframe:"", photosCsv:"", timelineCsv:"" }
    };

    // Robust CSV parser (supports quoted fields and commas within quotes)
    function parseCSV(text){
      const rows = [];
      let row = [], field = '', inQuotes = false;
      for(let i=0;i<text.length;i++){
        const c = text[i], n = text[i+1];
        if(c === '"' ){
          if(inQuotes && n === '"'){ field += '"'; i++; } // escaped quote
          else inQuotes = !inQuotes;
        } else if(c === ',' && !inQuotes){
          row.push(field); field='';
        } else if((c === '\n' || c === '\r') && !inQuotes){
          if(field !== '' || row.length){ row.push(field); rows.push(row); row=[]; field=''; }
          // handle \r\n by skipping the next \n
          if(c === '\r' && n === '\n'){ i++; }
        } else {
          field += c;
        }
      }
      if(field !== '' || row.length){ row.push(field); rows.push(row); }
      // convert to objects by header
      const header = rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length && r.some(x=>x && x.trim()!=='')).map(cols => {
        const obj = {};
        header.forEach((h,idx)=> obj[h] = (cols[idx]||'').trim());
        return obj;
      });
    }

    async function renderPhotos(csvPath){
      const box = document.getElementById('photos');
      const hint = document.getElementById('photoHint');
      box.innerHTML = ""; hint.textContent = "";
      if(!csvPath){ hint.textContent = "æ­¤æ—¥å°šæœªæä¾›ç…§ç‰‡æ¸…å–®ã€‚"; return; }
      try{
        const res = await fetch(csvPath);
        const text = await res.text();
        const rows = parseCSV(text);
        if(rows.length === 0){ hint.textContent = "CSV æ²’æœ‰è³‡æ–™ã€‚"; return; }
        rows.forEach(r => {
          const img = r.image;
          const title = r.title || "";
          const caption = r.caption || "";
          const link = r.link ? `<a href="${r.link}" target="_blank">ğŸ“ é€£çµ</a>` : "";
          const div = document.createElement('div');
          div.className = 'photo';
          div.innerHTML = `<img src="${img}" alt="${title}"><div class="cap"><div>${title} ${link}</div><div class="muted" style="font-size:12px">${caption}</div></div>`;
          box.appendChild(div);
        });
        hint.textContent = "æç¤ºï¼šæŠŠåœ–ç‰‡ä¸Šå‚³åˆ° assets/img/ ä¸¦åœ¨ CSV è£¡å¡«å…¥ç›¸å°è·¯å¾‘å³å¯é¡¯ç¤ºã€‚";
      }catch(e){
        hint.textContent = "è®€å–ç…§ç‰‡ CSV å¤±æ•—ï¼Œè«‹ç¢ºèªæª”åèˆ‡è·¯å¾‘ã€‚";
      }
    }

    async function renderTimeline(csvPath){
      const tl = document.getElementById('timeline');
      tl.innerHTML = "";
      if(!csvPath){
        const div = document.createElement('div');
        div.className = 'titem';
        div.innerHTML = `<div class="muted">æ­¤æ—¥çš„æ™‚é–“è»¸å°šæœªä¸Šç·šï¼ˆè«‹æä¾› CSVï¼‰</div>`;
        tl.appendChild(div);
        return;
      }
      try{
        const res = await fetch(csvPath);
        const text = await res.text();
        const rows = parseCSV(text);
        rows.forEach(r => {
          const link = r["ğŸ“ æ™¯é»é€£çµ"] ? `<a href="${r["ğŸ“ æ™¯é»é€£çµ"]}" target="_blank" style="color:#93c5fd;text-decoration:none">ğŸ“ é€£çµ</a>` : "";
          const toilet = r["ğŸš» å»æ‰€"] ? `<span class="pill" style="border-color:#22c55e33">ğŸš» ${r["ğŸš» å»æ‰€"]}</span>` : "";
          const carcode = r["ğŸš™è»ŠMap Code"] ? `<span class="pill">ğŸš™ ${r["ğŸš™è»ŠMap Code"]}</span>` : "";
          const time = (r["æ™‚é–“èµ·"]||"") + (r["æ™‚é–“è¿„"]?`â€“${r["æ™‚é–“è¿„"]}`:"");
          const note = r["å‚™è¨»"] ? `<div class="muted">${r["å‚™è¨»"]}</div>` : "";
          const cate = r["é¡åˆ¥"] ? `<span class="pill" style="border-color:#60a5fa33">#${r["é¡åˆ¥"]}</span>` : "";
          const title = r["åœ°é» / æ´»å‹•"] || "(æœªå‘½å)";
          const div = document.createElement('div');
          div.className = 'titem';
          div.innerHTML = `<div><time>${time}</time> ${title} ${cate} ${toilet} ${carcode} ${link}</div>${note}`;
          tl.appendChild(div);
        });
      }catch(e){
        const err = document.createElement('div');
        err.className = 'titem';
        err.innerHTML = `<div class="muted">è®€å– CSV å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆèˆ‡è·¯å¾‘ã€‚</div>`;
        tl.appendChild(err);
      }
    }

    async function renderDay(dayKey){
      const data = CONFIG[dayKey]; if(!data) return;
      const frame = document.getElementById('mapframe');
      if(data.iframe){ frame.src = data.iframe; frame.style.display='block'; }
      else{
        frame.src='about:blank'; frame.style.display='block';
        frame.contentWindow.document.open();
        frame.contentWindow.document.write(`<html><body style="margin:0;background:#0b1022;color:#9ca3af;display:flex;align-items:center;justify-content:center;height:100%"><div>æ­¤æ—¥çš„äº’å‹•åœ°åœ–å°šæœªä¸Šç·šï¼ˆè«‹æä¾›ç´ æï¼‰</div></body></html>`);
        frame.contentWindow.document.close();
      }
      renderPhotos(data.photosCsv);
      renderTimeline(data.timelineCsv);
    }

    const datebar=document.getElementById('datebar');
    datebar.addEventListener('click',e=>{
      const btn=e.target.closest('.datebtn'); if(!btn) return;
      for(const b of datebar.querySelectorAll('.datebtn')) b.classList.remove('active');
      btn.classList.add('active'); renderDay(btn.dataset.day);
    });

    const btnDefault = datebar.querySelector('[data-day="2025-09-20"]');
    btnDefault.classList.add('active'); renderDay("2025-09-20");
  </script>
</body>
</html>
