<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 東京近郊旅</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{
  --bg:#0e1724;
  --panel:#0f2033;
  --panel2:#0c1a29;
  --text:#e7f0ff;
  --muted:#97a6c5;
  --accent:#3b82f6;
  --chip:#172a44;
  --chip-ring:#2a4c7e;
  --mapcode:#ffd7a6;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 600px at 50% -100px,#12263f 0%,#0b1626 60%,#081320 100%);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:#9ec7ff}
.container{max-width:1000px;margin:0 auto;padding:8px 14px 40px}
/* Header */
.appbar{position:sticky;top:0;z-index:50;background:linear-gradient(#0d1a2b 0%, rgba(13,26,43,.85) 80%, rgba(13,26,43,.4) 100%);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
.title{font-weight:800;letter-spacing:.02em;margin:6px 0 2px;font-size:28px}
.sub{color:var(--muted);font-size:14px;margin-bottom:8px}
/* Day buttons */
.days{display:flex;gap:14px;overflow:auto;padding:6px 2px 10px}
.daybtn{flex:0 0 auto;display:flex;flex-direction:column;justify-content:center;align-items:center;width:120px;height:70px;border-radius:36px;border:2px solid var(--chip-ring);background:var(--chip);color:var(--text);box-shadow:inset 0 0 0 2px rgba(255,255,255,.02)}
.daybtn .big{font-size:22px;font-weight:700}
.daybtn .small{font-size:12px;opacity:.9;margin-top:2px}
.daybtn.active{outline:3px solid rgba(62,136,255,.35)}
/* Map */
.section-title{font-weight:700;margin:18px 0 10px}
.map-wrap{position:relative;border-radius:14px;overflow:hidden;background:#09121d;border:1px solid rgba(255,255,255,.08);z-index:0}
#map{height:60vh;min-height:380px}
.map-toolbar{position:absolute;right:10px;top:10px;display:flex;flex-direction:column;gap:10px;z-index:5}
.ctrl{background:rgba(8,19,32,.85);border:1px solid rgba(255,255,255,.08);color:var(--text);border-radius:14px;padding:12px;backdrop-filter:blur(6px)}
.ctrl label{display:flex;align-items:center;gap:10px;margin:6px 2px}
.ctrl input{width:18px;height:18px}
.vbtns{display:flex;flex-direction:column;gap:10px}
.vbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:14px;border:1px solid rgba(255,255,255,.1);width:90px;height:90px;background:rgba(9,18,29,.9);backdrop-filter:blur(4px);}
.vbtn .line{display:block}
.fullbtn{position:absolute;left:12px;top:12px;z-index:5;background:#0e2136;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:6px 10px}
.badge{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--chip-ring);padding:2px 8px;border-radius:22px;font-size:12px}
.mapcode{background:var(--mapcode);color:#5b3a00;border-radius:22px;padding:6px 10px;font-weight:700;display:inline-flex;gap:8px;align-items:center}
.copy{cursor:pointer;border:1px solid rgba(0,0,0,.15);background:#fff1e1;color:#5b3a00;border-radius:10px;padding:2px 6px;font-size:12px}
.popup-title{font-weight:800;font-size:18px;margin-bottom:6px}
.pop-remark{color:#c7d4f5}
/* Photos */
#photowall{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:820px){#photowall{grid-template-columns:repeat(4,1fr)}}
.photo{aspect-ratio:16/10;background:#0a1a2b;border:1px solid rgba(255,255,255,.06);border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;color:#7f95b7}
.photo img{width:100%;height:100%;object-fit:cover}
/* Timeline */
.table-wrap{position:relative;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;background:#0b1626;margin-top:8px}
.table-head{position:sticky;top:92px; /* just below appbar*/ z-index:20;background:#0d1a2b;border-bottom:1px solid rgba(255,255,255,.08);display:grid;grid-template-columns:88px 1.4fr 0.9fr 0.9fr 150px;padding:10px 12px;font-weight:700}
.row{display:grid;grid-template-columns:88px 1.4fr 0.9fr 0.9fr 150px;padding:12px;border-top:1px solid rgba(255,255,255,.06)}
.row:nth-child(odd){background:#0c1a29}
.time{font-weight:700;white-space:pre-line}
.place .g{display:inline-flex;gap:6px;align-items:center}
.chip{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.15);background:#0e2136;border-radius:999px;padding:6px 10px}
/* 備註單獨一列 */
.remark-row{display:grid;grid-template-columns:88px 1fr;gap:10px;padding:12px;border-top:1px dashed rgba(255,255,255,.12);background:#0b1a2b}
.remark-label{color:#9fb4da;font-weight:700;text-align:right;padding-right:6px}
.remark-text{white-space:normal}
/* Utils */
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
.hidden{display:none}
</style>
</head>
<body>
<div class="appbar">
  <div class="container">
    <div class="title">2025 東京近郊旅</div>
    <div class="sub">澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</div>
    <div class="days" id="days">
      <button class="daybtn active" data-day="2025-09-20"><span class="big">09/20</span><span class="small">鎌倉</span></button>
      <button class="daybtn" disabled><span class="big">09/21</span><span class="small">箱根</span></button>
      <button class="daybtn" disabled><span class="big">09/22</span><span class="small">熱海</span></button>
      <button class="daybtn" disabled><span class="big">09/23</span><span class="small">河口湖</span></button>
    </div>
  </div>
</div>

<div class="container">
  <div class="section-title">互動地圖（點圖標看資訊 / 點任一標記顯示相簿）
    <button class="fullbtn" id="fullbtn">全螢幕</button>
  </div>
  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-toolbar">
      <div class="ctrl" id="layerCtrl">
        <label><input type="checkbox" id="chkMain" checked/> 主行程/精華或近似</label>
        <label><input type="checkbox" id="chkOpt" checked/> 可有可無</label>
        <label><input type="checkbox" id="chkWc" checked/> 廁所</label>
      </div>
      <div class="vbtns">
        <button class="vbtn" id="btnHere" title="我在這"><span class="line">我</span><span class="line">在</span><span class="line">這</span></button>
        <button class="vbtn" id="btnFollow" title="跟隨我"><span class="line">跟</span><span class="line">隨</span><span class="line">我</span></button>
      </div>
    </div>
  </div>

  <div class="section-title">照片牆（點任一標記顯示相簿）</div>
  <div id="photowall"><div class="photo">暫無照片</div></div>

  <div class="section-title">時間軸（9/20 +15 分鐘緩衝版）</div>
  <div style="color:#9fb4da;margin:-8px 0 8px">本頁讀取：<span class="mono">timeline-2025-09-20_v6.csv</span>、<span class="mono">photos-2025-09-20-mapped.csv</span>、<span class="mono">coords-override-2025-09-20.json</span></div>
  <div class="table-wrap" id="timeline">
    <div class="table-head">
      <div>時間</div><div>地點 / 活動</div><div>備註</div><div>類別</div><div>車Map Code</div>
    </div>
    <div id="rows"></div>
  </div>
</div>

<script>
const CSV_PATH = 'timeline-2025-09-20_v6.csv';
const PHOTOS_CSV = 'photos-2025-09-20-mapped.csv';
const COORDS_JSON = 'coords-override-2025-09-20.json';

// Leaflet init
const map = L.map('map',{zoomControl:false}).setView([35.318,139.55], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,attribution:'&copy; OpenStreetMap'
}).addTo(map);
L.control.zoom({position:'topleft'}).addTo(map);

// Layer groups
const gMain=L.layerGroup().addTo(map);
const gOpt=L.layerGroup().addTo(map);
const gWc=L.layerGroup().addTo(map);
const polyMain=L.polyline([], {color:'#3ea0ff',weight:4,opacity:0.7}).addTo(map);

const markerIcon = L.icon({
  iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-28]
});

let coordsOverride={};
let photoMap={}; // name -> array of urls

function copyText(t){navigator.clipboard && navigator.clipboard.writeText(t).catch(()=>{});}

// load coords
fetch(COORDS_JSON).then(r=>r.json()).then(j=>{coordsOverride=j}).catch(()=>{});

// load photos
Papa.parse(PHOTOS_CSV,{download:true,header:true,complete:(res)=>{
  res.data.forEach(r=>{
    const key=(r['地點/活動']||r['地點 / 活動']||'').trim();
    const url=(r['照片連結']||r['URL']||r['url']||'').trim();
    if(!key||!url) return;
    (photoMap[key]=photoMap[key]||[]).push(url);
  });
}});

// Map helpers
function getCoordByName(name){
  const override = coordsOverride && coordsOverride[name];
  if(override && override.length===2) return override;
  // fallback: try simple heuristic (鎌倉市中心)
  return [35.318,139.55];
}

function buildPopup(row){
  const place=row['地點 / 活動']||row['地點/活動']||'';
  const remark=(row['備註']||'').replace(/\n/g,'<br/>');
  const gmap=row['📍 景點連結']||row['景點連結']||row['Google']||'';
  const wc=row['🚻 廁所']||'';
  const code=(row['🚙車Map Code']||'').trim();
  const codeHtml = code?`<span class="mapcode"><span>${code}</span><button class="copy" onclick="copyText('${code}')">複製</button></span>`:'';
  return `
    <div class="popup">
      <div class="popup-title">${place}</div>
      ${codeHtml}
      <div class="pop-remark" style="margin:8px 0 6px;${wc?'':'opacity:.9'}">
        ${wc?'<span class="badge">🚻 廁所：'+wc+'</span><br/>':''}
        ${remark||''}
      </div>
      ${gmap?`<div><a target="_blank" href="${gmap}">📍 Google 地圖</a></div>`:''}
    </div>`;
}

function addPhotoWallFor(name){
  const box=document.getElementById('photowall');
  box.innerHTML='';
  const arr=photoMap[name]||[];
  if(!arr.length){ box.innerHTML='<div class="photo">暫無照片</div>'; return; }
  arr.forEach(u=>{
    const div=document.createElement('div'); div.className='photo';
    const img=document.createElement('img'); img.src=u; div.appendChild(img);
    box.appendChild(div);
  });
}

// Load timeline CSV -> map + table
Papa.parse(CSV_PATH,{download:true,header:true,skipEmptyLines:true,complete:(res)=>{
  const rows=res.data;
  const mainRouteCoords = [];
  const rowsWrap=document.getElementById('rows');

  rows.forEach((r,i)=>{
    const name=(r['地點 / 活動']||r['地點/活動']||'').trim();
    if(!name) return;

    const latlng=getCoordByName(name);
    const m=L.marker(latlng,{icon:markerIcon}).bindPopup(buildPopup(r));
    const cat=(r['類別']||'').trim();
    const isWC=(r['🚻 廁所']||'').trim();
    const layer = isWC ? gWc : (cat==='可有可無'? gOpt : gMain);
    m.addTo(layer).on('click',()=> addPhotoWallFor(name));

    if(cat!=='可有可無' && !isWC){
      mainRouteCoords.push(latlng);
    }

    // timeline DOM
    const time=`${(r['時間起']||'').trim()}\n${(r['時間迄']||'').trim()}`;
    const gmap=r['📍 景點連結']||'';
    const code=(r['🚙車Map Code']||'').trim();

    const rowEl=document.createElement('div');
    rowEl.className='row';
    rowEl.innerHTML=`
      <div class="time">${time}</div>
      <div class="place">
        <div style="font-weight:800">${name}</div>
        ${gmap?`<div class="g">📍 <a target="_blank" href="${gmap}">Google 地圖</a></div>`:''}
      </div>
      <div class="remark-cell"></div>
      <div>${cat||''}</div>
      <div>${code?`<span class="chip mono">🚗 ${code} <button class="copy" onclick="copyText('${code}')">複製</button></span>`:''}</div>
    `;
    rowsWrap.appendChild(rowEl);

    // remark separate row
    const rk=(r['備註']||'').trim();
    if(rk){
      const rEl=document.createElement('div');
      rEl.className='remark-row';
      rEl.innerHTML=`<div class="remark-label">備註</div><div class="remark-text">${rk.replace(/\n/g,'<br/>')}</div>`;
      rowsWrap.appendChild(rEl);
    }
  });

  if(mainRouteCoords.length>1){
    polyMain.setLatLngs(mainRouteCoords);
    map.fitBounds(polyMain.getBounds().pad(0.2));
  }else{
    map.setView(mainRouteCoords[0]||[35.318,139.55],12);
  }
}});

// layer toggles
document.getElementById('chkMain').addEventListener('change',e=>{
  if(e.target.checked){ gMain.addTo(map); polyMain.addTo(map); } else { map.removeLayer(gMain); map.removeLayer(polyMain); }
});
document.getElementById('chkOpt').addEventListener('change',e=>{
  if(e.target.checked) gOpt.addTo(map); else map.removeLayer(gOpt);
});
document.getElementById('chkWc').addEventListener('change',e=>{
  if(e.target.checked) gWc.addTo(map); else map.removeLayer(gWc);
});

// fullscreen toggle
let full=false;
document.getElementById('fullbtn').addEventListener('click',()=>{
  const m=document.getElementById('map');
  full=!full;
  m.style.height = full?'86vh':'60vh';
  map.invalidateSize();
});

// geolocation
let watchId=null;
const meLayer=L.layerGroup().addTo(map);
function showMe(pos){
  meLayer.clearLayers();
  const {latitude,longitude}=pos.coords;
  L.circleMarker([latitude,longitude],{radius:7,color:'#00d0ff',fill:true,fillOpacity:.8}).addTo(meLayer);
}
document.getElementById('btnHere').addEventListener('click',()=>{
  if(!navigator.geolocation){ alert('此裝置不支援定位'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    showMe(pos); map.flyTo([pos.coords.latitude,pos.coords.longitude], 14, {duration:.6});
  },()=>alert('無法取得定位'),{enableHighAccuracy:true,timeout:8000,maximumAge:0});
});
document.getElementById('btnFollow').addEventListener('click',()=>{
  if(!navigator.geolocation){ alert('此裝置不支援定位'); return; }
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; alert('已停止跟隨'); return; }
  watchId=navigator.geolocation.watchPosition((pos)=>{
    showMe(pos); map.setView([pos.coords.latitude,pos.coords.longitude]);
  },()=>{}, {enableHighAccuracy:true,timeout:8000,maximumAge:0});
  alert('開始跟隨（再次點擊可停止）');
});
</script>
</body>
</html>
