<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>2025 行程｜澀谷→鎌倉→箱根→熱海→伊豆半島</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--text:#e6edf3;--muted:#9aa4b2;--brand:#60a5fa}
*{box-sizing:border-box}
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto}
a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}
/* Header (safe-area sticky) */
header{position:sticky;top:0;z-index:99;background:rgba(9,13,25,.9);backdrop-filter:blur(10px);
  padding: calc(8px + env(safe-area-inset-top)) 12px 8px 12px;border-bottom:1px solid #1f2937}
header .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.25rem}
.tab{padding:.3rem .7rem;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
.tab.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
.wrap{max-width:1100px;margin:0 auto;padding:10px}
/* Layout: mobile 1-col, >=820px 2-col */
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media (min-width:820px){.grid{grid-template-columns:1.05fr .95fr}}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:10px}
h2{margin:.2rem 0 .6rem 0;font-size:1.05rem}
/* Map block */
.mapBox{position:relative}
#map{height:60vh;border-radius:10px;border:1px solid #1f2937}
.mapTop{position:absolute;right:10px;top:10px;display:flex;gap:6px;z-index:40}
.btn{cursor:pointer;border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:6px 10px}
.btn:hover{background:#111827}
/* Gallery */
.gallery{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media (min-width:820px){.gallery{grid-template-columns:repeat(3,1fr)}}
.gallery img{width:100%;height:180px;object-fit:cover;border-radius:10px;border:1px solid #1f2937;cursor:pointer}
/* Lightbox */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center}
#lightbox img{max-width:92vw;max-height:86vh;border-radius:10px}
/* Timeline */
details{background:#0d1426;border:1px solid #1f2937;border-radius:12px}
summary{list-style:none;padding:10px 12px;cursor:pointer}
summary::-webkit-details-marker{display:none}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-top:1px solid #1f2937;padding:8px 10px;vertical-align:top}
.badge{display:inline-block;padding:2px 8px;border:1px solid #334155;border-radius:999px;color:#cbd5e1;margin-left:6px}
.code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#fff6d6;color:#1f2937;border:1px solid #f59e0b;border-radius:8px;padding:1px 6px}
small.muted{color:var(--muted)}
footer{color:#94a3b8;font-size:12px;text-align:center;padding:14px 0}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div><b>2025 東京近郊旅</b> ｜ 澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</div>
    <div class="tabs">
      <button class="tab active" onclick="switchDay('d0920', this)">9/20 鎌倉</button>
      <button class="tab" onclick="switchDay('d0921', this)">9/21</button>
      <button class="tab" onclick="switchDay('d0922', this)">9/22</button>
      <button class="tab" onclick="switchDay('d0923', this)">9/23</button>
      <a class="tab" href="https://github.com" target="_blank" style="margin-left:auto">GitHub Pages</a>
    </div>
  </div>
</header>

<div class="wrap grid">
  <div class="card mapBox">
    <div class="mapTop">
      <button class="btn" id="fullBtn" onclick="toggleMap()">全螢幕地圖</button>
    </div>
    <div id="map" aria-label="互動地圖"></div>
  </div>

  <div class="card" id="rightCol">
    <h2>照片牆</h2>
    <div id="photogrid" class="gallery"></div>
  </div>

  <div class="card" style="grid-column:1/-1">
    <h2>時間軸 <small class="muted">(9/20 +15分緩衝版)</small></h2>
    <details id="tlBox" open>
      <summary>展開 / 收合</summary>
      <div style="padding:8px 10px">
        <div style="margin-bottom:6px"><small class="muted">資料來源：timeline-2025-09-20_v6.csv</small></div>
        <table class="table" id="tl"></table>
      </div>
    </details>
  </div>
</div>

<div id="lightbox" onclick="closeLightbox()">
  <img id="lbimg" alt="預覽圖"/>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DAY_CFG={ d0920:{ csv:'timeline-2025-09-20_v6.csv', photos:'photos-2025-09-20-mapped.csv' } };
let CURRENT='d0920', MAP, mainLayer, optLayer;

function initMap(){
  MAP=L.map('map').setView([35.31,139.53], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(MAP);
  mainLayer=L.layerGroup().addTo(MAP);
  optLayer=L.layerGroup().addTo(MAP);
  loadDay(CURRENT);
}

function parseCSV(t){const r=[];let row=[],f='',q=false;for(let i=0;i<t.length;i++){const c=t[i],n=t[i+1];if(c=='"'){if(q&&n=='"'){f+='"';i++;}else q=!q;}else if(c==','&&!q){row.push(f);f='';}else if((c=='\n'||c=='\r')&&!q){if(f!==''||row.length){row.push(f);r.push(row);row=[];f='';}if(c=='\r'&&n=='\n')i++;}else f+=c;}if(f!==''||row.length){row.push(f);r.push(row);}const h=r.shift().map(x=>x.replace(/^\uFEFF/,'').trim());return r.map(cols=>{const o={};h.forEach((k,i)=>o[k]=cols[i]||'');return o;});}
function normTitle(t){return (t||'').replace(/^[0-9①-⑳\.\s]+/,'').trim();}
function coordFrom(url){try{const u=new URL(url);if(u.searchParams.get('query')){const [la,lo]=u.searchParams.get('query').split(',').map(Number);return [la,lo];}}catch(e){}return null;}
async function geo(title){await new Promise(r=>setTimeout(r,800));const q=encodeURIComponent(title+' Kamakura Kanagawa Japan');const r=await fetch('https://nominatim.openstreetmap.org/search?q='+q+'&format=json&limit=1',{headers:{'Accept-Language':'zh-TW'}});if(!r.ok)return null;const j=await r.json();if(j&&j[0])return[+j[0].lat,+j[0].lon];return null;}

async function loadDay(key){
  const cfg=DAY_CFG[key];
  mainLayer.clearLayers(); optLayer.clearLayers();
  const csvTxt=await fetch(cfg.csv).then(r=>r.text());
  const rows=parseCSV(csvTxt).filter(r=>normTitle(r['地點 / 活動']));
  let bounds=[];
  for(const r of rows){
    const title=normTitle(r['地點 / 活動']);
    const link=r['📍 景點連結']||''; const car=r['🚙車Map Code']||''; const wc=r['🚻 廁所']||'';
    const kind=(r['類別']||''); const note=(r['備註']||'');
    const isOpt=/可有可無/.test(kind+note);
    let xy = coordFrom(link);
    if(!xy){ xy = await geo(title); }
    if(!xy){ continue; }
    const mk = L.marker(xy);
    const chip = car?`<span class="code">${car}</span> <button class="btn" style="padding:2px 6px;margin-left:6px" onclick="navigator.clipboard.writeText('${car}')">複製</button>`:'';
    mk.bindPopup(`<b>${title}</b>`
      + (car?`<br>🚙 車Map Code：${chip}`:'')
      + (wc?`<br>🚻 ${wc}`:'')
      + (kind?`<br>類別：${kind}`:'')
      + (note?`<br>備註：${note}`:'')
      + (link?`<br><a target="_blank" href="${link}">📍 Google 地圖</a>`:'')
    );
    (isOpt?optLayer:mainLayer).addLayer(mk);
    bounds.push(xy);
  }
  if(bounds.length){ MAP.fitBounds(bounds, {padding:[20,20]}); }
  loadPhotos(cfg.photos);
  renderTimeline(rows);
}

async function loadPhotos(csv){
  const box=document.getElementById('photogrid'); box.innerHTML='';
  try{
    const txt=await fetch(csv).then(r=>r.text());
    const rows=parseCSV(txt);
    const titleNow = document.querySelector('.leaflet-popup-content b')?.textContent || '';
    const pics = rows.filter(r=>r['對應地點']===titleNow);
    if(pics.length===0){ box.innerHTML='<small class="muted">點左側地圖任一景點標記，我會顯示該景點的相簿。</small>'; return; }
    for(const p of pics){
      const img=document.createElement('img'); img.alt=p.title||p['對應地點']; img.loading='lazy';
      img.src=p.image; img.onclick=()=>openLightbox(p.image);
      box.appendChild(img);
    }
  }catch(e){ box.innerHTML='<small class="muted">（沒有相片或讀取失敗）</small>'; }
}

function renderTimeline(rows){
  const el=document.getElementById('tl');
  el.innerHTML='<tr><th style="width:70px">時間</th><th style="width:38%">地點／活動</th><th>備註</th><th style="width:80px">類別</th><th style="width:110px">車Map Code</th></tr>';
  for(const r of rows){
    const time = (r['時間起']||'')+'-'+(r['時間迄']||'');
    const title = normTitle(r['地點 / 活動']);
    const note = r['備註']||''; const kind = r['類別']||''; const car=r['🚙車Map Code']||'';
    el.insertAdjacentHTML('beforeend', `<tr>
      <td>${time}</td>
      <td>${title}<br>${(r['📍 景點連結']?`<a target="_blank" href="${r['📍 景點連結']}">📍 Google 地圖</a>`:'')}</td>
      <td>${note}${(r['🚻 廁所']?`<br>🚻 ${r['🚻 廁所']}`:'')}</td>
      <td>${kind.replace('可有可無','<span class="badge">可有可無</span>')}</td>
      <td>${car?`<span class="code">${car}</span>`:''}</td>
    </tr>`);
  }
}

function switchDay(key, btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  CURRENT = key;
  loadDay(key);
}

let fs=false;
function toggleMap(){
  fs=!fs;
  document.getElementById('map').style.height = fs? '86vh':'60vh';
  document.getElementById('fullBtn').textContent = fs? '還原高度':'全螢幕地圖';
  setTimeout(()=>{ MAP.invalidateSize(); }, 250);
}

function openLightbox(src){ const lb=document.getElementById('lightbox'); document.getElementById('lbimg').src=src; lb.style.display='flex'; }
function closeLightbox(){ document.getElementById('lightbox').style.display='none'; }

document.addEventListener('click', (e)=>{
  if(e.target.closest('.leaflet-marker-icon') || e.target.closest('.leaflet-popup')){
    setTimeout(()=>loadPhotos(DAY_CFG[CURRENT].photos), 80);
  }
});

initMap();
</script>
</body>
</html>