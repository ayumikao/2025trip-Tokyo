<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 東京近郊旅遊</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{
  --bg:#0f1720;        /* page background */
  --panel:#111a22;     /* cards */
  --panel-2:#0c131a;   /* deeper */
  --muted:#a8b2be;
  --text:#e8f0fa;
  --accent:#2e7cf6;
  --accent-2:#0ea5e9;
  --pill:#0c1824;
  --pill-border:#385d8e;
  --mapcode-bg:#2b2b2b;
  --mapcode-pill:#262b35;
  --mapcode-yellow:#f4c430;
  --chip-bg:#111c28;
  --chip-border:#23425f;
  --btn:#102033;
  --btn-hover:#14314d;
  --shadow: 0 8px 24px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:#0d1218;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
}
.container{
  max-width:980px;
  margin:0 auto;
  padding:20px 16px 64px;
}
/* Title + route */
.h1{
  font-weight:800;
  font-size: clamp(26px, 4.5vw, 40px);
  letter-spacing:.02em;
}
.route{
  margin-top:6px;
  color:#9fb1c5;
  font-size:14px;
}
/* Date pills */
.tabs{display:flex; gap:16px; align-items:center; padding:14px 0 6px; position:sticky; top:0; background:linear-gradient(180deg, rgba(13,18,24,.97), rgba(13,18,24,.92) 60%, rgba(13,18,24,0) 100%); z-index:10}
.tab{
  background:var(--pill);
  border:1.5px solid var(--pill-border);
  color:#dbe7f4;
  border-radius:22px;
  padding:10px 20px;
  min-width:120px;
  text-align:center;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
  cursor:pointer;
  user-select:none;
}
.tab.active{
  background:#0c2338;
  border-color:#3a6db3;
  box-shadow: 0 8px 20px rgba(25,80,140,.35);
}
.tab small{display:block; color:#a8b6c8; font-size:12px; margin-top:4px}
/* Card sections */
.card{
  background:var(--panel);
  border: 1px solid rgba(120,160,200,.14);
  border-radius:16px;
  padding:12px;
  box-shadow:var(--shadow);
}
.section-title{
  font-weight:700; letter-spacing:.02em; margin:14px 2px 10px;
}
/* Map block */
.map-wrap{ position:relative; border-radius:16px; overflow:hidden; }
#map{ height:460px; }
.leaflet-container{ background:#09111a; }
.zoom-fix .leaflet-top, .zoom-fix .leaflet-bottom{ z-index:1; } /* keep controls below our title row */
.map-overlay{ position:absolute; right:12px; top:12px; z-index:2; }
.layer-card{
  background: rgba(10,17,25,.88);
  border:1px solid rgba(120,160,200,.18);
  border-radius:14px;
  padding:10px 12px;
  display:flex; flex-direction:column; gap:10px;
  box-shadow:var(--shadow);
}
.layer-card label{ display:flex; gap:10px; align-items:center; font-size:14px; }
.layer-card input{ width:18px; height:18px; }
.vert-btns{ position:absolute; right:12px; top:160px; display:flex; flex-direction:column; gap:10px; z-index:2;}
.vbtn{
  background:var(--btn);
  border:1px solid rgba(120,160,200,.25);
  color:#e9f3ff;
  border-radius:14px;
  padding:10px 12px;
  line-height:1.1;
  box-shadow:var(--shadow);
  min-width:40px;
  text-align:center;
  cursor:pointer;
}
.vbtn:hover{ background:var(--btn-hover) }
.vbtn span{ display:block; }
.vbtn .line{ display:block; }
.vbtn .line + .line{ margin-top:4px; }
/* Photo wall */
#photoWall{ min-height:120px; display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:10px; }
.photo{
  width:100%; aspect-ratio: 4/3; background:#0d1a26; border:1px solid rgba(120,160,200,.14); border-radius:10px; overflow:hidden;
  display:flex;align-items:center;justify-content:center;color:#93a4b8; font-size:14px;
}
.photo img{ width:100%; height:100%; object-fit:cover; display:block}
/* Timeline */
.timeline{ margin-top:10px; }
.table{ width:100%; border-collapse:separate; border-spacing:0 14px; }
.tr{ background:#0f151c; border:1px solid rgba(120,160,200,.18); border-radius:12px; overflow:hidden; }
.th, .td{ padding:14px 16px; vertical-align:top; }
.head{ color:#bcd0e6; font-weight:700; font-size:15px; }
.time-cell{ width:96px; color:#d6e5f8; font-weight:700; }
.place-cell{ color:#eaf4ff; }
.type-cell{ width:72px; color:#cdd9ea; }
.mapcode-cell{ width:160px; }
.mapcode-pill{
  display:inline-flex; align-items:center; gap:8px;
  background:#1b2230; border:1px solid rgba(200,160,80,.35);
  color:var(--mapcode-yellow);
  padding:10px 14px;
  border-radius:18px;
  font-weight:800;
  letter-spacing:.5px;
}
.pin{ margin-right:6px }
/* Misc */
a{ color:#79aaff; }
.small{ color:#93a4b8; font-size:13px; }
.notice{ color:#9fb; }
</style>
</head>
<body>
  <div class="container">
    <div class="h1">2025 東京近郊旅遊</div>
    <div class="route">溫谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島 → 河口湖</div>

    <!-- Date tabs (no JS change, visual only) -->
    <div class="tabs">
      <div class="tab active" data-day="2025-09-20">09/20<small>鎌倉</small></div>
      <div class="tab" data-day="2025-09-21">09/21<small>箱根</small></div>
      <div class="tab" data-day="2025-09-22">09/22<small>熱海</small></div>
      <div class="tab" data-day="2025-09-23">09/23<small>伊豆半島</small></div>
    </div>

    <!-- Map -->
    <div class="card map-wrap zoom-fix" id="mapCard">
      <div id="map"></div>

      <!-- layer toggles IN MAP (top-right) -->
      <div class="map-overlay" id="layerBox">
        <div class="layer-card">
          <label><input type="checkbox" id="toggleMain" checked><span>主行程</span></label>
          <label><input type="checkbox" id="toggleOptional" checked><span>可有可無</span></label>
          <label><input type="checkbox" id="toggleToilet" checked><span>廁所</span></label>
        </div>
      </div>

      <!-- vertical buttons IN MAP (right) -->
      <div class="vert-btns">
        <button class="vbtn" id="btnLocate"><span class="line">我</span><span class="line">在</span><span class="line">這</span></button>
        <button class="vbtn" id="btnFollow"><span class="line">跟</span><span class="line">隨</span><span class="line">我</span></button>
      </div>
    </div>

    <!-- Photo wall -->
    <div class="section-title">照片牆（點任一標記顯示相簿）</div>
    <div class="card">
      <div id="photoWall"><div class="photo">暫無照片</div></div>
    </div>

    <!-- Timeline -->
    <div class="section-title">時間軸（9/20 +15 分鐘緩衝版）</div>
    <div class="small">本頁讀取：<span class="notice">timeline-2025-09-20_v6.csv</span>、photos-2025-09-20-mapped.csv、coords-override-2025-09-20.json</div>
    <div class="card timeline">
      <div class="head" style="display:grid;grid-template-columns:110px 1fr 86px 170px;gap:0 8px;padding:6px 6px 0 6px;">
        <div class="th">時間</div>
        <div class="th">地點 / 活動</div>
        <div class="th">類別</div>
        <div class="th">車Map Code</div>
      </div>
      <div id="tbody" style="display:flex; flex-direction:column; gap:14px; margin-top:6px;"></div>
    </div>
  </div>

<script>
/* ---------- Leaflet Map ---------- */
const map = L.map('map', { zoomControl: true }).setView([35.325, 139.55], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// marker layer groups
const groups = {
  main: L.layerGroup().addTo(map),
  optional: L.layerGroup().addTo(map),
  toilet: L.layerGroup().addTo(map),
};
let follow = false;
let locateWatchId = null;

// UI toggles inside map
const toggleMain = document.getElementById('toggleMain');
const toggleOptional = document.getElementById('toggleOptional');
const toggleToilet = document.getElementById('toggleToilet');
toggleMain.addEventListener('change', () => toggleLayer(groups.main, toggleMain.checked));
toggleOptional.addEventListener('change', () => toggleLayer(groups.optional, toggleOptional.checked));
toggleToilet.addEventListener('change', () => toggleLayer(groups.toilet, toggleToilet.checked));
function toggleLayer(layer, on){ on ? map.addLayer(layer) : map.removeLayer(layer); }

// Locate/Follow buttons
document.getElementById('btnLocate').addEventListener('click', () => {
  if(!navigator.geolocation){ alert('此裝置不支援定位'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const {latitude, longitude} = pos.coords;
    map.setView([latitude, longitude], 14, {animate:true});
    showMe([latitude, longitude]);
  }, err => { console.warn(err); });
});
document.getElementById('btnFollow').addEventListener('click', () => {
  if(!navigator.geolocation){ alert('此裝置不支援定位'); return; }
  follow = !follow;
  if(follow){
    locateWatchId = navigator.geolocation.watchPosition(pos => {
      const ll = [pos.coords.latitude, pos.coords.longitude];
      showMe(ll);
      map.panTo(ll, {animate:true});
    });
    document.getElementById('btnFollow').style.borderColor = '#3a6db3';
  }else{
    if(locateWatchId){ navigator.geolocation.clearWatch(locateWatchId); locateWatchId = null; }
    if(myMarker){ map.removeLayer(myMarker); myMarker = null; }
    document.getElementById('btnFollow').style.borderColor = 'rgba(120,160,200,.25)';
  }
});
let myMarker=null;
function showMe(latlng){
  if(!myMarker){
    myMarker = L.marker(latlng, {title:'我在這'}).addTo(map);
  }else{
    myMarker.setLatLng(latlng);
  }
}

/* ---------- Data Loading ---------- */
const CSV_TIMELINE = 'timeline-2025-09-20_v6.csv';
const CSV_PHOTOS   = 'photos-2025-09-20-mapped.csv';
const JSON_COORDS  = 'coords-override-2025-09-20.json';

// util: CSV via Papa
function loadCsv(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: reject
    });
  });
}

// Photos by key => [urls...]
let photosByKey = {};

// Override coords by key
let coordsOverride = {};

// Load photos + coords first (for markers click gallery)
Promise.all([
  loadCsv(CSV_PHOTOS).catch(()=>[]),
  fetch(JSON_COORDS).then(r=> r.ok ? r.json(): ({})).catch(()=>({}))
]).then(([photos, overrides])=>{
  coordsOverride = overrides || {};
  photosByKey = photos.reduce((acc,row)=>{
    const k = row.key || row.Key || row.title || row.name || '';
    if(!k) return acc;
    (acc[k] ||= []).push(row.url || row.image || row.photo || '');
    return acc;
  }, {});
}).finally(()=>{
  // Then load timeline and render
  loadTimeline();
});

async function loadTimeline(){
  let rows = await loadCsv(CSV_TIMELINE).catch(()=>[]);
  // Expect columns: start_time,end_time,title,category,mapcode,lat,lng,google_map_url,notes,type
  // Normalize keys:
  rows = rows.map(r=>{
    const obj = {};
    Object.keys(r).forEach(k=> obj[k.trim().toLowerCase()] = r[k]);
    return {
      start: obj.start || obj.start_time || obj['開始'] || obj['start time'] || '',
      end: obj.end || obj.end_time || obj['結束'] || '',
      title: obj.title || obj['地點'] || obj['名稱'] || obj['地點/活動'] || '',
      cat: obj.category || obj['類別'] || obj['類型'] || '',
      mapcode: obj.mapcode || obj['map code'] || obj['車map code'] || '',
      lat: parseFloat(obj.lat || obj.latitude || ''),
      lng: parseFloat(obj.lng || obj.longitude || ''),
      gmap: obj.google || obj['google 地圖'] || obj['google'] || obj['map'] || '',
      notes: obj.notes || obj['備註'] || ''
    };
  });

  renderTimeline(rows);
  addMarkersFromTimeline(rows);
}

function renderTimeline(rows){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  if(!rows || !rows.length){
    const empty = document.createElement('div');
    empty.className='small';
    empty.style.padding='16px';
    empty.textContent='（找不到資料，請確認 CSV 檔名與位置）';
    tbody.appendChild(empty);
    return;
  }
  rows.forEach(r=>{
    const row = document.createElement('div');
    row.className='tr';
    row.style.display='grid';
    row.style.gridTemplateColumns='110px 1fr 86px 170px';
    row.style.gap='0 8px';

    const time = document.createElement('div');
    time.className='td time-cell';
    time.innerHTML = (r.start||'') + (r.end? `<br>${r.end}`:'') ;

    const place = document.createElement('div');
    place.className='td place-cell';
    place.innerHTML = `<div style="font-weight:800; margin-bottom:6px;">${r.title || ''}</div>` +
      (r.gmap ? `<div class="small">📍 <a href="${r.gmap}" target="_blank" rel="noopener">Google 地圖</a></div>` : '') +
      (r.notes ? `<div class="small" style="margin-top:10px;">備註：${r.notes}</div>` : '');

    const type = document.createElement('div');
    type.className='td type-cell';
    type.textContent = r.cat || '';

    const code = document.createElement('div');
    code.className='td mapcode-cell';
    code.innerHTML = r.mapcode ? `<span class="mapcode-pill">🚗 ${r.mapcode}</span>` : '';

    row.appendChild(time);
    row.appendChild(place);
    row.appendChild(type);
    row.appendChild(code);
    tbody.appendChild(row);
  });
}

/* ---------- Markers + Photo wall ---------- */
function addMarkersFromTimeline(rows){
  const iconBlue = new L.Icon({
    iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
  });
  rows.forEach(r=>{
    if(!r.title) return;
    let lat = r.lat, lng = r.lng;
    const key = r.title.trim();
    if((!lat || !lng) && coordsOverride && coordsOverride[key]){
      lat = coordsOverride[key][0];
      lng = coordsOverride[key][1];
    }
    if(!lat || !lng) return;

    // which group by category keywords
    let group = groups.main;
    const c = (r.cat||'').toString();
    if(/廁|洗手/.test(c)) group = groups.toilet;
    if(/可有可無|順路|備用|備案/.test(c)) group = groups.optional;

    const m = L.marker([lat,lng], {icon:iconBlue, title:key}).addTo(group);
    const mc = r.mapcode ? `<div class="mapcode-pill">🚗 ${r.mapcode}</div>` : '';
    const gmap = r.gmap ? `<div style="margin-top:6px"><a href="${r.gmap}" target="_blank" rel="noopener">Google 地圖</a></div>`:'';
    m.bindPopup(`<div style="min-width:220px"><div style="font-weight:800">${key}</div>${mc}${gmap}</div>`);

    m.on('click', ()=> showPhotosFor(key));
  });
}

function showPhotosFor(key){
  const wall = document.getElementById('photoWall');
  wall.innerHTML = '';
  const list = photosByKey[key] || [];
  if(!list.length){
    wall.innerHTML = '<div class="photo">暫無照片</div>';
    return;
  }
  list.forEach(url=>{
    if(!url) return;
    const ph = document.createElement('div');
    ph.className='photo';
    const img = document.createElement('img');
    img.src = url;
    ph.appendChild(img);
    wall.appendChild(ph);
  });
}
</script>
</body>
</html>
