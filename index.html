<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>9/20 äº’å‹•åœ°åœ–ï¼‹ç…§ç‰‡ï¼‹æ™‚é–“è»¸ï¼ˆv87ï¼‰</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg:#0f172a; --fg:#e5e7eb; --muted:#9ca3af; --card:#0b1220; --border:#1f2937;
    --accent:#60a5fa; --route:#0891b2;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;}
  a{color:#93c5fd;text-decoration:none}
  header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(15,23,42,.96),rgba(15,23,42,.85));border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:10px 12px}
  h1{font-size:18px;margin:6px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:#0a0f1f;border:1px solid var(--border);border-radius:10px;padding:6px 10px;color:var(--fg);cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media(min-width:820px){ .grid{grid-template-columns: 1.2fr .8fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
  #map{height:60vh;border-radius:10px;border:1px solid var(--border)}
  @media(min-width:820px){ #map{height:72vh} }
  .legend{position:absolute;right:14px;top:14px;background:#fff;color:#111;border:1px solid #e2e8f0;border-radius:10px;padding:8px 12px;font-size:12px;box-shadow:0 8px 20px rgba(0,0,0,.15);z-index:20}
  .legend label{display:block;margin:4px 0}
 .legend {
  position:absolute;
  right:14px;
  top:14px;
  background:#111827d8;
  border:1px solid #374151;
  padding:8px;
  border-radius:8px;
  color:#e5e7eb;
  z-index:9999; /* æé«˜å±¤ç´š */
 }
  .muted{color:var(--muted)}
  .thumbs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  @media(min-width:820px){ .thumbs{grid-template-columns:repeat(3,minmax(0,1fr))} }
  .thumbs img{width:100%;height:140px;object-fit:cover;border-radius:8px;border:1px solid var(--border);cursor:pointer;background:#0a0f1f}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px;border-top:1px dashed #233046;vertical-align:top}
  .nowrap{white-space:nowrap}
  .mapcode{display:inline-flex;gap:6px;align-items:center;border:1px solid #475569;border-radius:999px;padding:1px 8px;font-size:12px}
  .copy{cursor:pointer;opacity:.85}
  .hud{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:#111827;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 12px;font-size:12px;z-index:40;display:none}
  .hud.show{display:block}
  /* Popup é«˜å°æ¯” */
  .leaflet-popup-content{color:#111}
  .leaflet-popup-content a{color:#2563eb}
  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:9999}
  .lightbox.active{display:flex}
  .lightbox img{max-width:92vw;max-height:88vh;border-radius:12px;border:1px solid #334155}
  .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:26px;color:#fff;cursor:pointer;user-select:none;padding:16px}
  .nav.left{left:8px}.nav.right{right:8px}
</style>
</head>
<body>
<header><div class="wrap">
  <h1>2025 æ±äº¬è¿‘éƒŠæ—…ï½œæ¾€è°·â†’éŒå€‰â†’ç®±æ ¹â†’ç†±æµ·â†’ä¼Šè±†åŠå³¶
    <button id="toggleFS" class="btn">å…¨è¢å¹•åœ°åœ–</button>
    <span class="muted">æœ¬é è®€å–ï¼štimeline-2025-09-20_v6.csvã€photos-2025-09-20-mapped.csvã€coords-override-2025-09-20.json</span>
  </h1>
</div></header>

<div class="wrap grid">
  <div class="card" style="position:relative">
    <div id="map" aria-label="äº’å‹•åœ°åœ–"></div>
    <div class="legend">
      <label><input type="checkbox" id="chk-main" checked> ä¸»è¡Œç¨‹/ç²¾è¯æˆ–è¿‘ä¼¼</label>
      <label><input type="checkbox" id="chk-opt" checked> å¯æœ‰å¯ç„¡</label>
      <label><input type="checkbox" id="chk-wc" checked> å»æ‰€</label>
    </div>
  </div>

  <div class="card">
    <div><strong>ç…§ç‰‡ç‰†</strong> <span class="muted">ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</span></div>
    <div id="photos" class="thumbs" style="margin-top:10px"></div>
  </div>

  <div class="card" style="grid-column:1 / -1">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div><strong>æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</strong></div>
      <button id="toggleT" class="btn">å±•é–‹ / æ”¶åˆ</button>
    </div>
    <div id="timeline" style="margin-top:8px">
      <table class="table">
        <thead><tr>
          <th class="nowrap">æ™‚é–“</th><th>åœ°é» / æ´»å‹•</th><th>å‚™è¨»</th><th class="nowrap">é¡åˆ¥</th><th class="nowrap">è»ŠMap Code</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="lightbox" class="lightbox" tabindex="-1">
  <div class="nav left" id="lbPrev">â€¹</div>
  <img id="lbImg" alt="photo"/>
  <div class="nav right" id="lbNext">â€º</div>
</div>

<div id="hud" class="hud"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// ---- å›ºå®šæª”åï¼ˆä¸å‹•ä½ çš„è³‡æ–™ï¼‰ ----
const FILE_TIMELINE = 'timeline-2025-09-20_v6.csv';
const FILE_PHOTOS   = 'photos-2025-09-20-mapped.csv';
const FILE_OVERRIDE = 'coords-override-2025-09-20.json';

// ---- åªåœ¨ index å…§è£œåº§æ¨™ï¼ˆä¸æ”¹ä½ çš„ JSONï¼‰ ----
const DEFAULT_COORDS = {
  'æ¾€è°·å‡ºç™¼ï¼ˆåŒ…è»Šï¼‰':[35.659,139.700],
  'éŒå€‰é‡œé£¯ kamakama ichibamaeten':[35.31733107267639,139.55070335429878],
  'é›¨å‚™(è¥¿å‹å¤§èˆ¹åº—)':[35.3541173153161,139.53365389550413]
};

const HUD = document.getElementById('hud');
function toast(msg){ HUD.textContent=msg; HUD.classList.add('show'); setTimeout(()=>HUD.classList.remove('show'), 3000); }

// ---- æ¬„ä½ç›¸å®¹ï¼šæ›´å¯¬é¬†åµæ¸¬ ----
function normHeader(h){ return (h||'').replace(/\uFEFF/g,'').replace(/\s+/g,'').toLowerCase(); }
function getTimelineColumns(header){
  const H = header.map(normHeader);
  function find(keys, def){
    for(const k of keys){
      const idx = H.indexOf(normHeader(k));
      if(idx>=0) return header[idx];
    }
    return def;
  }
  return {
    start:  find(['æ™‚é–“èµ·','start','é–‹å§‹','fromtime'], 'æ™‚é–“èµ·'),
    end:    find(['æ™‚é–“è¿„','end','çµæŸ','totime'], 'æ™‚é–“è¿„'),
    name:   find(['åœ°é»/æ´»å‹•','åœ°é»ï¼æ´»å‹•','åœ°é»','åç¨±','title','name','å°æ‡‰åœ°é»','æ™¯é»'], 'åœ°é» / æ´»å‹•'),
    note:   find(['å‚™è¨»','å‚™è€ƒ','note','notes','èªªæ˜'], 'å‚™è¨»'),
    cat:    find(['é¡åˆ¥','category','åˆ†é¡'], 'é¡åˆ¥'),
    link:   find(['ğŸ“æ™¯é»é€£çµ','æ™¯é»é€£çµ','é€£çµ','link','url','åœ°åœ–é€£çµ'], 'ğŸ“ æ™¯é»é€£çµ'),
    wc:     find(['ğŸš»å»æ‰€','å»æ‰€','wc','toilet'], 'ğŸš» å»æ‰€'),
    mapcode:find(['ğŸš™è»Šmapcode','è»Šmapcode','mapcode'], 'ğŸš™è»ŠMap Code')
  };
}
function getPhotosColumns(header){
  const H = header.map(normHeader);
  function find(keys, def){
    for(const k of keys){
      const idx = H.indexOf(normHeader(k));
      if(idx>=0) return header[idx];
    }
    return def;
  }
  return {
    place: find(['åœ°é»/æ´»å‹•','åœ°é»ï¼æ´»å‹•','åœ°é»','å°æ‡‰åœ°é»','place'], 'åœ°é» / æ´»å‹•'),
    files: find(['ç…§ç‰‡æª”å','æª”å','ç…§ç‰‡','ç›¸ç‰‡','image','images','files','filename'], 'ç…§ç‰‡æª”å')
  };
}

function isOptional(row, cols){
  const cat  = (row[cols.cat]  ||'').trim();
  const note = (row[cols.note] ||'').trim();
  return /å¯æœ‰å¯ç„¡/.test(cat) || /å¯æœ‰å¯ç„¡/.test(note);
}

function parseLatLngFromUrl(url=''){
  if(!url) return null;
  try{
    let m = url.match(/[?&]query=(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    m = url.match(/@(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    m = url.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
  }catch(e){}
  return null;
}

function parseTimeToSortKey(t){
  if(!t) return 0;
  const m=t.trim().match(/^(\d{1,2}):(\d{2})/);
  if(!m) return 0;
  return parseInt(m[1])*60 + parseInt(m[2]);
}

function loadCSV(path){
  return new Promise((resolve,reject)=>{
    Papa.parse(path, {download:true,header:true,skipEmptyLines:true,complete:res=>resolve(res), error:err=>reject(err)});
  });
}
async function loadJSON(path){ try{ const r=await fetch(path); if(!r.ok) return {}; return await r.json(); }catch(e){ return {}; } }

// Leaflet pin iconsï¼ˆé¿å…é†œé†œåœ“é»ï¼Œä¸¦ä¿®æ­£å½±åƒè·¯å¾‘ï¼‰
const IconDefault = L.Icon.extend({
  options:{
    iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
  }
});
const iconMain = new IconDefault();
const iconOpt  = new IconDefault({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png'});
const iconWC   = new IconDefault({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png'});

// åœ°åœ–
const map = L.map('map', {zoomControl:true}).setView([35.318,139.53], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(map);
const grpMain = L.layerGroup().addTo(map);
const grpOpt  = L.layerGroup().addTo(map);
const grpWC   = L.layerGroup().addTo(map);
let polyRoute = null;

function syncLayers(){
  document.getElementById('chk-main').checked ? map.addLayer(grpMain) : map.removeLayer(grpMain);
  document.getElementById('chk-opt').checked  ? map.addLayer(grpOpt)  : map.removeLayer(grpOpt);
  document.getElementById('chk-wc').checked   ? map.addLayer(grpWC)   : map.removeLayer(grpWC);
}
['chk-main','chk-opt','chk-wc'].forEach(id=>document.getElementById(id).addEventListener('change', syncLayers));

// Lightbox
let lbList=[], lbIdx=0;
const lb = document.getElementById('lightbox'), lbImg = document.getElementById('lbImg');
function openLB(i){ lbIdx=i; lbImg.src = lbList[lbIdx]; lb.classList.add('active'); lb.focus(); }
function closeLB(){ lb.classList.remove('active'); }
document.getElementById('lbPrev').onclick = ()=>{ if(lbList.length){ lbIdx=(lbIdx-1+lbList.length)%lbList.length; lbImg.src=lbList[lbIdx]; } };
document.getElementById('lbNext').onclick = ()=>{ if(lbList.length){ lbIdx=(lbIdx+1)%lbList.length; lbImg.src=lbList[lbIdx]; } };
lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLB(); });
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLB(); if(lb.classList.contains('active')){ if(e.key==='ArrowLeft') document.getElementById('lbPrev').click(); if(e.key==='ArrowRight') document.getElementById('lbNext').click(); } });

function createPopup(row, cols){
  const title = (row[cols.name]||'').trim();
  const note  = (row[cols.note]||'').trim();
  const url   = (row[cols.link]||'').trim();
  const wc    = (row[cols.wc]||'').trim();
  const code  = (row[cols.mapcode]||'').trim();
  const div = document.createElement('div');
  div.innerHTML = `
    <div style="font-weight:700">${title}</div>
    ${code?`<div class="mapcode">ğŸš™ ${code} <span class="copy" title="è¤‡è£½"> ğŸ“‹</span></div>`:''}
    ${wc?`<div class="muted">ğŸš» ${wc}</div>`:''}
    ${note?`<div class="muted">${note}</div>`:''}
    ${url?`<div><a href="${url}" target="_blank">ğŸ“ Google åœ°åœ–</a></div>`:''}
  `;
  setTimeout(()=>{
    const cp = div.querySelector('.copy');
    if(cp){ cp.onclick = ()=>{ navigator.clipboard.writeText(code); cp.textContent=' âœ…'; setTimeout(()=>cp.textContent=' ğŸ“‹',1200); }; }
  },0);
  return div;
}

function addMarker(row, latlng, cols, icon){
  const title = (row[cols.name]||'').trim();
  const mk = L.marker(latlng,{icon});
  mk.bindPopup(createPopup(row, cols));
  mk.on('click', ()=>showPhotosFor(title));
  return mk;
}

function showPhotosFor(place){
  const box = document.getElementById('photos'); box.innerHTML='';
  const items = gPhotos.filter(p=>p.place===place).flatMap(p=>p.files);
  lbList = items.map(fn=>`assets/img/${fn}`);
  if(items.length===0){ box.innerHTML = '<div class="muted">æ­¤æ™¯é»ç›®å‰æ²’æœ‰ä¸Šå‚³ç›¸ç‰‡ã€‚</div>'; return; }
  items.forEach((fn,idx)=>{
    const img = document.createElement('img');
    img.src = `assets/img/${fn}`; img.alt = place; img.loading='lazy';
    img.onclick = ()=>openLB(idx);
    box.appendChild(img);
  });
}

// globals
let gPhotos = [];

async function main(){
  try{
    const [tlRes, phRes, override] = await Promise.all([ loadCSV(FILE_TIMELINE), loadCSV(FILE_PHOTOS), loadJSON(FILE_OVERRIDE) ]);

    // æ¬„ä½å°æ‡‰
    const tlHeader = tlRes.meta.fields || [];
    const phHeader = phRes.meta.fields || [];
    if(!tlHeader.length){ toast('è®€ä¸åˆ°æ™‚é–“è»¸æ¬„ä½ï¼Œè«‹ç¢ºèª CSV ç·¨ç¢¼ç‚º UTF-8 ä¸¦å«è¡¨é ­'); }
    if(!phHeader.length){ toast('è®€ä¸åˆ°ç…§ç‰‡æ¸…å–®æ¬„ä½ï¼Œè«‹ç¢ºèª CSV ç·¨ç¢¼ç‚º UTF-8 ä¸¦å«è¡¨é ­'); }

    const cols = getTimelineColumns(tlHeader);
    const rows = tlRes.data || [];
    const {place:PH_PLACE, files:PH_FILES} = getPhotosColumns(phHeader);
    gPhotos = (phRes.data||[]).map(r=>({place:(r[PH_PLACE]||'').trim(), files:((r[PH_FILES]||'')+'').split('|').map(s=>s.trim()).filter(Boolean)}));

    // é»ä½
    const points = [];
    rows.forEach(r=>{
      const title = (r[cols.name]||'').trim();
      if(!title) return;
      let latlng = null;
      if(override && override[title]) latlng = override[title];
      if(!latlng) latlng = parseLatLngFromUrl(r[cols.link]||'');
      if(!latlng && DEFAULT_COORDS[title]) latlng = DEFAULT_COORDS[title];
      points.push({
        title, lat:latlng?latlng[0]:null, lng:latlng?latlng[1]:null,
        optional: isOptional(r, cols),
        hasWC: !!(r[cols.wc]||'').trim(),
        sortKey: parseTimeToSortKey(r[cols.start]||''),
        raw:r
      });
    });

    // ç•«é»
    points.forEach(p=>{
      if(p.lat==null || p.lng==null) return;
      const icon = p.optional ? iconOpt : iconMain;
      const mk = addMarker(p.raw, [p.lat,p.lng], cols, icon);
      (p.optional?grpOpt:grpMain).addLayer(mk);
      if(p.hasWC){
        const wcMk = L.marker([p.lat,p.lng],{icon:iconWC}).bindPopup('ğŸš» '+p.title);
        grpWC.addLayer(wcMk);
      }
    });

    // ä¸»è·¯ç·š
    const routePts = points.filter(p=>p.lat!=null && p.lng!=null && !p.optional).sort((a,b)=>a.sortKey-b.sortKey);
    if(polyRoute) map.removeLayer(polyRoute);
    if(routePts.length>=2){
      polyRoute = L.polyline(routePts.map(p=>[p.lat,p.lng]), {color:'#60a5fa', weight:4, opacity:.9}).addTo(map);
    }

    // è¦–é‡
    let bounds; try{ bounds = L.featureGroup([grpMain, grpOpt]).getBounds(); }catch(e){}
    if(bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
    else map.setView(DEFAULT_COORDS['æ¾€è°·å‡ºç™¼ï¼ˆåŒ…è»Šï¼‰']||[35.659,139.700], 12);

    // æ™‚é–“è»¸
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';
    rows.forEach(r=>{
      const t1=(r[cols.start]||'').trim(), t2=(r[cols.end]||'').trim();
      const title=(r[cols.name]||'').trim();
      const note=(r[cols.note]||'').trim();
      const cat=(r[cols.cat]||'').trim();
      const code=(r[cols.mapcode]||'').trim();
      const link=(r[cols.link]||'').trim();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="nowrap">${t1}${t2?('-'+t2):''}</td>
        <td>${title}${link?`ã€€<a href="${link}" target="_blank">ğŸ“ Google åœ°åœ–</a>`:''}</td>
        <td>${note||''}</td>
        <td class="nowrap">${cat||''}</td>
        <td>${code?`<span class="mapcode">ğŸš™ ${code}<span class="copy" title="è¤‡è£½"> ğŸ“‹</span></span>`:''}</td>`;
      tbody.appendChild(tr);
      const cp = tr.querySelector('.copy');
      if(cp){ cp.addEventListener('click',()=>{ navigator.clipboard.writeText(code); cp.textContent=' âœ…'; setTimeout(()=>cp.textContent=' ğŸ“‹',1200); }); }
    });

    // UI
    document.getElementById('toggleFS').addEventListener('click', ()=>{
      const el = document.getElementById('map');
      el.style.height = (el.style.height==='86vh') ? '60vh' : '86vh';
      setTimeout(()=>map.invalidateSize(), 200);
    });
    document.getElementById('toggleT').addEventListener('click', ()=>{
      const t = document.getElementById('timeline');
      t.style.display = (t.style.display==='none') ? '' : 'none';
    });

    syncLayers();

    // æç¤º
    if(!routePts.length) toast('æ²’æœ‰å¯ä¸²çš„ä¸»è¡Œç¨‹è·¯ç·šï¼ˆå¯èƒ½æ‰€æœ‰é»éƒ½æ¨™ç‚ºã€Œå¯æœ‰å¯ç„¡ã€æˆ–ç¼ºå°‘åº§æ¨™ï¼‰');
  }catch(err){
    console.error(err);
    toast('è®€å–éç¨‹å‡ºéŒ¯ï¼Œè«‹é–‹ DevTools Console æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯ã€‚');
  }
}
main();
</script>
</body>
</html>
