<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 æ±äº¬è¿‘éƒŠæ—…</title>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
  --bg:#0f172a;            /* èƒŒæ™¯ */
  --panel:#111827;         /* é¢æ¿ */
  --muted:#9ca3af;         /* æ¬¡å­—è‰² */
  --text:#e5e7eb;          /* ä¸»å­—è‰² */
  --accent:#3b82f6;        /* è— */
  --chip-bg:#ffedd5;       /* å¾ˆæ·ºçš„æ©˜åº• */
  --chip:#b45309;          /* æ·±æ©˜å­— */
  --ok:#22c55e;
  --warning:#f59e0b;
  --danger:#ef4444;
  --border:#1f2937;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans TC","Noto Sans",Arial;}
a{color:#93c5fd;text-decoration:none}
a:hover{text-decoration:underline}

.wrapper{max-width:980px;margin:0 auto;padding:16px 14px 80px;position:relative;z-index:1}
.header{position:sticky;top:0;z-index:1000;background:linear-gradient(180deg,rgba(15,23,42,.96),rgba(15,23,42,.9));backdrop-filter:blur(6px);padding:8px 14px 14px;margin:0 -14px 8px}
.title{font-size:28px;font-weight:800;letter-spacing:.5px}
.breadcrumb{color:var(--muted);margin-top:4px;font-size:16px}
.tabs{display:flex;gap:14px;margin-top:14px;flex-wrap:wrap}
.tab{padding:14px 24px;border-radius:999px;background:#0b1220;border:2px solid #24304a;color:#cbd5e1;cursor:pointer}
.tab.active{outline:3px solid #27477d;background:#0e1a2d;color:#fff}

.section{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin:14px 0}

.map-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
.map-title{font-weight:700}
.btn{border:1px solid #2b3446;background:#0c1220;color:#dbeafe;border-radius:12px;padding:8px 14px;cursor:pointer}
.btn:hover{background:#10192c}
.btn.small{padding:6px 10px;border-radius:10px;font-size:13px}

.map-wrap{position:relative}
#map{height:60vh;border-radius:12px;border:1px solid var(--border);overflow:hidden;z-index:1}
.leaflet-control-container .layer-toggle{display:flex;flex-direction:column;gap:8px}
.layer-panel{position:absolute;right:12px;top:12px;background:rgba(10,17,29,.88);backdrop-filter:blur(6px);border:1px solid #253041;border-radius:12px;padding:10px 12px;z-index:5}
.layer-panel label{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:14px;user-select:none}
.layer-panel input{width:18px;height:18px}

.locate-stack{position:absolute;right:12px;top:140px;display:flex;flex-direction:column;gap:10px;z-index:6}
.locbtn{display:flex;align-items:center;gap:8px;border:1px solid #253041;background:#0c1220;color:#dbeafe;border-radius:12px;padding:8px 12px;cursor:pointer}
.locbtn:hover{background:#111a2a}

.popup-title{font-weight:800;font-size:18px;color:#0f172a;margin-bottom:6px}
.popup-line{display:flex;align-items:center;gap:10px;margin:8px 0 10px}
.badge{display:inline-flex;align-items:center;gap:8px;background:var(--chip-bg);color:var(--chip);border-radius:999px;padding:6px 10px;font-weight:700}
.badge .copy{background:transparent;border:none;cursor:pointer}
.popup-text{color:#334155;line-height:1.6}
.popup-link{display:inline-flex;align-items:center;gap:6px;margin-top:6px}

.photos{min-height:80px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(min-width:820px){.photos{grid-template-columns:repeat(4,minmax(0,1fr))}}
.photo{height:120px;background:#0b1220;border:1px solid #223047;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover;}

.timeline-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:800px;background:#0d1423}
thead th{position:sticky;top:108px;background:#0e1526;z-index:20}
@media(min-width:820px){thead th{top:110px}}
th,td{padding:14px;border-bottom:1px solid #1a2336;vertical-align:top}
th{color:#cbd5e1;text-align:left;font-weight:700}
td{color:#e5e7eb}
.timecell div{line-height:1.2}
.note-row td{background:#0b1220;border-top:0;border-bottom:1px solid #1a2336}
.note-label{color:#9ca3af;width:80px}
.code-chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip-bg);color:var(--chip);border:1px solid #f8d6b3;padding:8px 12px;border-radius:999px;font-weight:800;white-space:nowrap}
.code-chip button{border:0;background:transparent;cursor:pointer}

.sticky-spacer{height:4px}
.hidden{display:none}
</style>
</head>
<body>
<div class="header">
  <div class="wrapper">
    <div class="title">2025 æ±äº¬è¿‘éƒŠæ—…</div>
    <div class="breadcrumb">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>
    <div class="tabs" id="dateTabs">
      <button class="tab active">9/20 éŒå€‰</button>
      <button class="tab">9/21</button>
      <button class="tab">9/22</button>
      <button class="tab">9/23</button>
    </div>
  </div>
</div>

<div class="wrapper">

  <div class="section">
    <div class="map-head">
      <div class="map-title">äº’å‹•åœ°åœ–ï¼ˆé»åœ–æ¨™çœ‹è³‡è¨Š / é»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</div>
      <button class="btn small" id="fullscreenBtn">å…¨è¢å¹•åœ°åœ–</button>
    </div>
    <div class="map-wrap">
      <div id="map"></div>
      <div class="layer-panel" id="layerPanel">
        <label><input type="checkbox" id="layerMain" checked>ä¸»è¡Œç¨‹</label>
        <label><input type="checkbox" id="layerOptional" checked>å¯æœ‰å¯ç„¡</label>
        <label><input type="checkbox" id="layerToilet" checked>å»æ‰€</label>
      </div>
      <div class="locate-stack">
        <button class="locbtn" id="btnLocate">ğŸ“ æˆ‘åœ¨é€™</button>
        <button class="locbtn" id="btnFollow">ğŸ›°ï¸ è·Ÿéš¨æˆ‘</button>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="map-head">
      <div class="map-title">ç…§ç‰‡ç‰†ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</div>
    </div>
    <div id="photos" class="photos"><div class="photo" style="grid-column:1/-1;display:flex;justify-content:flex-start;padding:12px;">æš«ç„¡ç…§ç‰‡</div></div>
  </div>

  <div class="section">
    <div class="timeline-head">
      <div class="map-title">æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</div>
      <button class="btn small" id="toggleT">å±•é–‹ / æ”¶åˆ</button>
    </div>
    <div style="color:var(--muted);font-size:12px;margin:-6px 0 8px;">
      æœ¬é è®€å–ï¼š<code>timeline-2025-09-20_v6.csv</code>ã€<code>photos-2025-09-20-mapped.csv</code>ã€<code>coords-override-2025-09-20.json</code>
    </div>
    <div class="table-wrap" id="tableWrap">
      <table id="timeline">
        <thead>
          <tr>
            <th style="width:90px">æ™‚é–“</th>
            <th style="min-width:220px">åœ°é» / æ´»å‹•</th>
            <th style="min-width:220px">å‚™è¨»</th>
            <th style="width:90px">é¡åˆ¥</th>
            <th style="width:140px">è»ŠMap Code</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---- å·¥å…· ----
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const sleep = ms => new Promise(r=>setTimeout(r,ms));

// CSV è§£æï¼ˆæ”¯æ´å¼•è™Ÿï¼‰
function parseCSV(text){
  const rows=[]; let row=[], cur='', inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"'){
      if(inQ && n=='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    } else if(c==',' && !inQ){ row.push(cur); cur=''; }
    else if((c=='\\n' || c=='\\r') && !inQ){
      if(c=='\\r' && n=='\\n'){ i++; }
      row.push(cur); rows.push(row); row=[]; cur='';
    } else cur+=c;
  }
  if(cur.length || row.length) { row.push(cur); rows.push(row); }
  // å» BOM çš„ header
  if(rows.length && rows[0][0].charCodeAt(0)===65279){ rows[0][0]=rows[0][0].slice(1); }
  const header=rows.shift();
  return rows.filter(r=>r.some(v=>v.trim()!=='')).map(r=>Object.fromEntries(header.map((h,i)=>[h.trim(), (r[i]??'').trim()])));
}

// fetch ä¸‰ä»½è³‡æ–™
async function loadAll(){
  const [csvT, csvP, jCoords] = await Promise.all([
    fetch('timeline-2025-09-20_v6.csv').then(r=>r.text()),
    fetch('photos-2025-09-20-mapped.csv').then(r=>r.text()),
    fetch('coords-override-2025-09-20.json').then(r=>r.json())
  ]);
  const timeline = parseCSV(csvT);
  const photos = parseCSV(csvP);
  const coords = jCoords;

  // è½‰ç›¸ç°¿ï¼šname -> [imgs]
  const photoMap = {};
  photos.forEach(row=>{
    const name = (row['åœ°é» / æ´»å‹•']||row['name']||'').trim();
    const imgs = Object.values(row).slice(1).map(v=>v.trim()).filter(v=>v);
    if(name && imgs.length) photoMap[name]=imgs;
  });
  return {timeline, photoMap, coords};
}

// Leaflet åˆå§‹åŒ–
const map = L.map('map',{zoomControl:false, attributionControl:true}).setView([35.324,139.53], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution:'&copy; OpenStreetMap'
}).addTo(map);
L.control.zoom({position:'topleft'}).addTo(map);

// ä¸‰å€‹åœ–å±¤
const layerMain = L.layerGroup().addTo(map);
const layerOptional = L.layerGroup().addTo(map);
const layerToilet = L.layerGroup().addTo(map);
let routeLine = null;
let followWatchId = null;

// UI æ§åˆ¶
$('#layerMain').addEventListener('change', e=>{
  if(e.target.checked) map.addLayer(layerMain); else map.removeLayer(layerMain);
  if(routeLine){ e.target.checked ? map.addLayer(routeLine) : map.removeLayer(routeLine); }
});
$('#layerOptional').addEventListener('change', e=>{
  if(e.target.checked) map.addLayer(layerOptional); else map.removeLayer(layerOptional);
});
$('#layerToilet').addEventListener('change', e=>{
  if(e.target.checked) map.addLayer(layerToilet); else map.removeLayer(layerToilet);
});

$('#fullscreenBtn').addEventListener('click', ()=>{
  const el = $('#map');
  const full = el.dataset.full === '1';
  if(full){
    el.style.height='60vh';
    el.dataset.full='0';
    $('#fullscreenBtn').textContent='å…¨è¢å¹•åœ°åœ–';
  }else{
    el.style.height='86vh';
    el.dataset.full='1';
    $('#fullscreenBtn').textContent='é‚„åŸåœ°åœ–';
  }
  setTimeout(()=>map.invalidateSize(), 250);
});

// å®šä½
$('#btnLocate').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('é€™å€‹è£ç½®ä¸æ”¯æ´å®šä½'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const latlng=[pos.coords.latitude,pos.coords.longitude];
    L.marker(latlng,{title:'æˆ‘åœ¨é€™'}).addTo(map);
    map.flyTo(latlng, 14, {duration:0.8});
  }, err=>alert('å®šä½å¤±æ•—ï¼š'+err.message));
});
$('#btnFollow').addEventListener('click', (ev)=>{
  if(followWatchId){
    navigator.geolocation.clearWatch(followWatchId);
    followWatchId=null;
    ev.target.textContent='ğŸ›°ï¸ è·Ÿéš¨æˆ‘';
    return;
  }
  if(!navigator.geolocation){ alert('é€™å€‹è£ç½®ä¸æ”¯æ´å®šä½'); return; }
  followWatchId = navigator.geolocation.watchPosition(pos=>{
    const latlng=[pos.coords.latitude,pos.coords.longitude];
    L.circleMarker(latlng,{radius:6,color:'#60a5fa'}).addTo(map);
    map.panTo(latlng);
  }, err=>alert('å®šä½å¤±æ•—ï¼š'+err.message), {enableHighAccuracy:true, maximumAge:1000});
  ev.target.textContent='ğŸ›°ï¸ è¿½è¹¤ä¸­ï¼ˆå†æŒ‰é—œé–‰ï¼‰';
});

// ç”Ÿæˆå…§å®¹
function twTime(hm){ // 09:00 -> 9:00
  return hm.replace(/^0/,'').replace(/:00$/,':00');
}

function makePopupHTML(row){
  const title = (row['åœ°é» / æ´»å‹•']||'').trim();
  const note = (row['å‚™è¨»']||'').trim().replace(/\\n/g,'<br>');
  const code = (row['ğŸš™è»ŠMap Code']||row['è»ŠMap Code']||'').trim();
  const g = (row['ğŸ“ æ™¯é»é€£çµ']||'').trim();
  return `
  <div class="popup-title">${title}</div>
  <div class="popup-line">
    ${code?`<span class="badge">ğŸš— ${code}<button class="copy" title="è¤‡è£½" onclick="navigator.clipboard.writeText('${code}');">ğŸ“‹</button></span>`:''}
  </div>
  ${note?`<div class="popup-text">${note}</div>`:''}
  ${g?`<div class="popup-link">ğŸ“ <a target="_blank" href="${g}">Google åœ°åœ–</a></div>`:''}
  `;
}

function addRow(tbody,row){
  const tr=document.createElement('tr');
  // æ™‚é–“å…©è¡Œ
  const s = (row['æ™‚é–“èµ·']||'').trim();
  const e = (row['æ™‚é–“è¿„']||'').trim();
  const timeHTML = `<div class="timecell"><div>${s}</div><div>${e}</div></div>`;
  tr.innerHTML = `
    <td>${timeHTML}</td>
    <td><div style="font-weight:800">${(row['åœ°é» / æ´»å‹•']||'').trim()}</div>
        ${(row['ğŸ“ æ™¯é»é€£çµ']||'').trim()?`<div><a target="_blank" href="${row['ğŸ“ æ™¯é»é€£çµ'].trim()}">ğŸ“ Google åœ°åœ–</a></div>`:''}
    </td>
    <td></td>
    <td>${(row['é¡åˆ¥']||'').trim()}</td>
    <td>${(row['ğŸš™è»ŠMap Code']||row['è»ŠMap Code']||'').trim()?`<span class="code-chip">ğŸš— ${(row['ğŸš™è»ŠMap Code']||row['è»ŠMap Code']).trim()} <button title="è¤‡è£½" onclick="navigator.clipboard.writeText('${(row['ğŸš™è»ŠMap Code']||row['è»ŠMap Code']).trim()}')">ğŸ“‹</button></span>`:''}</td>
  `;
  tbody.appendChild(tr);
  // å‚™è¨»ç¨ç«‹æ©«åˆ—
  const note = (row['å‚™è¨»']||'').trim();
  if(note){
    const tr2=document.createElement('tr');
    tr2.className='note-row';
    tr2.innerHTML=`<td class="note-label">å‚™è¨»</td><td colspan="4" class="note-text">${note.replace(/\\n/g,'<br>')}</td>`;
    tbody.appendChild(tr2);
  }
}

function ensurePhotosWall(images){
  const wall = $('#photos');
  wall.innerHTML='';
  if(!images || !images.length){
    wall.innerHTML='<div class="photo" style="grid-column:1/-1;display:flex;justify-content:flex-start;padding:12px;">æš«ç„¡ç…§ç‰‡</div>';
    return;
  }
  images.forEach(src=>{
    const d=document.createElement('div');
    d.className='photo';
    const img=new Image();
    img.src=src; img.loading='lazy';
    img.onerror=()=>{d.textContent='è¼‰å…¥å¤±æ•—';};
    d.appendChild(img);
    wall.appendChild(d);
  });
}

async function main(){
  const {timeline, photoMap, coords} = await loadAll();

  // æ¨™è¨˜ & è·¯ç·š
  const seen=new Set();
  const routePoints=[];

  for(const row of timeline){
    const name=(row['åœ°é» / æ´»å‹•']||'').trim();
    if(!name) continue;
    const cat=(row['é¡åˆ¥']||'').trim();
    const latlng = coords[name];
    if(latlng){
      if(!seen.has(name)){
        const marker = L.marker(latlng);
        marker.bindPopup(makePopupHTML(row));
        marker.on('click',()=>{
          // ç…§ç‰‡
          const imgs = photoMap[name] || photoMap[name.replace(/\\s/g,'')] || [];
          ensurePhotosWall(imgs);
        });
        if(cat==='å¯æœ‰å¯ç„¡') marker.addTo(layerOptional);
        else if(cat==='å»æ‰€') marker.addTo(layerToilet);
        else marker.addTo(layerMain);
        seen.add(name);
      }
      if(cat!=='å¯æœ‰å¯ç„¡') routePoints.push(latlng);
    }
  }

  if(routePoints.length>=2){
    routeLine = L.polyline(routePoints,{color:'#60a5fa',weight:4,opacity:.8}).addTo(layerMain);
    map.fitBounds(L.latLngBounds(routePoints),{padding:[30,30]});
  }

  // æ™‚é–“è»¸
  const tb = $('#timeline tbody');
  tb.innerHTML='';
  timeline.forEach(r=>addRow(tb,r));

  // è®“åœ°åœ–åœ¨ sticky header ä¸‹ï¼Œä¸è¦†è“‹
  // (header å·²æœ‰ z-index:1000ï¼Œåœ°åœ–ä¿æŒé è¨­ z-index å³å¯)
}
main().catch(err=>{
  console.error(err);
  alert('è¼‰å…¥è³‡æ–™ç™¼ç”ŸéŒ¯èª¤ï¼š'+err.message);
});

// å±•é–‹/æ”¶åˆï¼ˆå…¶å¯¦æ˜¯å–®ç´”åˆ‡æ› .table-wrap é«˜åº¦ï¼Œè‡ªå‹•æ²å‹•ï¼‰
$('#toggleT').addEventListener('click',()=>{
  const wrap=$('#tableWrap');
  if(wrap.style.maxHeight){
    wrap.style.maxHeight='';
  }else{
    wrap.style.maxHeight='40vh';
    wrap.style.overflowY='auto';
  }
});
</script>
</body>
</html>