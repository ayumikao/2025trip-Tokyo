<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 東京近郊旅 | 澀谷→鎌倉→箱根→熱海→伊豆半島</title>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0f1823;
  --panel:#121c2a;
  --muted:#aab4c7;
  --text:#e9f0ff;
  --accent:#5aa9ff;
  --chip:#0f2238;
  --chip-b:#27466d;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
.container{max-width:1180px;margin:0 auto;padding:16px}
h1{font-size:clamp(20px,4.3vw,34px);font-weight:800;margin:6px 0 14px 0;letter-spacing:.5px}
.route{opacity:.95}
/* 日期 tabs */
.tabs{display:flex;gap:12px;margin:10px 0 12px 0;flex-wrap:wrap}
.tab{padding:10px 18px;border-radius:18px;background:var(--chip);border:1px solid var(--chip-b);color:#cfe2ff;cursor:pointer}
.tab.active{background:#153352;color:#fff;border-color:#2f72bf;box-shadow:0 0 0 2px #1f3b5f inset}
/* 面板 */
.card{background:var(--panel);border:1px solid #24354f;border-radius:14px;padding:10px}
.mapWrap{position:relative}
#map{height:62vh;min-height:360px;border-radius:10px}
.mapControls{position:absolute;right:14px;top:14px;background:rgba(15,24,35,.85);border:1px solid #2c405e;border-radius:12px;padding:14px 16px;display:flex;flex-direction:column;gap:10px;z-index:500}
.mapControls label{display:flex;align-items:center;gap:8px;font-size:14px;letter-spacing:.5px}
.mapBtns{position:absolute;right:14px;top:160px;display:flex;flex-direction:column;gap:10px;z-index:500}
.mapBtn{background:#0f2238;color:#fff;border:1px solid #28456a;padding:10px 12px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:8px}
.mapBtn:active{transform:translateY(1px)}
.fullBtn{margin-bottom:10px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:10px;background:#0e2542;border:1px solid #2b4e7a;font-size:13px}
.copy{cursor:pointer;display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:8px;border:1px dashed #5aa9ff;color:#9fd0ff}
.popupTitle{font-size:18px;font-weight:700;margin-bottom:6px}
.popupRow{margin:4px 0;font-size:14px}
a.link{color:#8ec7ff;text-decoration:none}
a.link:hover{text-decoration:underline}
/* 照片牆 */
#photos{margin-top:14px}
#photosGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:820px){#photosGrid{grid-template-columns:repeat(4,1fr)}}
.phCard{position:relative;background:#0d1827;border:1px solid #233a58;border-radius:10px;overflow:hidden;min-height:120px}
.phCard img{width:100%;height:100%;object-fit:cover;display:block}
.phCard .phCap{position:absolute;left:0;bottom:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.6));padding:6px 8px;font-size:12px}
/* 時間軸 */
#timeline{margin-top:16px}
.tHeadWrap{position:sticky;top:92px;z-index:400;background:var(--panel)}
@media(min-width:820px){.tHeadWrap{top:96px}}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th,.table td{padding:10px 12px;vertical-align:top}
.table th{color:#cfe2ff;font-weight:700;letter-spacing:1px}
.row{background:#0f1d2c;border:1px solid #233a58;border-radius:12px}
.row td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
.row td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.timeCell{width:92px;white-space:nowrap}
.timeCell div{line-height:1.25}
.placeCell{min-width:180px}
.noteCell{font-size:15px;line-height:1.35}
.badgeCar{display:inline-flex;align-items:center;gap:8px;background:#0d2341;border:1px solid #345a8a;border-radius:18px;padding:6px 10px;white-space:nowrap}
/* 其它 */
.small{color:#9fb3cc}
.hr{height:1px;background:#203556;margin:12px 0}
</style>
</head>
<body>
<div class="container">
  <h1>2025 東京近郊旅　｜　澀谷→鎌倉→箱根→熱海→伊豆半島</h1>
  <div class="tabs" id="tabs">
    <div class="tab active">9/20 鎌倉</div>
    <div class="tab">9/21</div>
    <div class="tab">9/22</div>
    <div class="tab">9/23</div>
  </div>

  <button id="fullBtn" class="mapBtn fullBtn">全螢幕地圖</button>
  <div class="card mapWrap">
    <div id="map"></div>
    <div class="mapControls" id="layerCtrl">
      <label><input type="checkbox" id="chkMain" checked/> 主行程</label>
      <label><input type="checkbox" id="chkOptional" checked/> 可有可無</label>
      <label><input type="checkbox" id="chkRest" checked/> 廁所</label>
    </div>
    <div class="mapBtns">
      <button id="btnLocate" class="mapBtn">📍 我在這</button>
      <button id="btnFollow" class="mapBtn">📡 跟隨我</button>
    </div>
  </div>

  <div id="photos" class="card">
    <div class="small">照片牆（點任一標記顯示相簿）</div>
    <div id="photosGrid"></div>
    <div id="phEmpty" class="small" style="margin-top:8px;display:none">暫無照片</div>
  </div>

  <div id="timeline" class="card">
    <div class="tHeadWrap">
      <table class="table">
        <thead>
          <tr>
            <th class="timeCell">時間</th>
            <th>地點 / 活動</th>
            <th>備註</th>
            <th>類別</th>
            <th>車Map Code</th>
          </tr>
        </thead>
      </table>
    </div>
    <table class="table" id="tbody"></table>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// filenames (不改你的檔名)
const CSV_TIMELINE = 'timeline-2025-09-20_v6.csv';
const CSV_PHOTOS   = 'photos-2025-09-20-mapped.csv';
const JSON_COORDS  = 'coords-override-2025-09-20.json';

// 工具
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function csvParse(text){
  const lines = text.trim().split(/\\r?\\n/);
  const headers = lines[0].split(',').map(s=>s.trim());
  return lines.slice(1).map(line=>{
    // 允許欄位內有逗點：簡單處理引號
    const arr=[]; let cur=''; let inq=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='\"'){ inq=!inq; continue; }
      if(c==',' && !inq){ arr.push(cur); cur=''; }
      else cur+=c;
    }
    arr.push(cur);
    const o={};
    headers.forEach((h,i)=>o[h]= (arr[i]??'').trim());
    return o;
  });
}
function toTimeCell(s1,s2){
  // 輸入可能是 "6:30" 和 "8:00" 或 "6:30–8:00"
  if(!s2 && s1.includes('–')){
    const [a,b]=s1.split('–');
    return `<div>${a}</div><div>${b}</div>`;
  }
  return `<div>${s1||''}</div><div>${s2||''}</div>`;
}
function mkCarBadge(s){
  if(!s) return '';
  return `<span class="badgeCar">🚗 ${s} <span class="copy" data-copy="${s}" title="複製">📋</span></span>`;
}

// Leaflet
const map = L.map('map',{ zoomControl:true });
const OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

const gMain = L.layerGroup().addTo(map);
const gOptional = L.layerGroup().addTo(map);
const gRest = L.layerGroup().addTo(map);
let routeLine = null;

$('#chkMain').addEventListener('change', e=>{
  if(e.target.checked){ map.addLayer(gMain); if(routeLine) map.addLayer(routeLine); }
  else{ map.removeLayer(gMain); if(routeLine) map.removeLayer(routeLine); }
});
$('#chkOptional').addEventListener('change', e=>{
  if(e.target.checked) map.addLayer(gOptional); else map.removeLayer(gOptional);
});
$('#chkRest').addEventListener('change', e=>{
  if(e.target.checked) map.addLayer(gRest); else map.removeLayer(gRest);
});

// 定位
let watchId = null;
$('#btnLocate').onclick = ()=>{
  navigator.geolocation?.getCurrentPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    map.setView([latitude,longitude], 14, {animate:true});
    L.circleMarker([latitude,longitude],{radius:8,color:'#21d07a'}).addTo(map);
  }, err=>alert('定位失敗：'+err.message), {enableHighAccuracy:true,timeout:8000});
};
$('#btnFollow').onclick = (e)=>{
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId=null; e.target.textContent='📡 跟隨我'; return;
  }
  if(!navigator.geolocation){ alert('此裝置不支援地理定位'); return; }
  e.target.textContent='⏺ 追蹤中…';
  watchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    map.setView([latitude,longitude], map.getZoom()<13?13:map.getZoom());
  }, err=>{ alert('追蹤失敗：'+err.message); }, {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
};

// 全螢幕地圖切換
let big=false;
$('#fullBtn').onclick = ()=>{
  big=!big;
  $('#map').style.height = big? '86vh':'62vh';
  setTimeout(()=>map.invalidateSize(),100);
};

// 照片
let photoRows = [];
function renderPhotos(place){
  const grid = $('#photosGrid'); grid.innerHTML='';
  const rows = photoRows.filter(r => r['地點']===place || r['標籤']===place);
  if(rows.length===0){ $('#phEmpty').style.display='block'; return; }
  $('#phEmpty').style.display='none';
  rows.forEach(r=>{
    const div = document.createElement('div');
    div.className='phCard';
    const img = document.createElement('img');
    img.loading='lazy';
    img.src = r['檔案'] || r['url'] || r['路徑'] || '';
    img.alt = r['標題']||r['地點']||'';
    const cap = document.createElement('div');
    cap.className='phCap';
    cap.textContent = r['說明']||r['標題']||'';
    div.appendChild(img); div.appendChild(cap);
    grid.appendChild(div);
  });
}

// 載入
(async ()=>{
  // 1) 讀 JSON 座標
  const coordMap = await fetch(JSON_COORDS).then(r=>r.json()).catch(_=>({}));

  // 2) 讀照片 CSV
  photoRows = await fetch(CSV_PHOTOS).then(r=>r.text()).then(csvParse).catch(_=>[]);

  // 3) 讀時間軸 CSV
  const rows = await fetch(CSV_TIMELINE).then(r=>r.text()).then(csvParse);

  // 4) 畫地圖 + 彈窗
  let mainPts = [];
  let bounds = [];
  rows.forEach(r=>{
    const name = (r['地點 / 活動']||'').trim();
    if(!name) return;
    const latlng = coordMap[name];
    if(!latlng) return;

    const isOptional = (r['類別']==='可有可無') || (r['備註']||'').includes('可有可無');
    const hasToilet = (r['🚻 廁所']||'').length>0 && !(r['🚻 廁所']||'').includes('無');
    const mapcode = (r['🚙車Map Code']||'').trim();

    const m = L.marker(latlng, {title:name});
    const html = `
      <div class="popupTitle">${name}</div>
      ${mapcode? `<div class="popupRow"><span class="badge">車Map Code</span> ${mkCarBadge(mapcode)}</div>`:''}
      ${(r['備註']||'')? `<div class="popupRow">${(r['備註']||'')}</div>`:''}
      ${(r['📍 景點連結']||'')? `<div class="popupRow"><a class="link" target="_blank" href="${r['📍 景點連結']}">📍 Google 地圖</a></div>`:''}
    `;
    m.bindPopup(html);
    m.on('click', ()=>renderPhotos(name));

    (isOptional? gOptional : gMain).addLayer(m);
    if(hasToilet) gRest.addLayer(L.circleMarker(latlng,{radius:6,color:'#ffd166',fill:true,fillOpacity:.8}));

    if(!isOptional){ mainPts.push(latlng); }
    bounds.push(latlng);
  });

  if(mainPts.length>=2){
    routeLine = L.polyline(mainPts,{color:'#4ea1ff',weight:4,opacity:.9,smoothFactor:1}).addTo(map);
  }
  if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});

  // 5) 畫時間軸
  const tbody = $('#tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr'); tr.className='row';
    const tdTime = document.createElement('td'); tdTime.className='timeCell';
    tdTime.innerHTML = toTimeCell(r['時間起'], r['時間迄']);
    const tdPlace = document.createElement('td'); tdPlace.className='placeCell';
    const g = (r['📍 景點連結']? `<a class="link" target="_blank" href="${r['📍 景點連結']}">📍 Google 地圖</a>`:'');
    tdPlace.innerHTML = `<div style="font-weight:700;margin-bottom:4px">${r['地點 / 活動']||''}</div>${g}`;

    const tdNote = document.createElement('td'); tdNote.className='noteCell';
    tdNote.textContent = r['備註']||'';

    const tdType = document.createElement('td');
    tdType.textContent = r['類別']||'';

    const tdCar = document.createElement('td');
    tdCar.innerHTML = mkCarBadge(r['🚙車Map Code']||'');

    tr.append(tdTime,tdPlace,tdNote,tdType,tdCar);
    tbody.appendChild(tr);
  });

  // 6) 複製 MapCode
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('.copy'); if(!t) return;
    navigator.clipboard?.writeText(t.dataset.copy||'').then(()=>{
      t.textContent='✅'; setTimeout(()=>t.textContent='📋',900);
    });
  });

})();
</script>
</body>
</html>
