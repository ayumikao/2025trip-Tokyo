<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>2025 近郊旅遊｜9/20 鎌倉</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#60a5fa;
      --route:#0891b2;
      --chip:#1f2937;
      --chip-border:#3f3f46;
      --popup-text:#111827; /* 白色 popup 上的深色字 */
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px 40px;}
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.92));
      padding: env(safe-area-inset-top) 10px 8px;
      border-bottom: 1px solid rgba(148,163,184,.16);
    }
    .title{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title h1{font-size:18px;margin:6px 0}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #263045;color:#dbeafe;cursor:pointer}
    .tab.active{background:#143158;border-color:#2f7bf6}
    .gh{margin-left:auto;font-size:12px;padding:6px 10px;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media(min-width:820px){ .grid{grid-template-columns:minmax(360px, 48%) 1fr;align-items:start}}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.16);border-radius:12px;overflow:hidden}
    .mapHead{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.16)}
    .mapHead .btn{padding:6px 10px;border:1px solid #334155;border-radius:8px;background:#0b1220;color:#cbd5e1;cursor:pointer}
    #map{height:60vh}
    .full #map{height:86vh}
    .hint{font-size:12px;color:var(--muted);padding:8px 10px}
    .photos{padding:8px}
    .photos h3{margin:4px 0 8px 4px;font-size:14px;color:#cbd5e1}
    .gallery{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(min-width:820px){ .gallery{grid-template-columns:1fr 1fr} }
    .gallery img{width:100%;height:160px;object-fit:cover;border-radius:10px;border:1px solid rgba(148,163,184,.16);cursor:pointer;background:#0b1220}
    .timeline{padding:8px 10px}
    details{background:#0b1220;border:1px solid rgba(148,163,184,.16);border-radius:10px;padding:8px 10px}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    table{width:100%;border-collapse:collapse;margin-top:6px;font-size:14px}
    th,td{border-top:1px dashed rgba(148,163,184,.2);padding:8px 6px;vertical-align:top}
    th{color:#cbd5e1;text-align:left;font-weight:600}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--chip-border);background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;color:#e5e7eb}
    .tag{display:inline-block;border:1px solid #334155;border-radius:6px;padding:1px 6px;font-size:12px;color:#cbd5e1}
    .code{display:inline-block;border:1px solid #475569;border-radius:999px;padding:2px 8px;font-size:12px;color:#0f172a;background:#f3f4f6}
    .copyBtn{border:1px solid #475569;border-radius:6px;background:#0b1220;color:#e2e8f0;padding:1px 6px;font-size:12px;cursor:pointer}
    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:1000}
    .lightbox.show{display:flex}
    .lightbox img{max-width:92vw;max-height:92vh;border-radius:10px}
    .navBtn{position:fixed;top:50%;transform:translateY(-50%);font-size:26px;color:#fff;background:rgba(0,0,0,.35);border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
    .navPrev{left:14px}.navNext{right:14px}
    /* Leaflet popup 中的字改深色，對白底有對比 */
    .leaflet-popup-content{color:var(--popup-text);}
    .leaflet-popup-content a{color:#2563eb}
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1>2025 近郊旅遊 ｜ 澀谷 → 鎌倉 → 箱根 → 熱海 → 伊豆半島</h1>
      <a class="gh" href="#" onclick="location.reload()">重新整理</a>
      <div class="tabs">
        <div class="tab active">9/20 鎌倉</div>
        <div class="tab">9/21</div>
        <div class="tab">9/22</div>
        <div class="tab">9/23</div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="mapHead">
          <button class="btn" id="fullBtn">全螢幕地圖</button>
          <span class="hint">提示：點地圖上的景點，右側會顯示對應照片；下方可展開時間軸。</span>
        </div>
        <div id="map"></div>
      </section>

      <aside class="card">
        <div class="photos">
          <h3 id="phTitle">照片牆</h3>
          <div id="gallery" class="gallery"></div>
        </div>
        <div class="timeline">
          <details open>
            <summary>展開 / 收合　<span class="tag">資料來源：timeline-2025-09-20_v6.csv</span></summary>
            <table id="tbl">
              <thead><tr><th>時間</th><th>地點 / 活動</th><th>備註</th><th>類別</th><th>車Map<br/>Code</th></tr></thead>
              <tbody></tbody>
            </table>
          </details>
        </div>
      </aside>
    </div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" tabindex="-1">
    <button class="navBtn navPrev" id="prevBtn">‹</button>
    <img id="lbImg" alt=""/>
    <button class="navBtn navNext" id="nextBtn">›</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const MAP_CSV = 'timeline-2025-09-20_v6.csv';
    const PHOTO_CSV = 'photos-2025-09-20-mapped.csv';
    const COORDS_JSON = 'coords-override-2025-09-20.json';

    // 若座標覆寫沒有，這裡放安全的預設點（你可改成飯店或集合點）
    const DEFAULT_COORDS = {
      '澀谷出發（包車）':[35.659, 139.700] // Shibuya Station 周邊（可自行微調）
    };

    const map = L.map('map', { zoomControl:true, scrollWheelZoom:true }).setView([35.319, 139.53], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    // 圖層
    const layerMain     = L.layerGroup().addTo(map);
    const layerOptional = L.layerGroup().addTo(map);
    const layerToilet   = L.layerGroup().addTo(map);
    const layerRoute    = L.layerGroup().addTo(map);
    L.control.layers(null, {
      "主行程/精華或近似":layerMain,
      "可有可無":layerOptional,
      "廁所":layerToilet
    }, {collapsed:false}).addTo(map);

    // 圖示
    const iconMain = L.icon({ iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34] });
    const iconOpt  = L.divIcon({ className:'', html:"<div style='width:20px;height:20px;border-radius:50%;background:#7c3aed;border:2px solid white;box-shadow:0 0 0 1px #4c1d95'></div>", iconSize:[20,20], iconAnchor:[10,10] });
    const iconWC   = L.divIcon({ className:'', html:"<div style='width:20px;height:20px;border-radius:50%;background:#0ea5e9;border:2px solid white;box-shadow:0 0 0 1px #0369a1'></div>", iconSize:[20,20], iconAnchor:[10,10] });

    // Lightbox
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImg');
    let lbList = []; let lbIndex = 0;
    function openLB(list, idx){
      lbList = list; lbIndex = idx; lbImg.src = lbList[lbIndex]; lb.classList.add('show'); lb.focus();
    }
    function closeLB(){ lb.classList.remove('show'); lbImg.src=''; }
    function navLB(d){ if(!lbList.length) return; lbIndex=(lbIndex+d+lbList.length)%lbList.length; lbImg.src=lbList[lbIndex]; }
    lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLB() });
    document.getElementById('prevBtn').onclick=()=>navLB(-1);
    document.getElementById('nextBtn').onclick=()=>navLB(1);
    window.addEventListener('keydown', e=>{
      if(!lb.classList.contains('show')) return;
      if(e.key==='Escape') closeLB();
      if(e.key==='ArrowLeft') navLB(-1);
      if(e.key==='ArrowRight') navLB(1);
    });

    // 地圖高度切換
    document.getElementById('fullBtn').onclick=()=>{
      document.querySelector('.card').classList.toggle('full');
      map.invalidateSize();
    };

    // 工具
    function isOptional(row){
      const a=(row['備註']||''), b=(row['地點 / 活動']||'');
      return /可有可無/.test(a) || /可有可無/.test(b);
    }
    function isToilet(row){ return (row['🚻 廁所']||'').trim()!==''; }

    // 盡可能從 Google Maps 連結中抓出座標（有 query=lat,lng 或 @lat,lng 或 !3dLAT!4dLNG）
    function coordsFromLink(link){
      if(!link) return null;
      try{
        const u = decodeURIComponent(link);
        // query=35.332861,139.518890
        let m = u.match(/query=([+-]?\d+\.\d+)[,\s%2C]+([+-]?\d+\.\d+)/i);
        if(m) return [parseFloat(m[1]), parseFloat(m[2])];
        // @35.332861,139.518890
        m = u.match(/@([+-]?\d+\.\d+),([+-]?\d+\.\d+)/);
        if(m) return [parseFloat(m[1]), parseFloat(m[2])];
        // !3d35.332861!4d139.518890
        m = u.match(/!3d([+-]?\d+\.\d+)!4d([+-]?\d+\.\d+)/);
        if(m) return [parseFloat(m[1]), parseFloat(m[2])];
      }catch(e){}
      return null;
    }

    function buildPopup(row, latlng){
      const name = row['地點 / 活動']||'';
      const link = row['📍 景點連結']? `<a href="${row['📍 景點連結']}" target="_blank">📍 Google 地圖</a>`:'';
      const wc   = row['🚻 廁所']? `<span class="chip" style="background:#0b3850;border-color:#0ea5e9">🚻 ${row['🚻 廁所']}</span>`:'';
      const code = row['🚙車Map Code']? `<span class="code">${row['🚙車Map Code']}</span> <button class="copyBtn" onclick="navigator.clipboard.writeText('${(row['🚙車Map Code']||'').replace(/'/g,'')}');event.stopPropagation()">複製</button>`:'';
      const note = row['備註']? `<div style="margin-top:6px;color:#374151">${row['備註']}</div>`:'';
      return `<div style="min-width:240px">
        <div style="font-weight:700;margin-bottom:4px;color:#0f172a">${name}</div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:4px 0">${code}${wc}</div>
        ${note}
        <div style="margin-top:6px">${link}</div>
      </div>`;
    }

    // 讀三個資料：座標覆寫、行程 CSV、照片對應 CSV
    let coordMap = {};
    let photoMap = {}; // name -> [img,...]
    let routePts = [];
    const bounds = [];

    Promise.all([
      fetch(COORDS_JSON).then(r=>r.ok?r.json():{}).catch(_=>({})),
      fetch(PHOTO_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true,skipEmptyLines:true}).data).catch(_=>[]),
      fetch(MAP_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true,skipEmptyLines:true}).data)
    ]).then(([coordJson, photoRows, planRows])=>{
      coordMap = Object.assign({}, DEFAULT_COORDS, coordJson||{});
      // 照片對應
      photoRows.forEach(r=>{
        const n=(r['對應地點']||'').trim(); const p=(r['image']||'').trim();
        if(!n||!p) return;
        if(!photoMap[n]) photoMap[n]=[];
        photoMap[n].push(p);
      });

      // 建立點位 & 時間軸
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML='';
      planRows.forEach(row=>{
        const name = (row['地點 / 活動']||'').trim();
        const type = (row['類別']||'').trim();
        const time = `${row['時間起']||''}-${row['時間迄']||''}`.replace(/-$/,'');

        // 時間軸列
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${time}</td>
          <td>${name?('📍 '+name):''}${row['📍 景點連結']?`<div><a href="${row['📍 景點連結']}" target="_blank">Google 地圖</a></div>`:''}</td>
          <td>${row['備註']||''}</td>
          <td>${type||''}</td>
          <td>${(row['🚙車Map Code']||'').trim()?`<span class="code">${row['🚙車Map Code']}</span>`:''}</td>`;
        tbody.appendChild(tr);

        if(!name) return;

        // 取得座標：優先用 coords-override，否則嘗試從連結解析，再否則用 DEFAULT_COORDS
        let c = coordMap[name];
        if((!c || !Array.isArray(c) || c.length<2) && row['📍 景點連結']){
          const parsed = coordsFromLink(row['📍 景點連結']);
          if(parsed) c = parsed;
        }
        if((!c || !Array.isArray(c) || c.length<2) && DEFAULT_COORDS[name]){
          c = DEFAULT_COORDS[name];
        }
        if(!c || !Array.isArray(c) || c.length<2) return;

        const lat = +c[0], lng = +c[1];
        const latlng=[lat,lng];
        bounds.push(latlng);

        // 圖層判斷
        const optional = isOptional(row);
        const toilet   = isToilet(row);
        const layer = toilet ? layerToilet : (optional ? layerOptional : layerMain);
        const icon  = toilet ? iconWC     : (optional ? iconOpt     : iconMain);

        const mk = L.marker(latlng,{icon}).bindPopup(buildPopup(row, latlng)).addTo(layer);
        mk.on('click', ()=>{
          // 照片牆
          const list = (photoMap[name]||[]).slice();
          document.getElementById('phTitle').textContent = name + ' 的相片：';
          const gal = document.getElementById('gallery');
          gal.innerHTML = '';
          list.forEach((src, idx)=>{
            const img = document.createElement('img');
            img.loading='lazy'; img.src = src;
            img.onclick=()=>openLB(list, idx);
            gal.appendChild(img);
          });
        });

        // 主行程路線：包含所有「非可有可無」且有座標的點（包含包車起點）
        if(!optional){
          routePts.push(latlng);
        }
      });

      if(bounds.length) map.fitBounds(bounds, {padding:[20,20]});
      if(routePts.length>=2){
        L.polyline(routePts,{color: getComputedStyle(document.documentElement).getPropertyValue('--route')||'#0891b2', weight:4, opacity:.95}).addTo(layerRoute);
      }
    }).catch(err=>{
      console.error(err);
      alert('資料載入失敗，請檢查 CSV / JSON 是否存在。');
    });
  </script>
</body>
</html>
