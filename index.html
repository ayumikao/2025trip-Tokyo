<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>2025 æ±äº¬è¿‘éƒŠæ—… | æ¾€è°·â†’éŒå€‰â†’ç®±æ ¹â†’ç†±æµ·â†’ä¼Šè±†åŠå³¶</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse (è®€ CSV) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<!-- dayjs åªç‚ºäº†æ™‚é–“é¡¯ç¤ºç”¨ -->
<script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>

<style>
  :root{
    --bg:#0f172a;           /* æ·±è—åº• */
    --panel:#111827;        /* é¢æ¿ */
    --text:#e5e7eb;         /* æ–‡å­— */
    --muted:#a1a1aa;        /* æ¬¡è¦å­— */
    --accent:#60a5fa;       /* é‡é»è‰² */
    --green:#34d399;        /* å‹¾é¸è‰² */
    --chip:#111827;
    --chip-border:#374151;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif,system-ui,"Noto Sans TC","PingFang TC",Arial;}
  a{color:#93c5fd;text-decoration:none;}
  a:hover{text-decoration:underline;}

  /* é ‚éƒ¨å°è¦½ */
  .topbar{position:sticky;top:0;z-index:900; background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.75) 70%, transparent); backdrop-filter: blur(6px);}
  .wrap{max-width:1100px;margin:auto;padding:14px 14px 0;}

  .title{font-weight:700;font-size:18px;white-space:nowrap;overflow:auto;scrollbar-width:none;}
  .tabs{display:flex;gap:10px;margin:10px 0 8px;overflow:auto;scrollbar-width:none;}
  .tab{padding:8px 14px;border-radius:999px;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;cursor:pointer;white-space:nowrap;}
  .tab.active{background:#1f2937;color:#fff;border-color:#3b82f6}

  /* ä¸»é«” */
  .section{max-width:1100px;margin:10px auto;padding:12px;border-radius:14px;background:var(--panel);box-shadow: 0 0 0 1px #0b1220;}
  .flex{display:grid;grid-template-columns:1fr;gap:14px;}
  @media (min-width: 820px){ .flex{grid-template-columns: minmax(0,1fr) 360px;} }

  /* åœ°åœ–å€ */
  #map{height:60vh;border-radius:12px;}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
  .btn{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{border-color:#475569}
  .float-panel{position:absolute;right:14px;top:14px;z-index:600;background:#0b1220cc;border:1px solid #334155;border-radius:12px;padding:10px 12px;color:#e5e7eb}
  .float-panel label{display:flex;align-items:center;gap:8px;margin:6px 0}
  .float-panel input{accent-color:#3b82f6}
  .locate-btn{position:absolute;right:14px;top:140px;z-index:600}
  .leaflet-control-container .leaflet-top.leaflet-right{margin-top:60px;} /* è®“é è¨­æ§åˆ¶ä¸è“‹ä½ */

  /* marker popup å…§çš„ chip */
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--chip-border);background:var(--chip);padding:4px 10px;border-radius:999px;font-weight:600}
  .chip .copy{cursor:pointer;opacity:.8}
  .chip .copy:hover{opacity:1}

  /* ç…§ç‰‡ç‰† */
  .photos h3{margin:4px 0 10px;font-size:16px;color:#cbd5e1}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  @media (min-width: 820px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
  .ph{position:relative;background:#0b1220;border:1px solid #1f2937;border-radius:10px;overflow:hidden;min-height:120px;display:flex;align-items:center;justify-content:center}
  .ph img{width:100%;height:100%;object-fit:cover}
  .ph .cap{position:absolute;left:8px;bottom:6px;background:#0008;padding:2px 6px;border-radius:6px;font-size:12px}
  .empty{padding:18px;border:1px dashed #334155;border-radius:10px;color:#a1a1aa;background:#0b1220}

  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
  .lightbox.on{display:flex}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:8px}

  /* æ™‚é–“è»¸ */
  .tl-head{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px}
  .table{width:100%;border-collapse:separate;border-spacing:0 10px;}
  .table th,.table td{padding:10px 12px;vertical-align:top}
  .table th{position:sticky;top:0;background:#0b1220;border-bottom:1px solid #1f2937;z-index:5}
  .row{background:#0b1220;border:1px solid #1f2937;border-radius:12px}
  .time{white-space:nowrap}              /* æ™‚é–“ç¶­æŒä¸€è¡Œ */
  .note{white-space:normal;line-height:1.4}  /* å‚™è¨»æ©«å‘é¡¯ç¤ºï¼Œä¸å†æ›æ¯å€‹å­— */
  .type{white-space:nowrap}
  .mapcode{white-space:nowrap}
  .badge{display:inline-block;border:1px solid #334155;background:#0b1220;border-radius:999px;padding:6px 10px}
  .copybtn{cursor:pointer;margin-left:8px;opacity:.8}
  .copybtn:hover{opacity:1}
</style>
</head>
<body>

<div class="topbar">
  <div class="wrap">
    <div class="title">2025 æ±äº¬è¿‘éƒŠæ—… ï½œ æ¾€è°·â†’éŒå€‰â†’ç®±æ ¹â†’ç†±æµ·â†’ä¼Šè±†åŠå³¶</div>
    <div class="tabs">
      <button class="tab active">9/20 éŒå€‰</button>
      <button class="tab">9/21</button>
      <button class="tab">9/22</button>
      <button class="tab">9/23</button>
    </div>
  </div>
</div>

<div class="section wrap">
  <div class="btn-row">
    <button id="btnFull" class="btn">å…¨è¢å¹•åœ°åœ–</button>
  </div>

  <div style="position:relative">
    <div id="map"></div>

    <!-- åœ–å±¤é–‹é—œï¼ˆé¿å…è¢«åœ°åœ–è“‹ä½ï¼‰ -->
    <div class="float-panel" id="layerBox">
      <label><input type="checkbox" id="chkMain" checked> ä¸»è¡Œç¨‹/ç²¾è¯æˆ–è¿‘ä¼¼</label>
      <label><input type="checkbox" id="chkOpt"  checked> å¯æœ‰å¯ç„¡</label>
      <label><input type="checkbox" id="chkToil" checked> å»æ‰€</label>
    </div>

    <div class="locate-btn">
      <button class="btn" id="btnLocate">ğŸ“ æˆ‘åœ¨é€™</button>
      <button class="btn" id="btnFollow">ğŸ›°ï¸ è·Ÿéš¨æˆ‘</button>
    </div>
  </div>
</div>

<div class="section wrap photos">
  <h3>ç…§ç‰‡ç‰†ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</h3>
  <div id="photos" class="grid"></div>
  <div id="photosEmpty" class="empty" style="display:none">æš«ç„¡ç…§ç‰‡</div>
</div>

<div class="section wrap">
  <div class="tl-head">
    <div>æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</div>
    <button class="btn" id="btnToggleTL">å±•é–‹ / æ”¶åˆ</button>
  </div>
  <div id="tlBox">
    <table class="table" id="tl"></table>
  </div>
</div>

<!-- Lightbox -->
<div id="lb" class="lightbox" tabindex="-1">
  <img id="lbImg" alt="">
</div>

<script>
/* ------------------ åŸºæœ¬è¨­å®š ------------------ */
const CSV_TIMELINE = 'timeline-2025-09-20_v6.csv';
const CSV_PHOTOS   = 'photos-2025-09-20-mapped.csv';
const JSON_COORDS  = 'coords-override-2025-09-20.json';  // ä½¿ç”¨ä½ æä¾›çš„ã€Œæœ€çµ‚ç‰ˆã€åº§æ¨™

// åœ°åœ–
const map = L.map('map', { zoomControl:true }).setView([35.32,139.53], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

// ä¸‰å€‹åœ–å±¤ç¾¤çµ„ + ä¸»ç·š polyline
const layerMain = L.layerGroup().addTo(map);     // ä¸»è¡Œç¨‹/ç²¾è¯
const layerOpt  = L.layerGroup().addTo(map);     // å¯æœ‰å¯ç„¡
const layerTol  = L.layerGroup().addTo(map);     // å»æ‰€
let routeLine = null;                             // ä¸»è¡Œç¨‹è·¯ç·šï¼ˆåƒ…ä¸»è¡Œç¨‹ä¸²é»ï¼‰

// åº§æ¨™è¦†è“‹ (ç”± JSON è®€)
let COORDS = {};   // { åœ°é»å: [lat, lng] }

// ç…§ç‰‡æ± ï¼š{ åœ°é»å: [ {src, cap}, ... ] }
let PHOTO_MAP = {};

/* ------------------ UI æ§åˆ¶ ------------------ */
// å…¨è¢å¹•åœ°åœ–
const btnFull = document.getElementById('btnFull');
let isFull = false;
btnFull.onclick = () => {
  const m = document.getElementById('map');
  isFull = !isFull;
  m.style.height = isFull? '86vh' : '60vh';
  map.invalidateSize({animate:true});
};

// åœ–å±¤é¡¯ç¤º
function refreshLayerVisibility(){
  document.getElementById('chkMain').checked ? map.addLayer(layerMain) : map.removeLayer(layerMain);
  document.getElementById('chkOpt').checked  ? map.addLayer(layerOpt)  : map.removeLayer(layerOpt);
  document.getElementById('chkToil').checked ? map.addLayer(layerTol)  : map.removeLayer(layerTol);

  if (routeLine){
    if (document.getElementById('chkMain').checked){
      map.addLayer(routeLine);
    }else{
      map.removeLayer(routeLine);
    }
  }
}
['chkMain','chkOpt','chkToil'].forEach(id=>{
  document.getElementById(id).addEventListener('change', refreshLayerVisibility);
});

// æ™‚é–“è»¸å±•æ”¶
const tlBox = document.getElementById('tlBox');
document.getElementById('btnToggleTL').onclick = ()=>{
  tlBox.style.display = (tlBox.style.display==='none' ? '' : 'none');
};

/* ------------------ å®šä½åŠŸèƒ½ ------------------ */
let myMarker = null, myCircle = null, watchId = null;
function locateOnce(){
  if(!navigator.geolocation) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
  navigator.geolocation.getCurrentPosition((pos)=>{
    const {latitude, longitude, accuracy} = pos.coords;
    const latlng = [latitude, longitude];
    if(!myMarker){ myMarker = L.marker(latlng).addTo(map).bindTooltip('ä½ åœ¨é€™'); }
    else{ myMarker.setLatLng(latlng); }
    if(!myCircle){ myCircle = L.circle(latlng,{radius:accuracy,opacity:.6,fillOpacity:.08}).addTo(map); }
    else{ myCircle.setLatLng(latlng).setRadius(accuracy); }
    map.flyTo(latlng, 16, {duration:1.2});
  },(err)=>alert('å®šä½å¤±æ•—ï¼š'+err.message),{enableHighAccuracy:true,timeout:10000,maximumAge:10000});
}
function toggleFollow(){
  if(!navigator.geolocation) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; return; }
  watchId = navigator.geolocation.watchPosition((pos)=>{
    const {latitude, longitude, accuracy} = pos.coords;
    const latlng = [latitude, longitude];
    if(!myMarker){ myMarker = L.marker(latlng).addTo(map).bindTooltip('ä½ åœ¨é€™'); }
    else{ myMarker.setLatLng(latlng); }
    if(!myCircle){ myCircle = L.circle(latlng,{radius:accuracy,opacity:.6,fillOpacity:.08}).addTo(map); }
    else{ myCircle.setLatLng(latlng).setRadius(accuracy); }
    map.panTo(latlng,{animate:true});
  },(err)=>{ alert('å®šä½å¤±æ•—ï¼š'+err.message); if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;} },{
    enableHighAccuracy:true,timeout:15000,maximumAge:0
  });
}
document.getElementById('btnLocate').addEventListener('click', locateOnce);
document.getElementById('btnFollow').addEventListener('click', toggleFollow);

/* ------------------ å·¥å…· ------------------ */
// ç”¢ Marker Popup å…§å®¹ï¼ˆåŒ…å« MapCode chipã€å‚™è¨»ã€Google åœ°åœ–ï¼‰
function popupHTML(rec){
  const mapCode = (rec['ğŸš™è»ŠMap Code']||'').trim();
  const note = (rec['å‚™è¨»']||'').trim();
  const url  = (rec['ğŸ“ æ™¯é»é€£çµ']||'').trim();

  return `
    <div style="min-width:240px">
      <div style="font-weight:800;font-size:18px;margin-bottom:6px">${rec['åœ°é» / æ´»å‹•']}</div>
      ${mapCode?`<div class="chip">ğŸš— ${mapCode}<span class="copy" title="è¤‡è£½" onclick="navigator.clipboard.writeText('${mapCode}')">ğŸ“‹</span></div>`:''}
      ${note?`<div style="margin:8px 0 6px;color:#cbd5e1">${note}</div>`:''}
      ${url?`<div>ğŸ“ <a href="${url}" target="_blank">Google åœ°åœ–</a></div>`:''}
    </div>
  `;
}
// åœ¨ç…§ç‰‡ç‰†é¡¯ç¤ºæŸåœ°é»çš„ç›¸ç‰‡
function showPhotosFor(place){
  const box = document.getElementById('photos');
  const emp = document.getElementById('photosEmpty');
  box.innerHTML = '';
  const arr = PHOTO_MAP[place] || [];
  if(!arr.length){ emp.style.display='block'; return; }
  emp.style.display='none';
  for(const p of arr){
    const el = document.createElement('div'); el.className='ph';
    const img = document.createElement('img'); img.loading='lazy'; img.src = p.src; img.alt = p.cap||place;
    img.onclick = ()=>openLB(p.src);
    const cap = document.createElement('div'); cap.className='cap'; cap.textContent = p.cap||'';
    el.appendChild(img); el.appendChild(cap); box.appendChild(el);
  }
}

// lightbox
const lb = document.getElementById('lb'), lbImg = document.getElementById('lbImg');
function openLB(src){ lbImg.src=src; lb.classList.add('on'); }
lb.addEventListener('click', ()=>lb.classList.remove('on'));
window.addEventListener('keydown',e=>{ if(e.key==='Escape') lb.classList.remove('on'); });

/* ------------------ è¼‰å…¥è³‡æ–™ï¼šJSON / CSV ------------------ */
async function loadAll(){
  // 1) åº§æ¨™è¦†è“‹
  COORDS = await fetch(JSON_COORDS).then(r=>r.json());

  // 2) ç…§ç‰‡ CSVï¼šæ¬„ä½å»ºè­°ï¼šplace,img,caption
  await new Promise(res=>{
    Papa.parse(CSV_PHOTOS, {
      download:true, header:true, skipEmptyLines:true,
      complete: (r)=>{
        r.data.forEach(row=>{
          const place = (row.place||row['place']||row['åœ°é»']||'').trim();
          const src   = (row.img||row['img']||row['æª”å']||'').trim();
          if(!place || !src) return;
          if(!PHOTO_MAP[place]) PHOTO_MAP[place]=[];
          PHOTO_MAP[place].push({src, cap: row.caption||row['caption']||row['èªªæ˜']||''});
        });
        res();
      }
    });
  });

  // 3) æ™‚é–“è»¸ + åœ°åœ–é»
  await new Promise(res=>{
    Papa.parse(CSV_TIMELINE, {
      download:true, header:true, skipEmptyLines:true,
      complete: (r)=>{
        buildMapAndTimeline(r.data);
        res();
      }
    });
  });
}

/* ------------------ å»ºç«‹åœ°åœ–èˆ‡æ™‚é–“è»¸ ------------------ */
function buildMapAndTimeline(rows){
  const ptsMain = [];     // ç”¨ä¾†ä¸²ä¸»ç·š
  const tl = document.getElementById('tl');
  tl.innerHTML = `
    <thead>
      <tr>
        <th style="width:90px">æ™‚é–“</th>
        <th style="min-width:180px">åœ°é» / æ´»å‹•</th>
        <th>å‚™è¨»</th>
        <th style="width:72px">é¡åˆ¥</th>
        <th style="width:160px">è»ŠMap Code</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  `;
  const tb = document.getElementById('tb');

  rows.forEach(rec=>{
    const start = (rec['æ™‚é–“èµ·']||'').trim();
    const end   = (rec['æ™‚é–“è¿„']||'').trim();
    const name  = (rec['åœ°é» / æ´»å‹•']||'').trim();
    if(!name) return;

    const type  = (rec['é¡åˆ¥']||'').trim();      // "å¯æœ‰å¯ç„¡" => æ”¾ opt
    const note  = (rec['å‚™è¨»']||'').trim();
    const url   = (rec['ğŸ“ æ™¯é»é€£çµ']||'').trim();
    const toilet= (rec['ğŸš» å»æ‰€']||'').trim();
    const code  = (rec['ğŸš™è»ŠMap Code']||'').trim();

    // ä½ç½®
    const coord = COORDS[name];
    if(coord){
      const latlng = [coord[0], coord[1]];
      const mk = L.marker(latlng, {title:name})
          .bindPopup(popupHTML(rec))
          .on('click', ()=>showPhotosFor(name));
      if(type==='å¯æœ‰å¯ç„¡'){ mk.addTo(layerOpt); }
      else if(toilet){ mk.addTo(layerTol); }     // æœ‰å¯«å»æ‰€çš„ä¹Ÿæ”¾åˆ°å»æ‰€å±¤ï¼ˆä½ çš„ CSV å·²æ¨™è¨»ï¼‰
      else { mk.addTo(layerMain); ptsMain.push(latlng); }
    }

    // æ™‚é–“è»¸ï¼ˆå‚™è¨»æ©«å¼é¡¯ç¤ºï¼‰
    const tr = document.createElement('tr'); tr.className='row';
    tr.innerHTML = `
      <td class="time">${start}${end?('â€“'+end):''}</td>
      <td>
        <div style="font-weight:700">${name}</div>
        ${url?`<div>ğŸ“ <a href="${url}" target="_blank">Google åœ°åœ–</a></div>`:''}
      </td>
      <td class="note">${note||''}</td>
      <td class="type">${type||''}</td>
      <td class="mapcode">
        ${code?`<span class="badge">ğŸš— ${code}<span class="copybtn" title="è¤‡è£½" onclick="navigator.clipboard.writeText('${code}')">ğŸ“‹</span></span>`:''}
      </td>
    `;
    tb.appendChild(tr);
  });

  // ä¸»è¡Œç¨‹ polylineï¼ˆåªæœ‰ä¸»è¡Œç¨‹é€£ç·šï¼‰
  if(routeLine){ map.removeLayer(routeLine); }
  if(ptsMain.length>=2){
    routeLine = L.polyline(ptsMain, {color:'#60a5fa',weight:5,opacity:.85}).addTo(map);
    map.fitBounds(routeLine.getBounds(), {padding:[20,20]});
  }else{
    // æ²’æœ‰ä¸»ç·šå°±å°æ‰€æœ‰ marker å– bounds
    const all = L.featureGroup([layerMain,layerOpt,layerTol]);
    try{ map.fitBounds(all.getBounds(),{padding:[20,20]}); }catch(e){}
  }

  refreshLayerVisibility();
  // åˆå§‹ç…§ç‰‡ç‰†é¡¯ç¤ºç¬¬ä¸€å€‹ä¸»è¡Œç¨‹é»çš„ç…§ç‰‡
  if(rows.length){
    const firstWithPhoto = rows.find(r=>PHOTO_MAP[(r['åœ°é» / æ´»å‹•']||'').trim()]);
    if(firstWithPhoto) showPhotosFor((firstWithPhoto['åœ°é» / æ´»å‹•']||'').trim());
  }
}

/* ------------------ å•Ÿå‹• ------------------ */
loadAll();
</script>
</body>
</html>
