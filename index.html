<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025 è¡Œç¨‹ 9/20 éŒå€‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; background: #0d1117; color: #e6edf3; }
    #map { height: 60vh; }
    .layer-control { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 6px; }
    .photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 6px; padding: 10px; }
    .photos img { width: 100%; border-radius: 6px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #444; padding: 6px; font-size: 14px; }
    th { background: #222; }
  </style>
</head>
<body>
  <h2>2025 è¡Œç¨‹ï½œæ¾€è°·â†’éŒå€‰</h2>
  <div id="map"></div>
  <h3>ç…§ç‰‡ç‰†ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</h3>
  <div id="photos" class="photos"></div>
  <h3>æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</h3>
  <div style="overflow-x:auto;">
    <table id="timeline"></table>
  </div>

  <script>
    const map = L.map('map').setView([35.32, 139.55], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layers
    const mainLayer = L.layerGroup().addTo(map);
    const optionalLayer = L.layerGroup().addTo(map);
    const toiletLayer = L.layerGroup().addTo(map);

    const layerControl = {
      "ä¸»è¡Œç¨‹/ç²¾è¯æˆ–è¿‘ä¼¼": mainLayer,
      "å¯æœ‰å¯ç„¡": optionalLayer,
      "å»æ‰€": toiletLayer
    };
    L.control.layers(null, layerControl, { collapsed:false, position:'topright' }).addTo(map);

    // Load JSON for coords
    async function loadCoords() {
      const res = await fetch('coords-override-2025-09-20.json');
      return await res.json();
    }

    // Load CSVs
    async function loadCSV(file) {
      return new Promise((resolve) => {
        Papa.parse(file, {
          download: true,
          header: true,
          complete: (results) => resolve(results.data)
        });
      });
    }

    async function init() {
      const coords = await loadCoords();
      const timeline = await loadCSV('timeline-2025-09-20_v6.csv');
      const photos = await loadCSV('photos-2025-09-20-mapped.csv');

      const photoMap = {};
      photos.forEach(p => {
        if (!photoMap[p["åœ°é»"]]) photoMap[p["åœ°é»"]] = [];
        photoMap[p["åœ°é»"]].push(p["æª”å"]);
      });

      const route = [];
      timeline.forEach(row => {
        if (!row["åœ°é» / æ´»å‹•"]) return;
        const name = row["åœ°é» / æ´»å‹•"].trim();
        const latlng = coords[name];
        if (!latlng) return;

        let marker = L.marker(latlng);
        marker.bindPopup(`<b>${name}</b><br/>${row["å‚™è¨»"]||""}`);
        marker.on('click', () => {
          document.getElementById("photos").innerHTML =
            (photoMap[name]||[]).map(f=>`<img src="assets/img/${f}" alt="${name}">`).join("");
        });

        if (row["é¡åˆ¥"]==="å¯æœ‰å¯ç„¡") optionalLayer.addLayer(marker);
        else if (row["é¡åˆ¥"]==="å»æ‰€") toiletLayer.addLayer(marker);
        else { mainLayer.addLayer(marker); route.push(latlng); }
      });

      if(route.length>0) L.polyline(route, { color:"blue" }).addTo(mainLayer);

      // Timeline Table
      const table = document.getElementById("timeline");
      table.innerHTML = "<tr><th>æ™‚é–“</th><th>åœ°é» / æ´»å‹•</th><th>å‚™è¨»</th><th>é¡åˆ¥</th><th>è»ŠMap Code</th></tr>";
      timeline.forEach(row=>{
        table.innerHTML += `<tr>
          <td>${row["æ™‚é–“èµ·"]||""}-${row["æ™‚é–“è¿„"]||""}</td>
          <td>${row["åœ°é» / æ´»å‹•"]||""}</td>
          <td>${row["å‚™è¨»"]||""}</td>
          <td>${row["é¡åˆ¥"]||""}</td>
          <td>${row["ğŸš™è»ŠMap Code"]||""}</td>
        </tr>`;
      });
    }
    init();
  </script>
</body>
</html>
