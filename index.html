<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>2025 æ±äº¬è¿‘éƒŠæ—…éŠï½œ9/20 éŒå€‰</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{
  --bg:#0e1621; --txt:#eaf2ff; --muted:#9fb3c8; --panel:#0f1c2c; --card:#102034;
  --accent:#4ea1ff; --pill:#2a2318; --pillText:#ffd59b; --border:#23374e;
  --stickyH: 92px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",Segoe UI,Roboto,Arial}
a{color:#9fd1ff;text-decoration:none}
.wrap{max-width:980px;margin:0 auto;padding:0 14px 40px}

/* header + date (ç¶­æŒä½ ç†Ÿæ‚‰çš„æ¨£å¼ï¼Œåªç¸®å°ä¸€é»ã€ä¸å†äº‚å‹•) */
.sticky{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(14,22,33,.98),rgba(14,22,33,.90));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
.head{padding:12px 14px 6px}
.h1{margin:0;font-size:24px;font-weight:900;letter-spacing:.04em}
.route{margin:6px 0 2px;color:var(--muted);font-size:13px}
.days{display:flex;gap:10px;overflow-x:auto;padding:8px 14px 10px}
.day{flex:0 0 auto;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:98px;height:56px;border-radius:26px;background:#0f1b2b;border:2px solid #2a4260}
.day .date{font-size:18px;font-weight:800;line-height:1}
.day .place{font-size:12px;color:var(--muted);margin-top:3px}
.day.active{border-color:#4ea1ff;box-shadow:0 0 0 4px rgba(78,161,255,.15) inset}

/* section */
.title{font-size:16px;font-weight:800;margin:14px 2px 8px}

/* map box */
.mapwrap{position:relative;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
#map{height:62vh;min-height:420px}
/* move Leaflet zoom so itä¸é®æ—¥æœŸ */
.leaflet-top.leaflet-left{top:64px}

/* layer panel æ”¾åœ¨åœ°åœ–å…§ï¼Œä¸”ä¸æœƒè“‹åˆ°æ—¥æœŸ */
.layerCtl{position:absolute;right:12px;top:76px;z-index:20;background:rgba(11,19,32,.92);border:1px solid var(--border);border-radius:12px;padding:8px 10px}
.layerCtl label{display:flex;align-items:center;gap:8px;font-size:14px;margin:6px 0}

/* vertical locate/follow buttonsï¼ˆçœŸæ­£ç›´æ’ï¼Œä¸ç”¨ \\nï¼‰ */
.vbox{position:absolute;right:12px;bottom:14px;z-index:20;display:flex;flex-direction:column;gap:10px}
.vbtn{writing-mode:vertical-rl;text-orientation:upright;letter-spacing:.12em;user-select:none;
  background:#11253c;border:1px solid var(--border);color:#eaf2ff;border-radius:12px;padding:10px 6px;font-weight:900;cursor:pointer}
.vbtn.active{outline:2px solid var(--accent)}

/* popup */
.leaflet-popup-content-wrapper{background:#0f1c2c;border:1px solid var(--border);color:var(--txt);border-radius:14px}
.leaflet-popup-tip{background:#0f1c2c;border:1px solid var(--border)}
.pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);color:var(--pillText);border:1px solid #7b5b22;border-radius:999px;padding:6px 12px;font-weight:900}

/* photos */
.album{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px}
.grid{display:grid;gap:8px;grid-template-columns:repeat(2,1fr)}
.grid img{width:100%;height:150px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
.empty{color:var(--muted)}

/* timelineï¼šä½ å–œæ­¡çš„æ¨£å¼ */
.twrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.thead{display:grid;grid-template-columns:90px 1fr 80px 150px;gap:8px;padding:10px 12px;background:#0c1829;position:sticky;top:calc(56px + 62px);z-index:30}
.trow{border-top:1px dashed rgba(255,255,255,.12);padding:10px 12px}
.tgrid{display:grid;grid-template-columns:90px 1fr 80px 150px;gap:8px;align-items:center}
.ttime{white-space:pre-line;font-weight:900}
.tplace .pin{margin-right:6px}
.tcat{color:var(--muted);font-weight:800}
.tcode{justify-self:end}
.note{margin-top:8px;background:#0b1623;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:#d5e7ff}

/* helper */
.small{color:var(--muted);font-size:12px;margin:4px 2px}
</style>
</head>
<body>
<div class="sticky">
  <div class="wrap head">
    <div class="h1">2025 æ±äº¬è¿‘éƒŠæ—…éŠ</div>
    <div class="route">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>
  </div>
  <div class="wrap days">
    <div class="day active"><div class="date">09/20</div><div class="place">éŒå€‰</div></div>
    <div class="day"><div class="date">09/21</div><div class="place">ç®±æ ¹</div></div>
    <div class="day"><div class="date">09/22</div><div class="place">ç†±æµ·</div></div>
    <div class="day"><div class="date">09/23</div><div class="place">æ²³å£æ¹–</div></div>
  </div>
</div>

<div class="wrap">
  <div class="title">äº’å‹•åœ°åœ–ï¼ˆé»åœ–æ¨™çœ‹è³‡è¨Šï¼ç…§ç‰‡ç‰†è·Ÿè‘—åˆ‡æ›ï¼‰</div>
  <div class="mapwrap">
    <div id="map"></div>
    <div class="layerCtl" id="layerCtl">
      <label><input type="checkbox" id="chkMain" checked> ä¸»è¡Œç¨‹ / ç²¾è¯æˆ–è¿‘ä¼¼</label>
      <label><input type="checkbox" id="chkOpt" checked> å¯æœ‰å¯ç„¡</label>
      <label><input type="checkbox" id="chkToilet" checked> å»æ‰€</label>
    </div>
    <div class="vbox">
      <div class="vbtn" id="btnHere">æˆ‘åœ¨é€™</div>
      <div class="vbtn" id="btnFollow">è·Ÿéš¨æˆ‘</div>
    </div>
  </div>

  <div class="title">ç…§ç‰‡ç‰†ï¼ˆé»åœ°åœ–æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</div>
  <div class="album">
    <div id="phGrid" class="grid"></div>
    <div id="phEmpty" class="empty">æš«ç„¡ç…§ç‰‡</div>
  </div>

  <div class="title">æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</div>
  <div class="small">æœ¬é è®€å–ï¼štimeline-2025-09-20_v6.csv ï¼ photos-2025-09-20-mapped.csv ï¼ coords-override-2025-09-20.json</div>
  <div class="twrap">
    <div class="thead"><div>æ™‚é–“</div><div>åœ°é» / æ´»å‹•</div><div>é¡åˆ¥</div><div>è»ŠMap Code</div></div>
    <div id="tRows"></div>
  </div>
</div>

<script>
// ===== utilities =====
const $ = sel => document.querySelector(sel);
const esc = s => String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
function pill(code){ return code? `<span class="pill">ğŸš— <b>${esc(code)}</b></span>`: '' }
function key(obj, arr){ return arr.find(k => k in obj) }

// ===== files =====
const F = {
  coords: 'coords-override-2025-09-20.json',
  timeline: 'timeline-2025-09-20_v6.csv',
  photos: 'photos-2025-09-20-mapped.csv'
};
let COORDS = {}, PHOTOS = {};

// ===== map =====
const map = L.map('map', { zoomControl:true, attributionControl:true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
const gMain = L.layerGroup().addTo(map);
const gOpt = L.layerGroup().addTo(map);
const gToilet = L.layerGroup().addTo(map);
let mainLine = null;
$('#chkMain').onchange = e=>{ e.target.checked ? map.addLayer(gMain) : map.removeLayer(gMain); if(mainLine){ e.target.checked ? map.addLayer(mainLine) : map.removeLayer(mainLine);} };
$('#chkOpt').onchange  = e=>{ e.target.checked ? map.addLayer(gOpt)  : map.removeLayer(gOpt) };
$('#chkToilet').onchange= e=>{ e.target.checked ? map.addLayer(gToilet): map.removeLayer(gToilet) };

// locate
let me=null, watchId=null;
$('#btnHere').onclick = ()=>{
  if(!navigator.geolocation) return alert('æ­¤è£ç½®ä¸æ”¯æ´å®šä½');
  navigator.geolocation.getCurrentPosition(p=>{
    const ll=[p.coords.latitude,p.coords.longitude];
    if(!me) me = L.marker(ll,{title:'æˆ‘åœ¨é€™'}).addTo(map); else me.setLatLng(ll);
    map.setView(ll, 16);
  },err=>alert('å®šä½å¤±æ•—'));
};
$('#btnFollow').onclick = (e)=>{
  if(!navigator.geolocation) return alert('æ­¤è£ç½®ä¸æ”¯æ´å®šä½');
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; e.currentTarget.classList.remove('active'); return; }
  e.currentTarget.classList.add('active');
  watchId = navigator.geolocation.watchPosition(p=>{
    const ll=[p.coords.latitude,p.coords.longitude];
    if(!me) me = L.marker(ll,{title:'æˆ‘åœ¨é€™'}).addTo(map); else me.setLatLng(ll);
    map.setView(ll, 16);
  });
};

// ===== photo wall =====
function showPhotos(place){
  const key = (place||'').replace(/\s+/g,'').replace(/[()ï¼ˆï¼‰]/g,'').toLowerCase();
  const list = PHOTOS[key] || [];
  const grid = $('#phGrid'), empty=$('#phEmpty');
  grid.innerHTML='';
  if(!list.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  list.forEach(u=>{
    const img = new Image();
    img.loading='lazy';
    img.src = /^https?:/.test(u)? u : ('assets/img/'+u.replace(/^assets\/img\//,''));
    const cell = document.createElement('div'); cell.className='';
    const wrap = document.createElement('div'); wrap.className='';
    const holder = document.createElement('div'); holder.className='';
    const frame = document.createElement('div'); frame.className='';
    const box = document.createElement('div'); box.className='';
    const ph = document.createElement('div'); ph.className='';
    const cont = document.createElement('div'); cont.className='ph';
    cont.appendChild(img);
    $('#phGrid').appendChild(cont);
  });
}

// ===== data load =====
Promise.all([
  fetch(F.coords).then(r=>r.json()),
  new Promise(res => Papa.parse(F.photos,{download:true,header:true,skipEmptyLines:true,complete:res})),
  new Promise(res => Papa.parse(F.timeline,{download:true,header:true,skipEmptyLines:true,complete:res}))
]).then(([coords, photosRes, tlRes])=>{
  COORDS = coords || {};
  // photos map by normalized place name
  (photosRes.data||[]).forEach(row=>{
    const name = row['åœ°é» / æ´»å‹•'] || row['åœ°é»'] || row['place'] || row['name'] || '';
    const url  = row['url'] || row['ç…§ç‰‡'] || row['æª”å'] || row['src'] || '';
    if(!name || !url) return;
    const key = name.replace(/\s+/g,'').replace(/[()ï¼ˆï¼‰]/g,'').toLowerCase();
    (PHOTOS[key] = PHOTOS[key] || []).push(url);
  });

  // build map + timeline
  const rows = tlRes.data||[];
  buildUI(rows);
}).catch(err=>{
  console.error(err);
  alert('ç„¡æ³•è¼‰å…¥è³‡æ–™æª”ï¼Œè«‹ç¢ºèªä¸‰å€‹æª”æ¡ˆèˆ‡æœ¬é åŒå±¤ã€‚');
});

function buildUI(rows){
  const kPlace = rows.length? ( key(rows[0], ['åœ°é» / æ´»å‹•','åœ°é»','place','name']) ) : 'åœ°é» / æ´»å‹•';
  const kCat   = rows.length? ( key(rows[0], ['é¡åˆ¥','åˆ†é¡']) ) : 'é¡åˆ¥';
  const kNote  = rows.length? ( key(rows[0], ['å‚™è¨»','note']) ) : 'å‚™è¨»';
  const kStart = rows.length? ( key(rows[0], ['æ™‚é–“èµ·','start']) ) : 'æ™‚é–“èµ·';
  const kEnd   = rows.length? ( key(rows[0], ['æ™‚é–“è¿„','end']) ) : 'æ™‚é–“è¿„';
  const kGmap  = rows.length? ( key(rows[0], ['ğŸ“ æ™¯é»é€£çµ','Google åœ°åœ–','Googleåœ°åœ–']) ) : 'ğŸ“ æ™¯é»é€£çµ';
  const kCode  = rows.length? ( key(rows[0], ['ğŸš™è»ŠMap Code','è»ŠMap Code','è»ŠMapCode','Map Code']) ) : 'ğŸš™è»ŠMap Code';

  const tRows = $('#tRows'); tRows.innerHTML='';
  const bounds=[]; const mainPts=[];

  rows.forEach(r=>{
    const name = (r[kPlace]||'').trim();
    if(!name) return;
    const cat = (r[kCat]||'').trim();
    const note= (r[kNote]||'').trim();
    const start=(r[kStart]||'').trim();
    const end=(r[kEnd]||'').trim();
    const gmap=(r[kGmap]||'').trim();
    const code=(r[kCode]||'').trim();
    const coords = COORDS[name];

    // timeline row (ä½ å–œæ­¡çš„ç‰ˆå‹)
    const row = document.createElement('div'); row.className='trow';
    const timeTwoLines = `${esc(start)}\n${esc(end)}`;
    row.innerHTML = `
      <div class="tgrid">
        <div class="ttime">${timeTwoLines}</div>
        <div class="tplace"><span class="pin">ğŸ“</span>${gmap?`<a href="${esc(gmap)}" target="_blank">${esc(name)}</a>`:esc(name)}</div>
        <div class="tcat">${esc(cat)}</div>
        <div class="tcode">${pill(code)}</div>
      </div>
      ${note?`<div class="note"><b>å‚™è¨»ï¼š</b>${esc(note)}</div>`:''}
    `;
    tRows.appendChild(row);

    // map markers
    if(coords && Array.isArray(coords) && coords.length===2){
      const ll = [parseFloat(coords[0]), parseFloat(coords[1])];
      const m = L.marker(ll,{title:name});
      const layer = (cat==='å¯æœ‰å¯ç„¡')? gOpt : (cat==='å»æ‰€')? gToilet : gMain;
      m.addTo(layer);
      m.bindPopup(`
        <div style="min-width:240px">
          <div style="font-weight:900;font-size:18px;margin-bottom:6px">${esc(name)}</div>
          ${pill(code)}
          ${note?`<div style="color:#cfe0ff;margin-top:8px">${esc(note)}</div>`:''}
          ${gmap?`<div style="margin-top:8px"><a href="${esc(gmap)}" target="_blank">ğŸ“ Google åœ°åœ–</a></div>`:''}
        </div>
      `);
      m.on('click',()=>showPhotos(name));
      bounds.push(ll);
      if(layer===gMain) mainPts.push(ll);
    }
  });

  if(bounds.length){ map.fitBounds(bounds,{padding:[20,20]}); } else { map.setView([35.318,139.55], 12); }
  if(mainPts.length>1){ mainLine = L.polyline(mainPts,{color:'#4ea1ff',weight:4,opacity:.8}).addTo(map); }
}
</script>
</body>
</html>
