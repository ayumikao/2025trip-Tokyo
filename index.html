<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 æ±äº¬è¿‘éƒŠæ—…éŠ | 9/20 éŒå€‰</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0f1720;         /* ä¸»èƒŒæ™¯ æ·±è—ç° */
  --panel:#121a24;      /* å¡ç‰‡ */
  --panel-2:#0c131b;    /* æ›´æ·± */
  --text:#e8f0ff;       /* ä¸»è¦å­— */
  --muted:#9bb3cf;      /* æ¬¡è¦å­— */
  --accent:#2b6fff;     /* é«˜äº®è— */
  --accent-2:#173867;   /* è—æ¡† */
  --chip:#1a2430;       /* è† å›Šåº• */
  --chip-border:#2a3a4d;
  --pill:#232a35;       /* MAPCODE è† å›Šåº• */
  --pill-border:#2d3a49;
  --yellow:#ffd24a;     /* MAPCODE é»ƒå­— */
  --card-shadow:0 8px 24px rgba(0,0,0,.35);
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1200px 600px at 50% -250px, #1a2740 0%, var(--bg) 60%);
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
.container{max-width:980px;margin:0 auto;padding:20px 16px 64px}
header h1{font-size:34px;letter-spacing:.08em;margin:0 0 6px}

/* è·¯ç·šå­—ä¸²ï¼šç½®ä¸­ï¼‹å–®è¡Œå¯æ©«å‘æ»‘å‹• */
.breadcrumb{
  color:var(--muted);
  font-size:16px;
  letter-spacing:.2em;
  margin-bottom:14px;
  white-space: nowrap;       /* â† ä¸æ›è¡Œ */
  text-align: center;        /* â† ç½®ä¸­ */
  overflow-x: auto;          /* è¶…å‡ºå°±å¯å·¦å³æ»‘ */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.breadcrumb::-webkit-scrollbar{ display:none; }

/* æ—¥æœŸæŒ‰éˆ•åˆ—ï¼šç½®ä¸­ï¼‹ä¸æ›è¡Œ */
.date-row{
  display:flex;
  align-items:center;
  justify-content:center;    /* â† ç½®ä¸­ */
  flex-wrap:nowrap;          /* ä¸æ›è¡Œï¼ˆè¦å…¨éƒ¨ä¸€è¡Œé¡¯ç¤ºï¼‰ */
  gap:8px;                   /* æŒ‰éˆ•é–“è·ç¸®å° */
  margin-bottom:12px;
  position:sticky;
  top:0;
  z-index:20;
  padding:8px 0 10px;
  background:linear-gradient(180deg, rgba(15,23,32,.96) 60%, rgba(15,23,32,0));
  backdrop-filter:saturate(140%) blur(2px);
}
.date-row::-webkit-scrollbar{ display:none; }   /* æ‰‹æ©Ÿéš±è—æ²è»¸ */

/* æ—¥æœŸæŒ‰éˆ•ï¼šä¿ç•™åŸæ¨£ä½†ç¸®å°å°ºå¯¸ */
.date-btn{
  border-radius:20px;   /* ä¿ç•™åœ“è§’ */
  border:2px solid var(--accent-2);
  background:linear-gradient(180deg,#141d29,#0e1621);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 2px 6px rgba(0,0,0,.25);
  color:var(--text);
  padding:6px 9px;      /* â† æ¸›å°‘ä¸Šä¸‹å·¦å³ padding */
  min-width:80px;       /* â† åŸæœ¬ 120pxï¼Œç¸®å° */
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;              /* â† åŸæœ¬ 6pxï¼Œç¸®å° */
  text-decoration:none;
}
.date-btn .d{
  font-size:16px;       /* â† åŸæœ¬ 22pxï¼Œç¸®å° */
  font-weight:700;
  letter-spacing:.05em;
}
.date-btn .l{
  font-size:12px;       /* â† åŸæœ¬ 14pxï¼Œç¸®å° */
  color:#b9c7db;
  letter-spacing:.15em;
}
.date-btn.active{
  border-color:#3d65ff; outline:3px solid rgba(61,101,255,.35);
  background:linear-gradient(180deg,#122645,#0f1d33);
}

@media (max-width: 520px) {
  .date-btn { min-width:80px; padding:6px 10px; } /* â† æ‰‹æ©Ÿç¸®å°æŒ‰éˆ•çš„æœ€å°å¯¬åº¦èˆ‡ç•™ç™½ */
  .date-btn .d { font-size:14px; }   /* æ—¥æœŸå­—é«”ç¸®å° */
  .date-btn .l { font-size:12px; }   /* åœ°åå­—é«”ç¸®å° */
  #map{height:380px}
}

/* Map Card */
.card{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:12px;margin:0 0 18px}
#map{height:430px;border-radius:14px;overflow:hidden}
.leaflet-container{background:#0b131c}

/* map inner overlay elements */
.map-overlay{
  position:absolute;
  top:12px;
  right:12px;    /* â† å³ä¸Šè§’ */
  bottom:auto;
  left:auto;
  z-index:450;
  pointer-events:auto;
}

/* åœ–å±¤æ§åˆ¶ï¼ˆåŠé€æ˜ã€ç·Šé‚Šã€å…å·è»¸ï¼‰ */
.layers-card{
  background:rgba(12,19,27,0.5);  /* åŠé€æ˜èƒŒæ™¯ (0.5=50%é€æ˜) */
  border-radius:14px;
  padding:4px 6px;        /* â† æ§åˆ¶ä¸Šä¸‹å·¦å³å…§è·ï¼Œå­—é é‚Šæ¡† */
  min-width:90px;         /* â† æœ€å°å¯¬åº¦ */
  box-shadow:0 10px 26px rgba(0,0,0,.45);

  /* é«˜åº¦èˆ‡å·è»¸æ§åˆ¶ */
  height:auto;            /* é«˜åº¦éš¨å…§å®¹ */
  max-height:none;        /* æ²’æœ‰é™åˆ¶é«˜åº¦ */
  overflow-y:visible;     /* ä¸è¦å·è»¸ */
}
.layers-card label{
  display:flex;
  align-items:center;
  gap:6px;                /* â† checkbox èˆ‡æ–‡å­—é–“è· */
  margin:2px 0;           /* â† ä¸Šä¸‹é–“è·ç¸®å° */
  line-height:1.2;        /* è¡Œé«˜æ›´ç·Š */
  color:#d7e4ff;
  font-size:14px;         /* â† æ–‡å­—å¤§å° */
}
.layers-card input{width:16px;height:16px}

/* å³ä¸‹ï¼šæˆ‘åœ¨é€™ï¼è·Ÿéš¨æˆ‘ï¼ˆåŠé€æ˜ï¼‰ */
.vbtns{
  position:absolute;
  right:12px;
  bottom:12px;           /* â† å³ä¸‹è§’ */
  display:flex;
  flex-direction:column; /* å‚ç›´æ’åˆ—ï¼šä¸Šæ–¹æœƒæ˜¯ã€Œæˆ‘åœ¨é€™ã€ï¼Œä¸‹æ–¹ã€Œè·Ÿéš¨æˆ‘ã€ */
  gap:10px;
  z-index:450;
}
.vbtn{
  background:rgba(13,20,28,0.5); /* â† 50% é€æ˜ */
  color:#fff;
  /*border:1px solid #213040;*/ /*æˆ‘åœ¨é€™ï¼Œé‚Šæ¡†*/
  border-radius:12px;
  padding:10px 8px;
  line-height:1.2;
  writing-mode:vertical-rl;
  text-orientation:mixed;
  letter-spacing:.3em;
  cursor:pointer;
}
.vbtn:active{transform:translateY(1px)}

@supports (padding: max(0px)) {
  .vbtns{ bottom: max(12px, env(safe-area-inset-bottom)); right: max(12px, env(safe-area-inset-right)); }
}

/* Photo wall */
.section-title{font-weight:700;letter-spacing:.2em;font-size:18px;margin:2px 0 10px;color:#dce9ff}
.photo-wall{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);min-height:120px;padding:16px;margin-bottom:18px}
.photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.photos img{width:100%;height:100px;object-fit:cover;border-radius:10px;border:1px solid #233246}
.empty{color:#9cb1c9}

/* Timeline */
.table{width:100%;border-collapse:separate;border-spacing:0 12px}
.th-row th{color:#d7e6ff;text-align:left;font-weight:800;letter-spacing:.25em;padding:8px 12px}
.tr{background:var(--panel);border:1px solid #1f2b3a;border-radius:14px;box-shadow:var(--card-shadow)}
.td{padding:14px 14px;vertical-align:top}
.time{font-size:22px;font-weight:700;letter-spacing:.15em;white-space:pre-line}
.place{font-size:20px;font-weight:700;letter-spacing:.03em}
.note{margin-top:8px;color:#c9d8ef}
.cat{font-size:20px;font-weight:800;letter-spacing:.4em}
.mapcode{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:22px;
  background:var(--pill);border:1px solid var(--pill-border);}
.mapcode .car{font-size:20px}
.mapcode .code{color:#ffd24a;font-weight:800;font-size:20px;letter-spacing:.05em}
.badge{display:inline-block;margin-top:6px;color:#8fb6ff}

/* util */
hr.sep{border:none;border-top:1px dashed #213141;margin:10px 0}
a, a:visited{color:#2ea0ff}

/* position wrappers */
.map-wrap{position:relative}

/* keep leaflet controls inside without overlapping header */
.leaflet-top.leaflet-left{top:12px;left:12px}
.leaflet-control-zoom a:hover{
  border-radius:10px;
  background:rgba(14,23,34,0.8);   /*+- â† åŠé€æ˜ï¼Œ0.8=80% */
  color:#fff;
  border:1px solid #203146;
}

/* æ§åˆ¶æ•´å€‹ç¸®æ”¾å€å¡Šçš„ä½ç½® */
.leaflet-top.leaflet-left{
  top:1px;     /* â† å¾€ä¸Šè²¼è¿‘é‚Šç·£ */
  left:1px;    /* â† å¾€å·¦è²¼è¿‘é‚Šç·£ */
}

/* åªç§»é™¤åœ°åœ–å¡ç‰‡çš„å¤–æ¡†ï¼ˆå’Œé™°å½±ï¼‰ */
.card.map-wrap{
  border: none;          /* â† å–æ¶ˆé‚£æ¢ 1px å¤–æ¡†ç·šçš„ä¾†æº */
  /* box-shadow: none;  â† å¦‚æœé€£é™°å½±éƒ½ä¸æƒ³è¦ï¼Œæ‰“é–‹é€™è¡Œ */
}
</style>

</head>
<body>
  <div class="container">
    <header>
      <h1 style="text-align: center;">2025 æ±äº¬è¿‘éƒŠæ—…éŠ</h1>
      <div class="breadcrumb">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>
      <div class="date-row" id="dateRow">
        <a class="date-btn active" href="#"><span class="d">09/20</span><span class="l">éŒå€‰</span></a>
        <a class="date-btn" href="#"><span class="d">09/21</span><span class="l">ç®±æ ¹</span></a>
        <a class="date-btn" href="#"><span class="d">09/22</span><span class="l">ç†±æµ·</span></a>
        <a class="date-btn" href="#"><span class="d">09/23</span><span class="l">ä¼Šè±†åŠå³¶</span></a>
      </div>
    </header>

    <div class="card map-wrap">
      <div id="map"></div>
      <!-- Layers card (inside map, top-right) -->
      <div class="map-overlay">
        <div class="layers-card" id="layersCard">
          <label><input type="checkbox" id="layer-main" checked> ä¸»è¡Œç¨‹</label>
          <label><input type="checkbox" id="layer-optional" checked> å¯æœ‰å¯ç„¡</label>
          <label><input type="checkbox" id="layer-restroom" checked> å»æ‰€</label>
        </div>
      </div>
      <!-- Vertical buttons (inside map, right) -->
      <div class="vbtns">
        <button id="btnHere" class="vbtn">æˆ‘åœ¨é€™</button>
        <button id="btnFollow" class="vbtn">è·Ÿéš¨æˆ‘</button>
      </div>
    </div>

    <div>
      <div class="section-title">ç…§ç‰‡ç‰†ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</div>
      <div class="photo-wall">
        <div id="photos" class="photos"></div>
        <div id="emptyPhotos" class="empty">æš«ç„¡ç…§ç‰‡</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</div>
      <div class="badge" id="srcInfo"></div>
      <table class="table" id="timelineTable">
        <thead class="th-row">
          <tr>
            <th style="width:110px">æ™‚é–“</th>
            <th>åœ°é» / æ´»å‹•</th>
            <th style="width:72px">é¡åˆ¥</th>
            <th style="width:180px">è»ŠMap Code</th>
          </tr>
        </thead>
        <tbody id="timelineBody"></tbody>
      </table>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- Utilities ----------------
function parseCSV(text){
  // simple csv parser (handles quoted commas/newlines)
  const rows=[];let i=0, cur='', inQ=false; const push=()=>{rows.push(cur);cur=''};
  const out=[]; let row=[];
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){cur+='"'; i+=2; continue;}
      if(c==='"' ){inQ=false;i++; continue;}
      cur+=c; i++; continue;
    }else{
      if(c==='"'){inQ=true;i++; continue;}
      if(c===','){ row.push(cur); cur=''; i++; continue;}
      if(c==='\n'){ row.push(cur); cur=''; out.push(row); row=[]; i++; continue;}
      if(c==='\r'){ i++; continue;}
      cur+=c; i++; continue;
    }
  }
  if(cur.length || row.length){ row.push(cur); out.push(row); }
  // first row as header
  const header=out.shift().map(s=>s.trim());
  return out.filter(r=>r.some(x=>x&&x.trim()!=='')).map(r=>{
    const obj={}; header.forEach((h,idx)=>obj[h]= (r[idx]??'').trim()); return obj;
  });
}
function byKeys(obj,keys){ for(const k of keys){ if(k in obj && obj[k]!=='' ) return obj[k]; } return ''; }
function toTimeBlock(s,e){
  const fmt=t=>t.replace(':','ï¼š'); // fullwidth colon feel
  return fmt(s)+'\n'+fmt(e);
}
function el(tag,cls,html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }

// ======= Column mapï¼ˆä½  CSV æ¨™é¡Œæ€éº¼å¯«éƒ½è¡Œï¼Œé€™è£¡åˆ—å‡ºåˆ¥åï¼‰=======
const COL = {
  start:  ['start','é–‹å§‹','start_time','é–‹å§‹æ™‚é–“'],
  end:    ['end','çµæŸ','end_time','çµæŸæ™‚é–“'],
  title:  ['åœ°é» / æ´»å‹•','åœ°é»','æ´»å‹•','åç¨±','place','title'],
  note:   ['å‚™è¨»','å‚™è¨»èªªæ˜','note','desc','èªªæ˜'],
  category: ['é¡åˆ¥','åˆ†é¡','category','cat'],
  mapcode:  ['mapcode','Map Code','MapCode','MAPCODE','è»ŠMap Code','Map Code (Car)'],
  lat:    ['lat','ç·¯åº¦'],
  lng:    ['lng','ç¶“åº¦'],
  link:   ['google','gmap','map','link','Google åœ°åœ–','GoogleMap'],
  layer:  ['åœ–å±¤','layer','åœ–å±¤åˆ†é¡'],           // ä¸»è¡Œç¨‹ / å¯æœ‰å¯ç„¡ / å»æ‰€
  seq:    ['é †åº','order','seq','åº']            // å¯é¸ï¼Œç•«ç·šé †åº
};
// è®€æ¬„ä½ï¼šåªè¦ CSV æœ‰å…¶ä¸­ä¸€å€‹æ¨™é¡Œå°±æŠ“å¾—åˆ°
function get(r, key){
  const keys = COL[key] || [];
  for(const k of keys){
    if(k in r && r[k] !== '') return (r[k]||'').trim();
  }
  return '';
}
// æ­£è¦åŒ–å­—ä¸²ï¼ˆæ¯”å° key ç”¨ï¼‰
function norm(s){ return String(s||'').toLowerCase().replace(/\s|ã€€/g,''); }
// å°‡å­—ä¸²æ¨™æº–åŒ–ï¼šå°å¯« + å»æ‰åŠå½¢/å…¨å½¢ç©ºç™½
function norm(s){ return String(s||'').toLowerCase().replace(/\s|ã€€/g,''); }

// åœ–å±¤åç¨±æ­£è¦åŒ–ï¼ˆæ”¯æ´å¤šå¯«æ³•ï¼›ä»»ä½•ä¸æ˜çš„éƒ½è¦–ç‚ºä¸»è¡Œç¨‹ï¼‰
function normalizeLayer(s){
  const t = norm(s);
  if (!t) return 'ä¸»è¡Œç¨‹';

  // å¯æœ‰å¯ç„¡ï¼ˆoptional/æ¬¡è¦/é¸æ“‡æ€§â€¦ï¼‰
  if (
    t.includes('å¯æœ‰å¯ç„¡') ||
    t.includes('å¯é¸') ||
    t.includes('æ¬¡è¦') ||
    t.includes('optional') ||
    t.includes('option') ||
    t.includes('opt')
  ) return 'å¯æœ‰å¯ç„¡';

  // å»æ‰€ï¼ˆå»/æ´—æ‰‹é–“/WC/restroom/toiletï¼‰
  if (
    t.includes('å»') ||
    t.includes('æ´—æ‰‹é–“') ||
    t.includes('åŒ–å¦å®¤') ||
    t.includes('restroom') ||
    t.includes('toilet') ||
    t.includes('wc')
  ) return 'å»æ‰€';

  return 'ä¸»è¡Œç¨‹';
}

// å¯¬é¬†æŠ“åœ–å±¤æ¬„ä½ï¼šå…ˆç”¨ COL.layerï¼›æŠ“ä¸åˆ°å°±æƒä¸€éæ¬„åæ‰¾å« layer/åœ–å±¤/åœ–å±¤åˆ†é¡/åˆ†é¡ çš„æ¬„ä½
function getLayer(r){
  // 1) ä¾å°æ‡‰è¡¨
  let raw = get(r,'layer');
  if (raw) return raw;

  // 2) æŠ“ä¸åˆ°å°±å¯¬é¬†æƒææ¬„å
  const keys = Object.keys(r||{});
  let foundKey = keys.find(k => /layer|åœ–å±¤/i.test(k));
  if (!foundKey) {
    foundKey = keys.find(k => /åœ–å±¤åˆ†é¡|åˆ†é¡|category/i.test(k));
  }
  return foundKey ? r[foundKey] : '';
}

// ---------------- Data files ----------------
const FILE_TIMELINE = "timeline-2025-09-20_v6.csv";
const FILE_PHOTOS   = "photos-2025-09-20-mapped.csv";
const FILE_COORDS   = "coords-override-2025-09-20.json";
const srcBadge = document.getElementById('srcInfo');
if (srcBadge) srcBadge.textContent = `æœ¬é è®€å–ï¼š ${FILE_TIMELINE}ã€${FILE_PHOTOS}ã€${FILE_COORDS}`;

// ---------------- Map init ----------------
const map = L.map('map',{ zoomControl:true, attributionControl:true }).setView([35.319,139.55], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// Layer groups
const gMain = L.layerGroup().addTo(map);
const gOptional = L.layerGroup().addTo(map);
const gRest = L.layerGroup().addTo(map);
const layers = { "ä¸»è¡Œç¨‹":gMain, "å¯æœ‰å¯ç„¡":gOptional, "å»æ‰€":gRest };
// æ”¶é›†ä¸»è¡Œç¨‹ç¯€é»ç”¨ä¾†ç•«ç·š
let routeNodes = [];
let routeLine = null;

// UI layer toggles
const cMain = document.getElementById('layer-main');
const cOpt  = document.getElementById('layer-optional');
const cRes  = document.getElementById('layer-restroom');
// ä¸»è¡Œç¨‹æ ¸å–æ–¹å¡Šéœ€è¦é€£åŒè·¯ç·šä¸€èµ·æ§åˆ¶
if (cMain) cMain.onchange = () => {
  if (cMain.checked) {
    map.addLayer(gMain);
    if (routeLine) map.addLayer(routeLine);
  } else {
    map.removeLayer(gMain);
    if (routeLine) map.removeLayer(routeLine);
  }
};
if (cOpt) cOpt.onchange  = () => { cOpt.checked ? map.addLayer(gOptional) : map.removeLayer(gOptional); };
if (cRes) cRes.onchange  = () => { cRes.checked ? map.addLayer(gRest) : map.removeLayer(gRest); };

// Here / Follow
let watchId=null;
const btnHere = document.getElementById('btnHere');
const btnFollow = document.getElementById('btnFollow');
if (btnHere) btnHere.onclick = ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      const latlng=[p.coords.latitude,p.coords.longitude];
      L.marker(latlng,{title:"æˆ‘åœ¨é€™",riseOnHover:true}).addTo(map);
      map.flyTo(latlng, 14, {duration:0.8});
    });
  }
};
if (btnFollow) btnFollow.onclick = ()=>{
  if(!navigator.geolocation){ return; }
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; alert('å·²åœæ­¢è·Ÿéš¨'); return; }
  watchId = navigator.geolocation.watchPosition(p=>{
    const latlng=[p.coords.latitude,p.coords.longitude];
    L.circleMarker(latlng,{radius:6,color:'#77b2ff',fill:true,fillOpacity:.8}).addTo(map);
    map.panTo(latlng);
  },err=>console.warn(err),{enableHighAccuracy:true,maximumAge:10000,timeout:20000});
  alert('é–‹å§‹è·Ÿéš¨');
};

// Photos mapping
let photoMap = {}; // key => [urls]
function setPhotosForKey(key){
  const wrap = document.getElementById('photos'); const empty = document.getElementById('emptyPhotos');
  if (!wrap || !empty) return;
  wrap.innerHTML='';
  const arr = photoMap[key]||[];
  if(arr.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  arr.forEach(u=>{
    const img = new Image(); img.src=u; wrap.appendChild(img);
  });
}

// ---------------- Load data ----------------
Promise.all([
  fetch(FILE_TIMELINE).then(r=>r.text()),
  fetch(FILE_PHOTOS).then(r=>r.ok?r.text():""),
  fetch(FILE_COORDS).then(r=>r.ok?r.json():{})
]).then(([csvTimeline,csvPhotos,coordOverride])=>{
  // å»º coords ç´¢å¼•ï¼Œè®“åç¨±æ¯”å°ä¸å—å¤§å°å¯«/ç©ºç™½å½±éŸ¿
  const coordIndex = {};
  if (coordOverride && typeof coordOverride === 'object') {
    Object.keys(coordOverride).forEach(k => {
      coordIndex[norm(k)] = coordOverride[k];
    });
  }

  // photosï¼ˆç¶­æŒä½ åŸæœ¬è®€æ³•ï¼‰
  if(csvPhotos){
    const rows = parseCSV(csvPhotos);
    rows.forEach(r=>{
      const k = byKeys(r, ['key','Key','åç¨±','åœ°é»','place','title']);
      const url = byKeys(r,['url','URL','link']);
      if(!k || !url) return;
      (photoMap[k] = photoMap[k] || []).push(url);
    });
  }

  // è§£æè¡Œç¨‹ CSV
  const rows = parseCSV(csvTimeline);

  // æ¸…ç©ºèˆŠè³‡æ–™
  routeNodes = [];
  const tb = document.getElementById('timelineBody');
  if (tb) tb.innerHTML = '';

  // å»ºæ™‚é–“è»¸ï¼‹åœ°åœ–é»ä½ï¼ˆåˆ†å±¤ï¼‰ï¼‹æ”¶é›†ä¸»è¡Œç¨‹ç¯€é»
  rows.forEach(r=>{
    const start = get(r,'start');
    const end   = get(r,'end');
    const title = get(r,'title');
    const note  = get(r,'note');
    const cat   = get(r,'category');
    const code  = get(r,'mapcode');
    const link  = get(r,'link') || '#';
    const seqStr = get(r,'seq');
    const seq = seqStr ? parseFloat(seqStr) : NaN;  // ç•«ç·šæ’åºï¼ˆå¯ç¼ºï¼‰

    // timeline rowï¼ˆç¶­æŒåŸä¾†è¡¨æ ¼è¼¸å‡ºï¼‰
    if (tb){
      const tr = el('tr','tr');
      const td1 = el('td','td'); td1.style.width='110px'; td1.innerHTML = '<div class="time">'+toTimeBlock(start,end)+'</div>';
      const td2 = el('td','td');
      td2.innerHTML = `<div class="place">${title||''}</div><div class="badge">ğŸ“ <a href="${link}" target="_blank">Google åœ°åœ–</a></div>` + (note? `<div class="note">å‚™è¨»ï¼š${note}</div>`:'');
      const td3 = el('td','td'); td3.innerHTML = `<div class="cat">${(cat||'').replace(/\s/g,'')}</div>`;
      const td4 = el('td','td'); td4.innerHTML = `<div class="mapcode"><span class="car">ğŸš—</span><span class="code">${code||''}</span></div>`;
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
      tb.appendChild(tr);
    }

    // å–å¾—åº§æ¨™ï¼šå„ªå…ˆ coords-overrideï¼ˆåç¨±å®¹éŒ¯ï¼‰ï¼Œå¦å‰‡ç”¨ CSV lat/lng
    let latlng = null;
    if (title && coordIndex[norm(title)]) {
      latlng = coordIndex[norm(title)];
    } else {
      const lat = get(r,'lat');
      const lng = get(r,'lng');
      if (lat && lng) latlng = [parseFloat(lat), parseFloat(lng)];
    }
    if (!latlng) return; // æ²’åº§æ¨™ â†’ åªé¡¯ç¤ºåœ¨æ™‚é–“è»¸ï¼Œä¸æ”¾åœ°åœ–

    // marker + popup
    const m = L.marker(latlng, { title }).on('click', ()=> setPhotosForKey(title));
    const pop = `<div style="font-weight:800;font-size:18px;margin-bottom:6px">${title}</div>
                 ${code? `<div class="mapcode"><span class="car">ğŸš—</span><span class="code">${code}</span></div>`:''}
                 ${note? `<div style="margin-top:8px;color:#c9d8ef">${note}</div>`:''}
                 <div style="margin-top:6px"><a href="${link}" target="_blank">ğŸ“ Google åœ°åœ–</a></div>`;
    m.bindPopup(pop,{closeButton:true,autoPan:true});

    // ç”¨ã€Œé¡åˆ¥ã€æ¬„ä¾†åˆ¤æ–·åœ–å±¤
const catVal = (get(r,'category') || '').trim();

// é è¨­ä¸»è¡Œç¨‹
let g = gMain;

// åˆ¤æ–·é—œéµå­—
if (/å¯æœ‰å¯ç„¡/i.test(catVal)) {
  g = gOptional;
} else if (/å»æ‰€/i.test(catVal)) {
  g = gRest;
}

g.addLayer(m);

    // ä¸»è¡Œç¨‹ â†’ æ”¶é›†ç¯€é»ç•«ç·š
    if (g === gMain) {
      routeNodes.push({ seq, latlng });
    }
  });

  // è¿´åœˆçµæŸå¾Œï¼šç•«ä¸»è¡Œç¨‹é€£ç·š
  routeNodes.sort((a,b)=>{
    const A = isNaN(a.seq) ? Number.POSITIVE_INFINITY : a.seq;
    const B = isNaN(b.seq) ? Number.POSITIVE_INFINITY : b.seq;
    return A - B;
  });
  const routePoints = routeNodes.map(n => n.latlng);
  if (routePoints.length > 1) {
    routeLine = L.polyline(routePoints, { color:'#5ea0ff', weight:3, opacity:0.85 }).addTo(map);
    // å¯é¸ï¼šè‡ªå‹•ç¸®æ”¾åˆ°ä¸»è¡Œç¨‹ç¯„åœ
    map.fitBounds(routeLine.getBounds(), { padding: [20,20] });
    // è‹¥ã€Œä¸»è¡Œç¨‹ã€æ ¸å–æ–¹å¡Šä¸€é–‹å§‹æ˜¯å–æ¶ˆçš„ï¼Œä¹ŸæŠŠç·šä¸€èµ·éš±è—
    if (cMain && !cMain.checked) { map.removeLayer(routeLine); }
  }

}).catch(err=>{
  console.error(err);
  const tb = document.getElementById('timelineBody');
  if (tb) tb.innerHTML = '<tr><td colspan="4" class="td">è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª CSV / JSON æª”æ¡ˆæ˜¯å¦èˆ‡ index åŒå±¤ã€‚</td></tr>';
});
</script>
</body>
</html>
