<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 æ±äº¬è¿‘éƒŠæ—…éŠ | 9/20 éŒå€‰</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
:root{
  --bg:#0e1621;
  --bg2:#0b1320;
  --panel:#0f1b2b;
  --card:#101b2a;
  --text:#e9f1ff;
  --muted:#9fb3c8;
  --accent:#3b82f6;
  --chip:#1a2740;
  --mapcode:#ffa94d;
  --success:#16a34a;
  --danger:#ef4444;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --radius:18px;
  --navH:98px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial}
a{color:#91b4ff;text-decoration:none}
a:hover{opacity:.9}
.container{max-width:980px;margin:0 auto;padding:16px}
h1{font-size:clamp(24px,4.5vw,40px);margin:8px 0 6px}
.route{color:var(--muted);font-weight:600;letter-spacing:.08em;margin-bottom:12px}
/* date row */
.date-row{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(14,22,33,.98),rgba(14,22,33,.85));backdrop-filter: blur(6px);padding:10px 12px;margin:0 -12px 8px;border-bottom:1px solid rgba(255,255,255,.06)}
.date-buttons{display:flex;gap:12px;overflow:auto;padding-bottom:4px}
.date-btn{flex:0 0 auto;display:flex;flex-direction:column;justify-content:center;align-items:center;
  min-width:110px;padding:10px 14px;border-radius:999px;border:2px solid rgba(255,255,255,.15);background:#0f1a2a}
.date-btn.active{border-color:#4f86ff;box-shadow:0 0 0 6px rgba(79,134,255,.12) inset}
.date-btn .d{font-weight:800;font-size:20px;letter-spacing:.04em}
.date-btn .p{font-size:13px;color:var(--muted)}
/* section titles */
.section-title{font-size:18px;margin:16px 0 8px;font-weight:800}
/* map */
.map-wrap{position:relative;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#0b1421}
#map{height:62vh;min-height:420px}
/* layer panel */
.layer-panel{position:absolute;right:12px;top:12px;background:rgba(7,12,20,.88);padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);z-index:10;box-shadow:var(--shadow)}
.layer{display:flex;gap:8px;align-items:center;margin:6px 0}
.layer input{width:18px;height:18px}
/* vertical locate buttons */
.vbtn{position:absolute;right:12px;background:rgba(16,27,42,.95);border:1px solid rgba(255,255,255,.08);
  color:#fff;border-radius:12px;padding:8px 6px;font-weight:800;letter-spacing:.1em;writing-mode:vertical-rl;text-orientation:upright;
  box-shadow:var(--shadow);cursor:pointer;user-select:none}
.vbtn:hover{background:#142338}
#btnLocate{top:120px}
#btnFollow{top:210px}
.vbtn.active{outline:2px solid var(--accent);background:#11243d}
/* photo wall */
.album{min-height:120px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:var(--card);padding:12px}
.grid{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.grid img{width:100%;height:150px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
.empty{color:var(--muted)}
/* timeline */
.timeline{margin-top:12px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow)}
.t-header{display:grid;grid-template-columns:90px 1fr 72px 140px;background:#0c1829;padding:10px 12px;font-weight:800;position:sticky;top:calc(0px + 66px);z-index:15;border-bottom:1px solid rgba(255,255,255,.08)}
.t-row{border-top:1px dashed rgba(255,255,255,.1);padding:12px}
.t-grid{display:grid;grid-template-columns:90px 1fr 72px 140px;gap:8px;align-items:center}
.t-time{white-space:pre-line;font-weight:800}
.t-place .pin{display:inline-block;margin-right:6px}
.t-type{color:var(--muted);font-weight:800}
.mapcode{justify-self:end}
.code-pill{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#2b2b2b,#1f1f1f);border:1px solid rgba(255,255,255,.1);
  border-radius:16px;padding:6px 12px;min-width:120px;justify-content:center}
.code-pill .car{filter:drop-shadow(0 2px 4px rgba(0,0,0,.4))}
.code-pill .num{color:#ffd27c;font-weight:900;letter-spacing:.05em}
.copy{cursor:pointer;font-size:18px;opacity:.8}
.copy:hover{opacity:1}
/* remarks band like your preferred style */
.remark{margin:8px 0 4px;background:#0d1a2c;border-radius:12px;padding:10px 12px;border:1px solid rgba(255,255,255,.06);color:#e6eeff}
.remark b{color:#cfe0ff}
@media (min-width:820px){
  #map{height:60vh}
  .t-header{top:calc(0px + 70px)}
  .date-btn{min-width:140px}
}
</style>
</head>
<body>
<div class="container">
  <h1>2025 æ±äº¬è¿‘éƒŠæ—…éŠ</h1>
  <div class="route">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>

  <div class="date-row" id="dateRow">
    <div class="date-buttons">
      <div class="date-btn active"><div class="d">09/20</div><div class="p">éŒå€‰</div></div>
      <div class="date-btn"><div class="d">09/21</div><div class="p">ç®±æ ¹</div></div>
      <div class="date-btn"><div class="d">09/22</div><div class="p">ç†±æµ·</div></div>
      <div class="date-btn"><div class="d">09/23</div><div class="p">æ²³å£æ¹–</div></div>
    </div>
  </div>

  <div class="section-title">äº’å‹•åœ°åœ–ï¼ˆé»åœ–æ¨™çœ‹è³‡è¨Šï¼é»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</div>
  <div class="map-wrap">
    <div id="map"></div>
    <div class="layer-panel" id="layerPanel">
      <div class="layer"><input type="checkbox" id="layerMain" checked/><label for="layerMain">ä¸»è¡Œç¨‹/ç²¾è¯æˆ–è¿‘ä¼¼</label></div>
      <div class="layer"><input type="checkbox" id="layerOpt" checked/><label for="layerOpt">å¯æœ‰å¯ç„¡</label></div>
      <div class="layer"><input type="checkbox" id="layerToilet" checked/><label for="layerToilet">å»æ‰€</label></div>
    </div>
    <div class="vbtn" id="btnLocate">æˆ‘åœ¨é€™</div>
    <div class="vbtn" id="btnFollow">è·Ÿéš¨æˆ‘</div>
  </div>

  <div class="section-title">ç…§ç‰‡ç‰†ï¼ˆé»ä»»ä¸€æ¨™è¨˜é¡¯ç¤ºç›¸ç°¿ï¼‰</div>
  <div class="album">
    <div id="albumGrid" class="grid"></div>
    <div id="albumEmpty" class="empty">æš«ç„¡ç…§ç‰‡</div>
  </div>

  <div class="section-title">æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</div>
  <div style="color:var(--muted);font-size:12px;margin-bottom:8px">æœ¬é è®€å–ï¼štimeline-2025-09-20_v6.csvã€photos-2025-09-20-mapped.csvã€coords-override-2025-09-20.json</div>

  <div class="timeline" id="timeline">
    <div class="t-header">
      <div>æ™‚é–“</div><div>åœ°é» / æ´»å‹•</div><div>é¡åˆ¥</div><div>è»ŠMap Code</div>
    </div>
    <div id="rows"></div>
  </div>
</div>

<script>
// Minimal robust CSV parser (supports quoted fields and commas inside quotes)
function parseCSV(text){
  const rows=[]; let cur='', row=[], inQ=false;
  text = text.replace(/^\\uFEFF/, ''); // strip BOM
  for (let i=0;i<text.length;i++){
    const c=text[i];
    if (c=='"'){
      if (inQ && text[i+1]=='"'){ cur+='"'; i++; } else { inQ=!inQ; }
    } else if (c==',' && !inQ){
      row.push(cur); cur='';
    } else if ((c=='\\n' || c=='\\r') && !inQ){
      if (cur!=='' || row.length>0){ row.push(cur); rows.push(row); }
      cur=''; row=[];
      if (c=='\\r' && text[i+1]=='\\n') i++; // handle CRLF
    } else {
      cur+=c;
    }
  }
  if (cur!=='' || row.length>0){ row.push(cur); rows.push(row); }
  // header -> objects
  const head = rows.shift().map(h=>h.trim());
  return rows.filter(r=>r.length && r.some(x=>x.trim()!=='')).map(r=>{
    const o={}; head.forEach((h,idx)=>o[h]= (r[idx]??'').trim()); return o;
  });
}
function byId(id){ return document.getElementById(id); }
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function esc(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
function normName(s){ return (s||'').replace(/\\s+/g,'').replace(/[()ï¼ˆï¼‰]/g,'').toLowerCase(); }

// Global data
let coordsMap={}, photosByPlace={}, mainPoints=[], optPoints=[], toiletPoints=[];

// Load files
Promise.all([
  fetch('coords-override-2025-09-20.json').then(r=>r.json()),
  fetch('photos-2025-09-20-mapped.csv').then(r=>r.text()).then(parseCSV),
  fetch('timeline-2025-09-20_v6.csv').then(r=>r.text()).then(parseCSV)
]).then(([coords, photos, timeline])=>{
  coordsMap = coords;
  // group photos
  photos.forEach(p=>{
    const key = normName(p['åœ°é»'] || p['åœ°é»/æ´»å‹•'] || p['name'] || p['place']);
    if (!key) return;
    photosByPlace[key] = photosByPlace[key] || [];
    const src = p['ç…§ç‰‡'] || p['url'] || p['src'] || p['æª”å'] || '';
    if (src) photosByPlace[key].push(src);
  });

  renderMapAndTimeline(timeline);
}).catch(err=>{
  console.error(err);
  alert('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªä¸‰å€‹æª”æ¡ˆèˆ‡æœ¬é åŒè³‡æ–™å¤¾ã€‚');
});

// Leaflet
let map, mainLayer, optLayer, toiletLayer, routeLine, locateMarker, follow=false;

function renderMapAndTimeline(timeline){
  // Prepare points
  function getCoord(name){
    const arr = coordsMap[name];
    if (Array.isArray(arr) && arr.length===2) return {lat:parseFloat(arr[0]), lng:parseFloat(arr[1])};
    return null;
  }

  mainPoints=[]; optPoints=[]; toiletPoints=[];
  timeline.forEach(row=>{
    const name = row['åœ°é»'] || row['åœ°é»/æ´»å‹•'] || '';
    const type = (row['é¡åˆ¥'] || '').trim();
    const coord = getCoord(name);
    if (!coord) return;
    const item={ name, coord, row };
    if (type==='å¯æœ‰å¯ç„¡'){ optPoints.push(item); }
    else if (type==='å»æ‰€'){ toiletPoints.push(item); }
    else { mainPoints.push(item); }
  });

  // Init map
  map = L.map('map', { zoomControl:false, attributionControl:true });
  L.control.zoom({ position:'topleft' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, crossOrigin:true
  }).addTo(map);

  const iconMain = L.icon({ iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconAnchor:[12,41], popupAnchor:[0,-34] });
  function addMarkers(arr, group, color='#2f7ef7'){
    arr.forEach(({name,coord,row})=>{
      const m=L.marker([coord.lat,coord.lng],{icon:iconMain});
      m.bindPopup(renderPopup(name,row), {autoPan:true,maxWidth:320});
      m.on('click',()=>showAlbum(name));
      group.addLayer(m);
    });
  }
  mainLayer = L.layerGroup().addTo(map);
  optLayer = L.layerGroup().addTo(map);
  toiletLayer = L.layerGroup().addTo(map);
  addMarkers(mainPoints, mainLayer);
  addMarkers(optPoints, optLayer);
  addMarkers(toiletPoints, toiletLayer);

  // Route polyline for main only
  const routeCoords = mainPoints.map(p=>[p.coord.lat,p.coord.lng]);
  if (routeLine) routeLine.remove();
  if (routeCoords.length>1){
    routeLine = L.polyline(routeCoords, {color:'#4aa3ff',weight:4,opacity:.7}).addTo(map);
  }
  // Fit bounds
  const allPts = [...mainPoints,...optPoints,...toiletPoints];
  if (allPts.length){
    const b = L.latLngBounds(allPts.map(p=>[p.coord.lat,p.coord.lng]));
    map.fitBounds(b.pad(0.2));
  } else {
    map.setView([35.325,139.55], 12);
  }

  // Layer toggles
  byId('layerMain').onchange=()=>{ if(byId('layerMain').checked) map.addLayer(mainLayer); else map.removeLayer(mainLayer); toggleRoute(); };
  byId('layerOpt').onchange=()=>{ if(byId('layerOpt').checked) map.addLayer(optLayer); else map.removeLayer(optLayer); };
  byId('layerToilet').onchange=()=>{ if(byId('layerToilet').checked) map.addLayer(toiletLayer); else map.removeLayer(toiletLayer); };
  function toggleRoute(){
    if (!routeLine) return;
    const on = byId('layerMain').checked;
    if (on && !map.hasLayer(routeLine)) routeLine.addTo(map);
    if (!on && map.hasLayer(routeLine)) map.removeLayer(routeLine);
  }

  // Locate + follow
  byId('btnLocate').onclick=()=>{
    if (!navigator.geolocation){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude}=pos.coords;
      if (!locateMarker){
        locateMarker = L.marker([latitude,longitude],{ title:'æˆ‘åœ¨é€™' }).addTo(map);
      } else {
        locateMarker.setLatLng([latitude,longitude]);
      }
      map.panTo([latitude,longitude]);
    },()=>alert('å®šä½å¤±æ•—'));
  };
  byId('btnFollow').onclick=()=>{
    follow = !follow;
    byId('btnFollow').classList.toggle('active', follow);
    if (!navigator.geolocation){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½'); return; }
    if (follow){
      watchId = navigator.geolocation.watchPosition(pos=>{
        const p=[pos.coords.latitude,pos.coords.longitude];
        if (!locateMarker) locateMarker = L.marker(p,{title:'æˆ‘åœ¨é€™'}).addTo(map);
        locateMarker.setLatLng(p);
        map.panTo(p);
      });
    } else {
      if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    }
  };

  // Timeline
  renderTimeline([...mainPoints, ...optPoints, ...toiletPoints], timeline);
}

// Popup renderer
function renderPopup(name,row){
  const mapcode = (row['è»ŠMap Code'] || row['è»ŠMapCode'] || row['Map Code'] || '').trim();
  const notes = (row['å‚™è¨»'] || '').trim();
  const g = (row['Google åœ°åœ–'] || row['Googleåœ°åœ–'] || row['åœ°åœ–'] || '').trim();
  const codeHtml = mapcode ? `<div class="code-pill"><span class="car">ğŸš—</span><span class="num">${esc(mapcode)}</span><span class="copy" title="è¤‡è£½" onclick="copyText('${esc(mapcode)}')">ğŸ“‹</span></div>` : '';
  const link = g ? `<a href="${g}" target="_blank">ğŸ“ Google åœ°åœ–</a>` : '';
  return `<div style="min-width:240px">
    <div style="font-weight:900;font-size:18px;margin-bottom:6px">${esc(name)}</div>
    ${codeHtml}
    ${notes ? `<div style="color:#c8d8f7;margin-top:8px">${esc(notes)}</div>`:''}
    <div style="margin-top:8px">${link}</div>
  </div>`;
}
function copyText(t){ navigator.clipboard?.writeText(t); }

// Album
function showAlbum(place){
  const key = normName(place);
  const list = photosByPlace[key] || [];
  const grid = byId('albumGrid'), empty=byId('albumEmpty');
  grid.innerHTML='';
  if (!list.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  list.slice(0,20).forEach(src=>{
    // allow relative paths from assets/img or absolute URLs
    const url = src.match(/^https?:/)? src : ('assets/img/'+src.replace(/^\\/?/,'').replace(/^assets\\/img\\//,''));
    const img = document.createElement('img'); img.loading='lazy'; img.src=url; grid.appendChild(img);
  });
}

// Timeline builder
function renderTimeline(points, timelineRows){
  // build dictionary by place name to row(s)
  const byName = {};
  timelineRows.forEach(r=>{
    const n = (r['åœ°é»'] || r['åœ°é»/æ´»å‹•'] || '').trim();
    if (!n) return;
    (byName[n] = byName[n] || []).push(r);
  });

  const rowsEl = byId('rows'); rowsEl.innerHTML='';
  // keep original order from csv
  const ordered = timelineRows.filter(r=> (r['åœ°é»']||r['åœ°é»/æ´»å‹•']||'').trim());
  ordered.forEach(r=>{
    const name = (r['åœ°é»'] || r['åœ°é»/æ´»å‹•']).trim();
    const type = (r['é¡åˆ¥']||'').trim();
    const code = (r['è»ŠMap Code'] || r['è»ŠMapCode'] || '').trim();
    const note = (r['å‚™è¨»']||'').trim();
    const timeStr = ((r['æ™‚é–“']||'').replace(/\\s+/g,'').replace(/-/,'-') || '').split('-');
    const tDisplay = timeStr.length===2 ? (timeStr[0]+ '\\n' + timeStr[1]) : (r['æ™‚é–“']||'').replace('-', '\\n');

    const google = (r['Google åœ°åœ–'] || r['Googleåœ°åœ–'] || r['åœ°åœ–'] || '').trim();
    const row = document.createElement('div');
    row.className='t-row';
    row.innerHTML = `
      <div class="t-grid">
        <div class="t-time">${esc(tDisplay)}</div>
        <div class="t-place"><span class="pin">ğŸ“</span><a href="${google||'#'}" target="_blank">${esc(name)}</a></div>
        <div class="t-type">${esc(type||'')}</div>
        <div class="mapcode">${code?`<div class="code-pill"><span class="car">ğŸš—</span><span class="num">${esc(code)}</span><span class="copy" title="è¤‡è£½" onclick="copyText('${esc(code)}')">ğŸ“‹</span></div>`:''}</div>
      </div>
      ${note?`<div class="remark"><b>å‚™è¨»ï¼š</b>${esc(note)}</div>`:''}
    `;
    rowsEl.appendChild(row);
  });
}

// Adjust sticky header offset to sit below date row
function updateStickyTop(){
  const dr = byId('dateRow');
  const top = dr.getBoundingClientRect().height;
  document.querySelectorAll('.t-header').forEach(h=> h.style.top = top+'px');
}
window.addEventListener('load', updateStickyTop);
window.addEventListener('resize', updateStickyTop);
</script>
</body>
</html>
