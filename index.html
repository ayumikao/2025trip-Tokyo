<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>2025 è¿‘éƒŠæ—…éŠï½œ9/20 éŒå€‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#60a5fa;
      --route:#0891b2;
      --chip:#1f2937;
      --chip-border:#3f3f46;
      --popup-text:#111827; /* ç™½è‰² popup ä¸Šçš„æ·±è‰²å­— */
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px 40px;}
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.92));
      padding: env(safe-area-inset-top) 10px 8px;
      border-bottom: 1px solid rgba(148,163,184,.16);
    }
    .title{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title h1{font-size:18px;margin:6px 0}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #263045;color:#dbeafe;cursor:pointer}
    .tab.active{background:#143158;border-color:#2f7bf6}
    .gh{margin-left:auto;font-size:12px;padding:6px 10px;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media(min-width:820px){ .grid{grid-template-columns:minmax(360px, 48%) 1fr;align-items:start}}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.16);border-radius:12px;overflow:hidden}
    .mapHead{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.16)}
    .mapHead .btn{padding:6px 10px;border:1px solid #334155;border-radius:8px;background:#0b1220;color:#cbd5e1;cursor:pointer}
    #map{height:60vh}
    .full #map{height:86vh}
    .hint{font-size:12px;color:var(--muted);padding:8px 10px}
    .photos{padding:8px}
    .photos h3{margin:4px 0 8px 4px;font-size:14px;color:#cbd5e1}
    .gallery{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(min-width:820px){ .gallery{grid-template-columns:1fr 1fr} }
    .gallery img{width:100%;height:160px;object-fit:cover;border-radius:10px;border:1px solid rgba(148,163,184,.16);cursor:pointer;background:#0b1220}
    .timeline{padding:8px 10px}
    details{background:#0b1220;border:1px solid rgba(148,163,184,.16);border-radius:10px;padding:8px 10px}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    table{width:100%;border-collapse:collapse;margin-top:6px;font-size:14px}
    th,td{border-top:1px dashed rgba(148,163,184,.2);padding:8px 6px;vertical-align:top}
    th{color:#cbd5e1;text-align:left;font-weight:600}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--chip-border);background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;color:#e5e7eb}
    .tag{display:inline-block;border:1px solid #334155;border-radius:6px;padding:1px 6px;font-size:12px;color:#cbd5e1}
    .code{display:inline-block;border:1px solid #475569;border-radius:999px;padding:2px 8px;font-size:12px;color:#0f172a;background:#f3f4f6}
    .copyBtn{border:1px solid #475569;border-radius:6px;background:#0b1220;color:#e2e8f0;padding:1px 6px;font-size:12px;cursor:pointer}
    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:1000}
    .lightbox.show{display:flex}
    .lightbox img{max-width:92vw;max-height:92vh;border-radius:10px}
    .navBtn{position:fixed;top:50%;transform:translateY(-50%);font-size:26px;color:#fff;background:rgba(0,0,0,.35);border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
    .navPrev{left:14px}.navNext{right:14px}
    /* Leaflet popup ä¸­çš„å­—æ”¹æ·±è‰²ï¼Œå°ç™½åº•æœ‰å°æ¯” */
    .leaflet-popup-content{color:var(--popup-text);}
    .leaflet-popup-content a{color:#2563eb}
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1>2025 è¿‘éƒŠæ—…éŠ ï½œ æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</h1>
      <a class="gh" href="#" onclick="location.reload()">é‡æ–°æ•´ç†</a>
      <div class="tabs">
        <div class="tab active">9/20 éŒå€‰</div>
        <div class="tab">9/21</div>
        <div class="tab">9/22</div>
        <div class="tab">9/23</div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="mapHead">
          <button class="btn" id="fullBtn">å…¨è¢å¹•åœ°åœ–</button>
          <span class="hint">æç¤ºï¼šé»åœ°åœ–ä¸Šçš„æ™¯é»ï¼Œå³å´æœƒé¡¯ç¤ºå°æ‡‰ç…§ç‰‡ï¼›ä¸‹æ–¹å¯å±•é–‹æ™‚é–“è»¸ã€‚</span>
        </div>
        <div id="map"></div>
      </section>

      <aside class="card">
        <div class="photos">
          <h3 id="phTitle">ç…§ç‰‡ç‰†</h3>
          <div id="gallery" class="gallery"></div>
        </div>
        <div class="timeline">
          <details open>
            <summary>å±•é–‹ / æ”¶åˆã€€<span class="tag">è³‡æ–™ä¾†æºï¼štimeline-2025-09-20_v6.csv</span></summary>
            <table id="tbl">
              <thead><tr><th>æ™‚é–“</th><th>åœ°é» / æ´»å‹•</th><th>å‚™è¨»</th><th>é¡åˆ¥</th><th>è»ŠMap<br/>Code</th></tr></thead>
              <tbody></tbody>
            </table>
          </details>
        </div>
      </aside>
    </div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" tabindex="-1">
    <button class="navBtn navPrev" id="prevBtn">â€¹</button>
    <img id="lbImg" alt=""/>
    <button class="navBtn navNext" id="nextBtn">â€º</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const MAP_CSV = 'timeline-2025-09-20_v6.csv';
    const PHOTO_CSV = 'photos-2025-09-20-mapped.csv';
    const COORDS_JSON = 'coords-override-2025-09-20.json';

    // è‹¥åº§æ¨™è¦†å¯«æ²’æœ‰ï¼Œé€™è£¡æ”¾å®‰å…¨çš„é è¨­é»ï¼ˆä½ å¯æ”¹æˆé£¯åº—æˆ–é›†åˆé»ï¼‰
    const DEFAULT_COORDS = {
      'æ¾€è°·å‡ºç™¼ï¼ˆåŒ…è»Šï¼‰':[35.659, 139.700] // Shibuya Station å‘¨é‚Šï¼ˆå¯è‡ªè¡Œå¾®èª¿ï¼‰
    };

    const map = L.map('map', { zoomControl:true, scrollWheelZoom:true }).setView([35.319, 139.53], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    // åœ–å±¤
    const layerMain     = L.layerGroup().addTo(map);
    const layerOptional = L.layerGroup().addTo(map);
    const layerToilet   = L.layerGroup().addTo(map);
    const layerRoute    = L.layerGroup().addTo(map);
    L.control.layers(null, {
      "ä¸»è¡Œç¨‹/ç²¾è¯æˆ–è¿‘ä¼¼":layerMain,
      "å¯æœ‰å¯ç„¡":layerOptional,
      "å»æ‰€":layerToilet
    }, {collapsed:false}).addTo(map);

    // åœ–ç¤º
    const iconMain = L.icon({ iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34] });
    const iconOpt  = L.divIcon({ className:'', html:"<div style='width:20px;height:20px;border-radius:50%;background:#7c3aed;border:2px solid white;box-shadow:0 0 0 1px #4c1d95'></div>", iconSize:[20,20], iconAnchor:[10,10] });
    const iconWC   = L.divIcon({ className:'', html:"<div style='width:20px;height:20px;border-radius:50%;background:#0ea5e9;border:2px solid white;box-shadow:0 0 0 1px #0369a1'></div>", iconSize:[20,20], iconAnchor:[10,10] });

    // Lightbox
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImg');
    let lbList = []; let lbIndex = 0;
    function openLB(list, idx){
      lbList = list; lbIndex = idx; lbImg.src = lbList[lbIndex]; lb.classList.add('show'); lb.focus();
    }
    function closeLB(){ lb.classList.remove('show'); lbImg.src=''; }
    function navLB(d){ if(!lbList.length) return; lbIndex=(lbIndex+d+lbList.length)%lbList.length; lbImg.src=lbList[lbIndex]; }
    lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLB() });
    document.getElementById('prevBtn').onclick=()=>navLB(-1);
    document.getElementById('nextBtn').onclick=()=>navLB(1);
    window.addEventListener('keydown', e=>{
      if(!lb.classList.contains('show')) return;
      if(e.key==='Escape') closeLB();
      if(e.key==='ArrowLeft') navLB(-1);
      if(e.key==='ArrowRight') navLB(1);
    });

    // åœ°åœ–é«˜åº¦åˆ‡æ›
    document.getElementById('fullBtn').onclick=()=>{
      document.querySelector('.card').classList.toggle('full');
      map.invalidateSize();
    };

    // å·¥å…·
    function isOptional(row){
      const a=(row['å‚™è¨»']||''), b=(row['åœ°é» / æ´»å‹•']||'');
      return /å¯æœ‰å¯ç„¡/.test(a) || /å¯æœ‰å¯ç„¡/.test(b);
    }
    function isToilet(row){ return (row['ğŸš» å»æ‰€']||'').trim()!==''; }

    // ç›¡å¯èƒ½å¾ Google Maps é€£çµä¸­æŠ“å‡ºåº§æ¨™ï¼ˆæœ‰ query=lat,lng æˆ– @lat,lng æˆ– !3dLAT!4dLNGï¼‰
    function coordsFromLink(link){
      if(!link) return null;
      try{
        const u = decodeURIComponent(link);
        // query=35.332861,139.518890
        let m = u.match(/query=([+-]?\d+\.\d+)[,\s%2C]+([+-]?\d+\.\d+)/i);
        if(m) return [parseFloat(m[1]), parseFloat(m[2])];
        // @35.332861,139.518890
        m = u.match(/@([+-]?\d+\.\d+),([+-]?\d+\.\d+)/);
        if(m) return [parseFloat(m[1]), parseFloat(m[2])];
        // !3d35.332861!4d139.518890
        m = u.match(/!3d([+-]?\d+\.\d+)!4d([+-]?\d+\.\d+)/);
        if(m) return [parseFloat(m[1]), parseFloat(m[2])];
      }catch(e){}
      return null;
    }

    function buildPopup(row, latlng){
      const name = row['åœ°é» / æ´»å‹•']||'';
      const link = row['ğŸ“ æ™¯é»é€£çµ']? `<a href="${row['ğŸ“ æ™¯é»é€£çµ']}" target="_blank">ğŸ“ Google åœ°åœ–</a>`:'';
      const wc   = row['ğŸš» å»æ‰€']? `<span class="chip" style="background:#0b3850;border-color:#0ea5e9">ğŸš» ${row['ğŸš» å»æ‰€']}</span>`:'';
      const code = row['ğŸš™è»ŠMap Code']? `<span class="code">${row['ğŸš™è»ŠMap Code']}</span> <button class="copyBtn" onclick="navigator.clipboard.writeText('${(row['ğŸš™è»ŠMap Code']||'').replace(/'/g,'')}');event.stopPropagation()">è¤‡è£½</button>`:'';
      const note = row['å‚™è¨»']? `<div style="margin-top:6px;color:#374151">${row['å‚™è¨»']}</div>`:'';
      return `<div style="min-width:240px">
        <div style="font-weight:700;margin-bottom:4px;color:#0f172a">${name}</div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:4px 0">${code}${wc}</div>
        ${note}
        <div style="margin-top:6px">${link}</div>
      </div>`;
    }

    // è®€ä¸‰å€‹è³‡æ–™ï¼šåº§æ¨™è¦†å¯«ã€è¡Œç¨‹ CSVã€ç…§ç‰‡å°æ‡‰ CSV
    let coordMap = {};
    let photoMap = {}; // name -> [img,...]
    let routePts = [];
    const bounds = [];

    Promise.all([
      fetch(COORDS_JSON).then(r=>r.ok?r.json():{}).catch(_=>({})),
      fetch(PHOTO_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true,skipEmptyLines:true}).data).catch(_=>[]),
      fetch(MAP_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true,skipEmptyLines:true}).data)
    ]).then(([coordJson, photoRows, planRows])=>{
      coordMap = Object.assign({}, DEFAULT_COORDS, coordJson||{});
      // ç…§ç‰‡å°æ‡‰
      photoRows.forEach(r=>{
        const n=(r['å°æ‡‰åœ°é»']||'').trim(); const p=(r['image']||'').trim();
        if(!n||!p) return;
        if(!photoMap[n]) photoMap[n]=[];
        photoMap[n].push(p);
      });

      // å»ºç«‹é»ä½ & æ™‚é–“è»¸
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML='';
      planRows.forEach(row=>{
        const name = (row['åœ°é» / æ´»å‹•']||'').trim();
        const type = (row['é¡åˆ¥']||'').trim();
        const time = `${row['æ™‚é–“èµ·']||''}-${row['æ™‚é–“è¿„']||''}`.replace(/-$/,'');

        // æ™‚é–“è»¸åˆ—
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${time}</td>
          <td>${name?('ğŸ“ '+name):''}${row['ğŸ“ æ™¯é»é€£çµ']?`<div><a href="${row['ğŸ“ æ™¯é»é€£çµ']}" target="_blank">Google åœ°åœ–</a></div>`:''}</td>
          <td>${row['å‚™è¨»']||''}</td>
          <td>${type||''}</td>
          <td>${(row['ğŸš™è»ŠMap Code']||'').trim()?`<span class="code">${row['ğŸš™è»ŠMap Code']}</span>`:''}</td>`;
        tbody.appendChild(tr);

        if(!name) return;

        // å–å¾—åº§æ¨™ï¼šå„ªå…ˆç”¨ coords-overrideï¼Œå¦å‰‡å˜—è©¦å¾é€£çµè§£æï¼Œå†å¦å‰‡ç”¨ DEFAULT_COORDS
        let c = coordMap[name];
        if((!c || !Array.isArray(c) || c.length<2) && row['ğŸ“ æ™¯é»é€£çµ']){
          const parsed = coordsFromLink(row['ğŸ“ æ™¯é»é€£çµ']);
          if(parsed) c = parsed;
        }
        if((!c || !Array.isArray(c) || c.length<2) && DEFAULT_COORDS[name]){
          c = DEFAULT_COORDS[name];
        }
        if(!c || !Array.isArray(c) || c.length<2) return;

        const lat = +c[0], lng = +c[1];
        const latlng=[lat,lng];
        bounds.push(latlng);

        // åœ–å±¤åˆ¤æ–·
        const optional = isOptional(row);
        const toilet   = isToilet(row);
        const layer = toilet ? layerToilet : (optional ? layerOptional : layerMain);
        const icon  = toilet ? iconWC     : (optional ? iconOpt     : iconMain);

        const mk = L.marker(latlng,{icon}).bindPopup(buildPopup(row, latlng)).addTo(layer);
        mk.on('click', ()=>{
          // ç…§ç‰‡ç‰†
          const list = (photoMap[name]||[]).slice();
          document.getElementById('phTitle').textContent = name + ' çš„ç›¸ç‰‡ï¼š';
          const gal = document.getElementById('gallery');
          gal.innerHTML = '';
          list.forEach((src, idx)=>{
            const img = document.createElement('img');
            img.loading='lazy'; img.src = src;
            img.onclick=()=>openLB(list, idx);
            gal.appendChild(img);
          });
        });

        // ä¸»è¡Œç¨‹è·¯ç·šï¼šåŒ…å«æ‰€æœ‰ã€Œéå¯æœ‰å¯ç„¡ã€ä¸”æœ‰åº§æ¨™çš„é»ï¼ˆåŒ…å«åŒ…è»Šèµ·é»ï¼‰
        if(!optional){
          routePts.push(latlng);
        }
      });

      if(bounds.length) map.fitBounds(bounds, {padding:[20,20]});
      if(routePts.length>=2){
        L.polyline(routePts,{color: getComputedStyle(document.documentElement).getPropertyValue('--route')||'#0891b2', weight:4, opacity:.95}).addTo(layerRoute);
      }
    }).catch(err=>{
      console.error(err);
      alert('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ CSV / JSON æ˜¯å¦å­˜åœ¨ã€‚');
    });
  </script>
</body>
</html>
