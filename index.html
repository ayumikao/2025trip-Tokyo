<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2025 æ±äº¬è¿‘éƒŠæ—…éŠ | 9/20 éŒå€‰</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0f1720; --panel:#121a24; --panel-2:#0c131b; --text:#e8f0ff; --muted:#9bb3cf;
  --accent:#2b6fff; --accent-2:#173867; --chip:#1a2430; --chip-border:#2a3a4d;
  --pill:#232a35; --pill-border:#2d3a49; --yellow:#ffd24a; --card-shadow:0 8px 24px rgba(0,0,0,.35); --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 600px at 50% -250px, #1a2740 0%, var(--bg) 60%);
  color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
.container{max-width:980px;margin:0 auto;padding:20px 16px 64px}
header h1{font-size:34px;letter-spacing:.08em;margin:0 0 6px}
.breadcrumb{
  color:var(--muted); font-size:16px; letter-spacing:.2em; margin-bottom:14px; white-space:nowrap; text-align:center; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
}
.breadcrumb::-webkit-scrollbar{display:none}
.date-row{
  display:flex; align-items:center; justify-content:center; flex-wrap:nowrap; gap:8px; margin-bottom:12px;
  position:sticky; top:0; z-index:20; padding:8px 0 10px;
  background:linear-gradient(180deg, rgba(15,23,32,.96) 60%, rgba(15,23,32,0)); backdrop-filter:saturate(140%) blur(2px);
}
.date-row::-webkit-scrollbar{display:none}
.date-btn{
  border-radius:20px; border:2px solid var(--accent-2);
  background:linear-gradient(180deg,#141d29,#0e1621);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 2px 6px rgba(0,0,0,.25);
  color:var(--text); padding:6px 9px; min-width:80px; display:flex; flex-direction:column; align-items:center; gap:4px; text-decoration:none;
}
.date-btn .d{font-size:16px;font-weight:700;letter-spacing:.05em}
.date-btn .l{font-size:12px;color:#b9c7db;letter-spacing:.15em}
.date-btn.active{border-color:#3d65ff; outline:3px solid rgba(61,101,255,.35); background:linear-gradient(180deg,#122645,#0f1d33)}
@media (max-width:520px){ .date-btn{min-width:80px;padding:6px 10px} .date-btn .d{font-size:14px} .date-btn .l{font-size:12px} #map{height:380px} }

.card{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:12px;margin:0 0 18px}
#map{height:430px;border-radius:14px;overflow:hidden}
.leaflet-container{background:#0b131c}

/* åœ–å±¤å¡ç‰‡ */
.map-overlay{position:absolute; top:12px; right:12px; z-index:450;}
.layers-card{
  background:rgba(12,19,27,0.5); border-radius:14px; padding:4px 6px; min-width:90px;
  box-shadow:0 10px 26px rgba(0,0,0,.45);
}
.layers-card label{display:flex; align-items:center; gap:6px; margin:2px 0; line-height:1.2; color:#d7e4ff; font-size:14px}
.layers-card input{width:16px;height:16px}

/* å‚ç›´æŒ‰éˆ• */
.vbtns{position:absolute; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:450}
.vbtn{background:rgba(13,20,28,0.5); color:var(--text); border-radius:12px; padding:10px 8px; line-height:1.2; writing-mode:vertical-rl; text-orientation:mixed; letter-spacing:.3em; cursor:pointer}
.vbtn:active{transform:translateY(1px)}
@supports (padding: max(0px)) { .vbtns{bottom:max(12px, env(safe-area-inset-bottom)); right:max(12px, env(safe-area-inset-right));} }

/* ç…§ç‰‡ç‰†ç¸®åœ–ï¼ˆç¸®å°ç‰ˆï¼‰ */
.photo-wall{background:var(--panel);border:1px solid #1f2b3a;border-radius:var(--radius);min-height:120px;padding:16px;margin-bottom:18px}
.photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
.photos img{width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid #233246;cursor:pointer}
.empty{color:#9cb1c9}

/* è¡¨æ ¼ */
.table{width:100%;border-collapse:separate;border-spacing:0 12px}
.th-row th{color:#d7e6ff;text-align:left;font-weight:800;letter-spacing:.25em;padding:8px 12px}
.tr{background:var(--panel);border:1px solid #1f2b3a;border-radius:14px;box-shadow:var(--card-shadow)}
.td{padding:14px 14px;vertical-align:top}
.time{font-size:22px;font-weight:700;letter-spacing:.15em;white-space:pre-line}
.place{font-size:20px;font-weight:700;letter-spacing:.03em}
.note{margin-top:8px;color:#c9d8ef}
.cat{font-size:20px;font-weight:800;letter-spacing:.4em}
.mapcode{
  display:inline-flex; align-items:center; gap:10px;
  padding:12px 16px; border-radius:22px;
  background: rgba(0,0,0,0.30); /* é»‘è‰²åŠé€æ˜ */
  /* border:1px solid #d0d8e0;  æƒ³è¦é‚Šæ¡†å°±æ‰“é–‹ */
}
.mapcode .car{font-size:20px}
.mapcode .code{color:#ffd24a;font-weight:800;font-size:20px;letter-spacing:.05em}
.mapcode .copy{background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.28); color:#fff; font-size:12px; padding:4px 8px; border-radius:10px; cursor:pointer}
.badge{display:inline-block;margin-top:6px;color:#8fb6ff}
a, a:visited{color:#2ea0ff}
.map-wrap{position:relative}
.leaflet-top.leaflet-left{top:12px;left:12px}
.leaflet-control-zoom a:hover{border-radius:10px;background:rgba(14,23,34,0.8);color:#fff;border:1px solid #203146}
.leaflet-top.leaflet-left{top:1px;left:1px}
.card.map-wrap{border:none}

/* Lightboxï¼ˆå¤§åœ–ï¼‰ */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
#lightbox img{max-width:90%;max-height:80%;border-radius:12px;box-shadow:0 18px 60px rgba(0,0,0,0.6)}
#lightbox .controls{margin-top:12px;display:flex;gap:14px}
#lightbox button{background:rgba(255,255,255,0.16);border:1px solid rgba(255,255,255,0.22);padding:8px 14px;font-size:16px;color:#fff;border-radius:10px;cursor:pointer}
#lightbox button:hover{background:rgba(255,255,255,0.28)}

/* Popupï¼šç™½è‰² 0.72 + æ·±è‰²å­— */
.leaflet-popup-content-wrapper{
  background: rgba(255,255,255,0.72) !important;
  border: 1px solid #d0d8e0;
  border-radius: 14px;
  box-shadow: 0 16px 40px rgba(0,0,0,.25);
}
.leaflet-popup-tip{
  background: rgba(255,255,255,0.72) !important;
  border: 1px solid #d0d8e0;
}
.leaflet-popup-content{ margin:8px 10px; color:#25324a; line-height:1.6; }
.popup-title{font-weight:800;font-size:18px;color:#0b1220;margin:0 0 6px}
.popup-note{margin-top:6px;color:#42526e}
.popup-link{margin-top:6px}
.popup-link a{color:#2b6fff;text-decoration:underline}

/* æ‰‹æ©Ÿï¼šåªç¸®å°æ¡†èˆ‡ chipï¼Œå­—é«”ä¸è®Š */
@media (max-width:520px){
  .photos{grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:6px}
  .photos img{height:65px}
  .leaflet-popup-content-wrapper{padding:6px;border-radius:10px}
  .leaflet-popup-content{margin:6px 8px}
  .mapcode{padding:6px 10px;border-radius:12px}
  .mapcode .code,.mapcode .car{font-size:18px}
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1 style="text-align:center;">2025 æ±äº¬è¿‘éƒŠæ—…éŠ</h1>
      <div class="breadcrumb">æ¾€è°· â†’ éŒå€‰ â†’ ç®±æ ¹ â†’ ç†±æµ· â†’ ä¼Šè±†åŠå³¶</div>
      <div class="date-row" id="dateRow">
        <a class="date-btn active" href="#"><span class="d">09/20</span><span class="l">éŒå€‰</span></a>
        <a class="date-btn" href="#"><span class="d">09/21</span><span class="l">ç®±æ ¹</span></a>
        <a class="date-btn" href="#"><span class="d">09/22</span><span class="l">ç†±æµ·</span></a>
        <a class="date-btn" href="#"><span class="d">09/23</span><span class="l">ä¼Šè±†åŠå³¶</span></a>
      </div>
    </header>

    <div class="card map-wrap">
      <div id="map"></div>
      <div class="map-overlay">
        <div class="layers-card" id="layersCard">
          <label><input type="checkbox" id="layer-main" checked> ä¸»è¡Œç¨‹</label>
          <label><input type="checkbox" id="layer-optional" checked> å¯æœ‰å¯ç„¡</label>
          <label><input type="checkbox" id="layer-restroom" checked> å»æ‰€</label>
        </div>
      </div>
      <div class="vbtns">
        <button id="btnHere" class="vbtn">æˆ‘åœ¨é€™</button>
        <button id="btnFollow" class="vbtn">è·Ÿéš¨æˆ‘</button>
      </div>
    </div>

    <div>
      <div class="section-title">ç…§ç‰‡ç‰†ï¼ˆé»åœ°åœ–æˆ–æ™‚é–“è»¸åœ°é» â†’ çœ‹ç¸®åœ–ï¼›é»ç¸®åœ– â†’ å¤§åœ–å¯å·¦å³æ»‘ï¼‰</div>
      <div class="photo-wall">
        <div id="photos" class="photos"></div>
        <div id="emptyPhotos" class="empty">æš«ç„¡ç…§ç‰‡</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">æ™‚é–“è»¸ï¼ˆ9/20 +15 åˆ†é˜ç·©è¡ç‰ˆï¼‰</div>
      <div class="badge" id="srcInfo"></div>
      <table class="table" id="timelineTable">
        <thead class="th-row">
          <tr>
            <th style="width:110px">æ™‚é–“</th>
            <th>åœ°é» / æ´»å‹•</th>
            <th style="width:72px">é¡åˆ¥</th>
            <th style="width:220px">è»ŠMap Code</th>
          </tr>
        </thead>
        <tbody id="timelineBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Lightboxï¼ˆå¤§åœ–æª¢è¦–ï¼‰ -->
  <div id="lightbox" aria-hidden="true">
    <img id="lightbox-img" src="" alt="photo view">
    <div class="controls">
      <button id="prev" type="button">â† ä¸Šä¸€å¼µ</button>
      <button id="next" type="button">ä¸‹ä¸€å¼µ â†’</button>
      <button id="close" type="button">âœ• é—œé–‰</button>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- Utilities ----------------
function parseCSV(text){
  const out=[]; let row=[]; let cur='', inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){cur+='"'; i++; continue;}
      if(c==='"'){inQ=false; continue;}
      cur+=c; continue;
    }else{
      if(c==='"'){inQ=true; continue;}
      if(c===','){row.push(cur); cur=''; continue;}
      if(c==='\n'){row.push(cur); out.push(row); row=[]; cur=''; continue;}
      if(c==='\r'){continue;}
      cur+=c; continue;
    }
  }
  if(cur.length||row.length){row.push(cur); out.push(row);}
  const header=(out.shift()||[]).map(s=>s.trim().replace(/^\ufeff/,'')); // å» BOM
  return out.filter(r=>r.some(x=>x&&x.trim()!=='')).map(r=>{
    const obj={}; header.forEach((h,idx)=>obj[h]=(r[idx]??'').trim()); return obj;
  });
}
function byKeys(obj,keys){ for(const k of keys){ if(k in obj && obj[k]!=='' ) return obj[k]; } return ''; }
function norm(s){ return String(s||'').toLowerCase().replace(/\s|ã€€/g,''); }
function toTimeBlock(s,e){ const fmt=t=>(t||'').replace(':','ï¼š'); return fmt(s)+'\n'+fmt(e); }
function el(tag,cls,html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }

// å¾ Google åœ°åœ–é€£çµæŠ½ç·¯ç¶“
function extractLatLngFromLink(link){
  if(!link) return null;
  try{
    const dec = decodeURIComponent(link);
    let m = dec.match(/query=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    m = dec.match(/<\s*([-0-9.]+)\s*>\s*,\s*<\s*([-0-9.]+)\s*>/i);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    m = dec.match(/@\s*([-0-9.]+)\s*,\s*([-0-9.]+)/i);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
  }catch(e){}
  return null;
}

// ======= Column åˆ¥å =======
const COL = {
  start:  ['start','é–‹å§‹','start_time','é–‹å§‹æ™‚é–“','æ™‚é–“èµ·'],
  end:    ['end','çµæŸ','end_time','çµæŸæ™‚é–“','æ™‚é–“è¿„'],
  title:  ['åœ°é» / æ´»å‹•','åœ°é»','æ´»å‹•','åç¨±','place','title'],
  note:   ['å‚™è¨»','å‚™è¨»èªªæ˜','note','desc','èªªæ˜'],
  category: ['é¡åˆ¥','åˆ†é¡','category','cat'],
  mapcode:  ['mapcode','Map Code','MapCode','MAPCODE','è»ŠMap Code','Map Code (Car)','ğŸš™è»ŠMap Code'],
  lat:    ['lat','ç·¯åº¦'],
  lng:    ['lng','ç¶“åº¦'],
  link:   ['google','gmap','map','link','Google åœ°åœ–','GoogleMap','ğŸ“ æ™¯é»é€£çµ'],
  seq:    ['é †åº','order','seq','åº'],
  restroomCol: ['ğŸš» å»æ‰€','å»æ‰€']
};
function get(r, key){
  const keys = COL[key] || [];
  for(const k of keys){ if(k in r && r[k] !== '') return (r[k]||'').trim(); }
  return '';
}

/* é—œéµå­—ï¼ˆçœ‹å‚™è¨»ã€é¡åˆ¥å…©æ¬„ï¼‰ */
const OPTIONAL_RE = /(å¯æœ‰å¯ç„¡|å¯é¸|é›¨å‚™|å‚™æ´|optional|option|opt)/i;
const RESTROOM_RE = /(ğŸš»|å»|å…¬å»|æ´—æ‰‹é–“|åŒ–å¦å®¤|ãƒˆã‚¤ãƒ¬|toilet|rest\s*room|wc)/i;

// ---------------- Data files ----------------
const FILE_TIMELINE = "timeline-2025-09-20_v6.csv";
const FILE_PHOTOS   = "photos-2025-09-20-mapped.csv";
const FILE_COORDS   = "coords-override-2025-09-20.json";
const srcBadge = document.getElementById('srcInfo');
if (srcBadge) srcBadge.textContent = `æœ¬é è®€å–ï¼š ${FILE_TIMELINE}ã€${FILE_PHOTOS}ã€${FILE_COORDS}`;

// ---------------- Map init ----------------
const map = L.map('map',{ zoomControl:true, attributionControl:true }).setView([35.319,139.55], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

// Layer groups
const gMain = L.layerGroup().addTo(map);
const gOptional = L.layerGroup().addTo(map);
const gRest = L.layerGroup().addTo(map);

// æ”¶é›†ä¸»è¡Œç¨‹ç¯€é»ç”¨ä¾†ç•«ç·šï¼ˆåªæ”¶ä¸»è¡Œç¨‹ï¼‰
let routeNodes = [];
let routeLine = null;

// marker ç´¢å¼•ï¼ˆè®“è¡¨æ ¼/ç…§ç‰‡ç‰†äº’ç›¸å®šä½ï¼‰
const markerIndex = {}; // norm(title) -> ä»£è¡¨ marker

// UI layer toggles
const cMain = document.getElementById('layer-main');
const cOpt  = document.getElementById('layer-optional');
const cRes  = document.getElementById('layer-restroom');
if (cMain) cMain.onchange = () => {
  if (cMain.checked) { map.addLayer(gMain); if (routeLine) map.addLayer(routeLine); }
  else { map.removeLayer(gMain); if (routeLine) map.removeLayer(routeLine); }
};
if (cOpt) cOpt.onchange  = () => { cOpt.checked ? map.addLayer(gOptional) : map.removeLayer(gOptional); };
if (cRes) cRes.onchange  = () => { cRes.checked ? map.addLayer(gRest) : map.removeLayer(gRest); };

// Here / Follow
let watchId=null;
const btnHere = document.getElementById('btnHere');
const btnFollow = document.getElementById('btnFollow');
if (btnHere) btnHere.onclick = ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      const latlng=[p.coords.latitude,p.coords.longitude];
      L.marker(latlng,{title:"æˆ‘åœ¨é€™",riseOnHover:true}).addTo(map);
      map.flyTo(latlng, 14, {duration:0.8});
    });
  }
};
if (btnFollow) btnFollow.onclick = ()=>{
  if(!navigator.geolocation){ return; }
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; alert('å·²åœæ­¢è·Ÿéš¨'); return; }
  watchId = navigator.geolocation.watchPosition(p=>{
    const latlng=[p.coords.latitude,p.coords.longitude];
    L.circleMarker(latlng,{radius:6,color:'#77b2ff',fill:true,fillOpacity:.8}).addTo(map);
    map.panTo(latlng);
  },err=>console.warn(err),{enableHighAccuracy:true,maximumAge:10000,timeout:20000});
  alert('é–‹å§‹è·Ÿéš¨');
};

// ç…§ç‰‡ & Lightbox
let photoMap = {}; // key(norm title) => [urls]
let currentPhotos = []; let currentIndex = 0;
function setPhotosForKey(key){
  const wrap = document.getElementById('photos'); 
  const empty = document.getElementById('emptyPhotos');
  if (!wrap || !empty) return;
  wrap.innerHTML='';
  const arr = photoMap[norm(key)] || [];
  currentPhotos = arr;
  if(arr.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  arr.forEach((u,i)=>{ 
    const img = new Image(); img.loading="lazy"; img.decoding="async"; img.src=u; img.onclick=()=>openLightbox(i); 
    wrap.appendChild(img); 
  });
}
function openLightbox(index){
  currentIndex = index;
  const lb = document.getElementById('lightbox');
  const img = document.getElementById('lightbox-img');
  img.src = currentPhotos[currentIndex];
  lb.style.display = 'flex';
}
function closeLightbox(){ document.getElementById('lightbox').style.display = 'none'; }
function showPrev(){ if(currentPhotos.length===0) return; currentIndex = (currentIndex-1+currentPhotos.length)%currentPhotos.length; document.getElementById('lightbox-img').src = currentPhotos[currentIndex]; }
function showNext(){ if(currentPhotos.length===0) return; currentIndex = (currentIndex+1)%currentPhotos.length; document.getElementById('lightbox-img').src = currentPhotos[currentIndex]; }
document.getElementById('close').onclick = closeLightbox;
document.getElementById('prev').onclick = showPrev;
document.getElementById('next').onclick = showNext;
document.getElementById('lightbox').onclick = e=>{ if(e.target.id==='lightbox') closeLightbox(); };

// èšç„¦åˆ°åœ°åœ– + ç…§ç‰‡
function focusTo(title){
  const mk = markerIndex[norm(title)];
  if(mk){
    const ll = mk.getLatLng();
    mk.openPopup();
    map.flyTo(ll, Math.max(map.getZoom(), 14), {duration:0.6});
  }
  setPhotosForKey(title);
}

// æ–‡å­—è¤‡è£½ï¼ˆé›™ä¿éšªï¼‰
function copyText(text){
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(()=> alert('å·²è¤‡è£½ï¼š\n' + text)).catch(()=>{
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('å·²è¤‡è£½ï¼š\n' + text);
    });
  } else {
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    alert('å·²è¤‡è£½ï¼š\n' + text);
  }
}

// ---------------- Load data ----------------
Promise.all([
  fetch(FILE_TIMELINE).then(r=>r.text()),
  fetch(FILE_PHOTOS).then(r=>r.ok?r.text():""),
  fetch(FILE_COORDS).then(r=>r.ok?r.json():{})
]).then(([csvTimeline,csvPhotos,coordOverride])=>{
  // coords override ç´¢å¼•ï¼ˆåç¨±å®¹éŒ¯ + åˆ¥åï¼‰
  const coordIndex = {};
  if (coordOverride && typeof coordOverride === 'object') {
    Object.keys(coordOverride).forEach(k => { coordIndex[norm(k)] = coordOverride[k]; });
    // åˆ¥åï¼šé›¨å‚™(è¥¿å‹å¤§èˆ¹åº—) -> è¥¿å‹ å¤§èˆ¹åº—
    if (coordOverride['è¥¿å‹ å¤§èˆ¹åº—']) {
      coordIndex[norm('é›¨å‚™(è¥¿å‹å¤§èˆ¹åº—)')] = coordOverride['è¥¿å‹ å¤§èˆ¹åº—'];
    }
  }

  // è®€ç…§ç‰‡ CSVï¼ˆæ”¯æ´ image/å°æ‡‰åœ°é» èˆ‡ url/placeï¼‰
  if(csvPhotos){
    const rows = parseCSV(csvPhotos);
    rows.forEach(r=>{
      Object.keys(r).forEach(k=>{ const ck = k.replace(/^\ufeff/,''); if(ck!==k){ r[ck]=r[k]; delete r[k]; }});
      const kRaw = byKeys(r, ['key','Key','åç¨±','åœ°é»','place','title','å°æ‡‰åœ°é»']);
      const url  = byKeys(r, ['url','URL','link','image']);
      if(!kRaw || !url) return;
      const key = norm(kRaw);
      (photoMap[key] = photoMap[key] || []).push(url);
    });
  }

  // è®€è¡Œç¨‹ CSV
  const rows = parseCSV(csvTimeline);
  const tb = document.getElementById('timelineBody');
  if (tb) tb.innerHTML = '';

  rows.forEach(r=>{
    const start = get(r,'start');
    const end   = get(r,'end');
    const title = get(r,'title');
    const note  = get(r,'note');
    const cat   = get(r,'category');
    const code  = get(r,'mapcode');
    const link  = get(r,'link') || '#';
    const seqStr = get(r,'seq');
    const seq = seqStr ? parseFloat(seqStr) : NaN;

    // åˆ¤æ–·åœ–å±¤ï¼ˆå¯åŒæ™‚å¤šå€‹ï¼‰
    const textForFlag = `${cat||''} ${note||''}`;
    const isOptional = OPTIONAL_RE.test(textForFlag);
    const isRest = RESTROOM_RE.test(textForFlag) || !!get(r,'restroomCol');

    // æ™‚é–“è»¸åˆ—ï¼ˆå¯é»é€²åœ°åœ–/ç…§ç‰‡ï¼›å«è¤‡è£½ï¼‰
    if (tb){
      const tr = el('tr','tr'); tr.style.cursor='pointer'; tr.onclick = ()=> focusTo(title);
      const td1 = el('td','td'); td1.style.width='110px'; td1.innerHTML = '<div class="time">'+toTimeBlock(start,end)+'</div>';
      const td2 = el('td','td');
      td2.innerHTML = `<div class="place">${title||''}</div><div class="badge">ğŸ“ <a href="${link}" target="_blank">Google åœ°åœ–</a></div>` + (note? `<div class="note">å‚™è¨»ï¼š${note}</div>`:'');
      const td3 = el('td','td'); td3.innerHTML = `<div class="cat">${(cat||'').replace(/\s/g,'')}</div>`;
      const td4 = el('td','td');
      const copyLabel = `${title||''}ï¼š${code||''}`;
      td4.innerHTML = `<div class="mapcode"><span class="car">ğŸš—</span><span class="code">${code||''}</span><button class="copy" type="button" onclick="event.stopPropagation(); copyText('${copyLabel.replace(/'/g,"\\'")}')">è¤‡è£½</button></div>`;
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tb.appendChild(tr);
    }

    // å–å¾—åº§æ¨™ï¼šcoords-override > CSV lat/lng > Google é€£çµ
    let latlng = null;
    if (title && coordIndex[norm(title)]) { latlng = coordIndex[norm(title)]; }
    else {
      const lat = get(r,'lat'); const lng = get(r,'lng');
      if (lat && lng) latlng = [parseFloat(lat), parseFloat(lng)];
      if (!latlng) {
        const byLink = extractLatLngFromLink(link);
        if (byLink) latlng = byLink;
      }
    }
    if (!latlng) return; // æ²’åº§æ¨™å°±ä¸ç•«

    // ç”¢ç”Ÿ popup å…§å®¹ï¼ˆå«è¤‡è£½éˆ•ï¼‰
    const popupCopy = `${title||''}ï¼š${code||''}`.replace(/'/g,"\\'");
    const popHtml = `
      <div class="popup-title">${title||''}</div>
      ${code? `<div class="mapcode"><span class="car">ğŸš—</span><span class="code">${code}</span><button class="copy" type="button" onclick="copyText('${popupCopy}')">è¤‡è£½</button></div>`:''}
      ${note? `<div class="popup-note">${note}</div>`:''}
      <div class="popup-link"><a href="${link}" target="_blank">ğŸ“ Google åœ°åœ–</a></div>
    `;

    // å»º marker çš„å°å·¥å» ï¼ˆè®“åŒä¸€é»å¯ä»¥å‡ºç¾åœ¨å¤šå€‹åœ–å±¤ï¼‰
    const makeMarker = ()=>{
      const m = L.marker(latlng, { title }).on('click', ()=> setPhotosForKey(title));
      m.bindPopup(popHtml,{ closeButton:true, autoPan:true, autoPanPaddingTopLeft:[16,16], autoPanPaddingBottomRight:[16,16] });
      return m;
    };

    // ä¸»è¡Œç¨‹(é è¨­)
    let assignedToAny = false;
    if (!isOptional && !isRest) {
      const m = makeMarker(); gMain.addLayer(m); assignedToAny = true; routeNodes.push({ seq, latlng });
      if (!markerIndex[norm(title)]) markerIndex[norm(title)] = m;
    }
    // å¯æœ‰å¯ç„¡
    if (isOptional) {
      const m = makeMarker(); gOptional.addLayer(m); assignedToAny = true;
      if (!markerIndex[norm(title)]) markerIndex[norm(title)] = m;
    }
    // å»æ‰€
    if (isRest) {
      const m = makeMarker(); gRest.addLayer(m); assignedToAny = true;
      if (!markerIndex[norm(title)]) markerIndex[norm(title)] = m;
    }
    // è‹¥ä¸‰è€…éƒ½ä¸æ˜¯ï¼ˆçœŸçš„ç´”ä¸»è¡Œç¨‹ï¼‰ï¼Œä¸Šé¢ç¬¬ä¸€æ®µå·²åŠ åˆ°ä¸»è¡Œç¨‹
    if (!assignedToAny) {
      // å·²åŠ åˆ°ä¸»è¡Œç¨‹
    }
  });

  // ç•«ä¸»è¡Œç¨‹é€£ç·šï¼ˆåªé€£ä¸»è¡Œç¨‹ï¼‰
  routeNodes.sort((a,b)=>{
    const A = isNaN(a.seq) ? Number.POSITIVE_INFINITY : a.seq;
    const B = isNaN(b.seq) ? Number.POSITIVE_INFINITY : b.seq;
    return A - B;
  });
  const routePoints = routeNodes.map(n => n.latlng);
  if (routePoints.length > 1) {
    routeLine = L.polyline(routePoints, { color:'#5ea0ff', weight:3, opacity:0.85 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [20,20] });
    if (cMain && !cMain.checked) { map.removeLayer(routeLine); }
  }
}).catch(err=>{
  console.error(err);
  const tb = document.getElementById('timelineBody');
  if (tb) tb.innerHTML = '<tr><td colspan="4" class="td">è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª CSV / JSON æª”æ¡ˆæ˜¯å¦èˆ‡ index åŒå±¤ã€‚</td></tr>';
});
</script>
</body>
</html>
